<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setor.in - Aplikasi Setoran Hafalan (Optimized)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* General Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right top, #d1d5db, #e5e7eb, #f3f4f6, #f9fafb, #ffffff);
            background-attachment: fixed;
            color: #1f2937;
        }

        /* Utility Classes */
        .page-content.hidden, .skeleton-container.hidden { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* Glassmorphism Styles */
        .glass-card, .glass-modal-content {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border-color: rgba(255, 255, 255, 0.4) !important;
        }
        .glass-input {
            background-color: rgba(255, 255, 255, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
        }
        .glass-input:focus {
            background-color: rgba(255, 255, 255, 0.6) !important;
        }
        .glass-input::placeholder { color: #6b7280; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes highlight { from { background-color: rgba(254, 243, 199, 0.5); } to { background-color: transparent; } }
        .highlight-new-row { animation: highlight 2s ease-out forwards; }
        
        @keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
        .skeleton {
            background-color: #e0e0e0;
            background-image: linear-gradient(to right, #e0e0e0 0%, #f5f5f5 20%, #e0e0e0 40%, #e0e0e0 100%);
            background-repeat: no-repeat;
            background-size: 800px 100%;
            animation: shimmer 1.5s linear infinite;
        }
        .skeleton-container {
            min-height: 100vh; /* Fix for scrolling bug */
        }

        /* UI Transitions */
        #toast { transition: transform 0.5s ease, opacity 0.5s ease; opacity: 0; transform: translate(-50%, 100px); }
        #toast.show { opacity: 1; transform: translate(-50%, 0); }
        
        .modal { transition: opacity 0.3s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal.hidden .modal-content { opacity: 0; transform: translateY(-20px); }

        /* Active State Styles */
        .tab-btn, .nav-link, .card-hover, .rekap-tab-btn, .time-filter-btn { transition: all 0.3s ease; }
        .tab-btn.active { border-bottom: 3px solid #f59e0b; color: #b45309; }
        .rekap-tab-btn { border-bottom: 2px solid transparent; }
        .rekap-tab-btn.active { border-bottom-color: #f59e0b; color: #b45309; font-weight: 600; }
        .nav-link.active, .nav-link.active svg { color: #f59e0b; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07); }

        /* Carousel Styles */
        .carousel-container { scroll-snap-type: x mandatory; scroll-padding: 1rem; }
        .carousel-item { scroll-snap-align: start; }

        /* Accordion Styles */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
        }
        .accordion-content.open {
            max-height: 1000px; /* Large enough to fit content */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-button.open .accordion-icon {
            transform: rotate(45deg);
        }
    </style>
</head>
<body class="text-gray-900">

    <div class="sm:flex min-h-screen">
        <!-- =================================================================
        NAVIGATION MENU
        ================================================================== -->
        <nav class="fixed bottom-0 left-0 w-full border-t border-gray-200 sm:relative sm:w-64 sm:flex-shrink-0 sm:border-r sm:border-t-0 z-30 glass-nav">
            <div class="flex sm:flex-col sm:py-4 sm:px-3 h-full">
                <!-- App Logo -->
                <div class="hidden sm:flex items-center gap-3 p-3 mb-4">
                    <div class="bg-amber-500 p-2 rounded-lg text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                    </div>
                    <span class="font-bold text-lg text-gray-900">Setor.in</span>
                </div>
                <!-- Nav Links -->
                <div id="main-nav" class="flex sm:flex-col w-full">
                    <a href="#" data-page="page-beranda" class="nav-link active flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                        <span class="text-xs sm:text-sm">Beranda</span>
                    </a>
                    <a href="#" data-page="page-form" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        <span class="text-xs sm:text-sm">Formulir</span>
                    </a>
                    <a href="#" data-page="page-riwayat" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                        <span class="text-xs sm:text-sm">Riwayat</span>
                    </a>
                    <a href="#" data-page="page-rekap" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <span class="text-xs sm:text-sm">Rekap</span>
                    </a>
                </div>
            </div>
        </nav>

        <!-- =================================================================
        MAIN CONTENT AREA
        ================================================================== -->
        <main id="main-content" class="flex-1 pb-20 sm:pb-0">
            
            <!-- SKELETON: Beranda -->
            <div id="skeleton-page-beranda" class="skeleton-container p-4 sm:p-6 lg:p-8 space-y-6">
                <div class="h-32 w-full skeleton rounded-2xl"></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="h-24 skeleton rounded-2xl"></div>
                    <div class="h-24 skeleton rounded-2xl"></div>
                    <div class="h-24 skeleton rounded-2xl"></div>
                </div>
                <div class="h-48 skeleton rounded-2xl"></div>
                <div class="h-64 skeleton rounded-2xl"></div>
            </div>

            <!-- PAGE: Beranda -->
            <div id="page-beranda" class="page-content p-4 sm:p-6 lg:p-8">
                <div class="max-w-7xl mx-auto space-y-8">
                    <!-- Header Section -->
                    <header class="text-center pt-12 sm:pt-0 pb-8 fade-in">
                        <div class="mx-auto mb-4 w-16 h-16 rounded-2xl bg-amber-500 text-white flex items-center justify-center text-3xl shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                        </div>
                        <h2 class="text-xl font-medium text-gray-600 mb-2">Assalamu 'alaikum ustadz,</h2>
                        <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight text-gray-900">Selamat Datang di Setor.in</h1>
                        <p class="mt-4 text-base sm:text-lg text-gray-700 max-w-2xl mx-auto">Mencatat setiap langkah, merayakan setiap pencapaian. Mari mudahkan pencatatan setoran hafalan.</p>
                        <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                            <button data-target-page="page-form" class="quick-access-btn group inline-flex items-center justify-center gap-2 bg-gradient-to-br from-amber-500 to-orange-500 text-white font-bold py-3 px-8 rounded-lg hover:from-amber-600 hover:to-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300 group-hover:rotate-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                                Input Setoran Baru
                            </button>
                             <div id="datetime-container" class="flex items-center gap-2 bg-white/40 p-2 rounded-lg shadow-inner w-full sm:w-auto">
                                <!-- Content generated by JS -->
                            </div>
                        </div>
                    </header>

                    <!-- Stats Cards -->
                    <section class="fade-in" style="animation-delay: 100ms;">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Statistik Umum</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
                            <div class="p-5 rounded-xl flex items-center gap-4 glass-card bg-gradient-to-br from-blue-50 to-blue-100/50 border-blue-200">
                                <div class="bg-blue-500 text-white p-3 rounded-lg shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                                <div>
                                    <p class="text-sm text-blue-800 font-semibold">Total Setoran</p>
                                    <p id="stats-total-setoran" class="text-2xl font-bold text-blue-900">0</p>
                                </div>
                            </div>
                            <div class="p-5 rounded-xl flex items-center gap-4 glass-card bg-gradient-to-br from-green-50 to-green-100/50 border-green-200">
                                <div class="bg-green-500 text-white p-3 rounded-lg shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div>
                                <div>
                                    <p class="text-sm text-green-800 font-semibold">Santri Aktif</p>
                                    <div id="stats-santri-aktif" class="text-2xl font-bold text-green-900 flex items-baseline gap-1">0</div>
                                </div>
                            </div>
                            <div class="p-5 rounded-xl flex items-center gap-4 glass-card bg-gradient-to-br from-amber-50 to-amber-100/50 border-amber-200">
                                <div class="bg-amber-500 text-white p-3 rounded-lg shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" /></svg></div>
                                <div>
                                    <p class="text-sm text-amber-800 font-semibold">Total Halaman (Skor)</p>
                                    <p id="stats-total-halaman" class="text-2xl font-bold text-amber-900">0</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Target Ketuntasan Section -->
                    <section id="target-ketuntasan-section" class="fade-in" style="animation-delay: 200ms;">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Target Ketuntasan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Target 1: Ketuntasan Umum -->
                            <div class="p-5 rounded-xl bg-gradient-to-br from-sky-500 to-indigo-600 text-white shadow-lg flex flex-col justify-between">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <div class="bg-white/20 p-2 rounded-lg">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg>
                                        </div>
                                        <h4 class="text-lg font-bold">A. Ketuntasan Umum</h4>
                                    </div>
                                    <p class="text-sm opacity-90 mt-2">Mutqin Setengah Juz 30 (An-Naba' s.d. Ath-Thariq) untuk mendapatkan nilai 100.</p>
                                </div>
                                <div class="text-xs font-semibold mt-4 opacity-80">Berlaku untuk: Program Unggulan & Tahfizh</div>
                            </div>
                            <!-- Target 2: Program Tahfizh -->
                            <div class="p-5 rounded-xl bg-gradient-to-br from-purple-500 to-fuchsia-600 text-white shadow-lg flex flex-col justify-between">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <div class="bg-white/20 p-2 rounded-lg">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path d="M12 14l9-5-9-5-9 5 9 5z" />
                                                <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
                                            </svg>
                                        </div>
                                        <h4 class="text-lg font-bold">B. Ketuntasan Tahfizh</h4>
                                    </div>
                                    <p class="text-sm opacity-90 mt-2">Wajib menyelesaikan Mutqin Juz 30 & Juz 29 secara penuh.</p>
                                </div>
                                <div class="text-xs font-semibold mt-4 opacity-80">Berlaku untuk: Program Tahfizh</div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- [REDESIGNED] Mutqin Progress -->
                    <section class="fade-in" style="animation-delay: 300ms;">
                         <h3 class="text-xl font-bold text-gray-900 mb-4">Progres Ketuntasan</h3>
                         <div class="glass-card rounded-2xl p-6 space-y-6">
                            <div id="mutqin-progress-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 divide-y md:divide-y-0 md:divide-x divide-white/30">
                                <!-- Donut charts generated by JS -->
                            </div>
                            <div id="overall-progress-container" class="space-y-4 pt-6 border-t border-white/30">
                                <!-- Linear progress bars generated by JS -->
                            </div>
                         </div>
                    </section>

                    <!-- Recent Activity -->
                    <section class="p-5 rounded-xl glass-card fade-in" style="animation-delay: 400ms;">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Aktivitas Terbaru</h3>
                        <div id="recent-activity-list" class="space-y-4"></div>
                        <div id="icon-legend-beranda" class="mt-4"></div>
                    </section>

                    <!-- Weekly Chart -->
                    <section id="weekly-chart-container" class="hidden fade-in" style="animation-delay: 500ms;">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Grafik Setoran Mingguan</h3>
                        <div class="p-5 rounded-xl glass-card h-64">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </section>

                    <!-- [REDESIGNED] Tuntas Tracking Section -->
                    <section id="tuntas-tracking-section" class="fade-in" style="animation-delay: 600ms;">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Lacak Ketuntasan per Kelas</h3>
                        <div id="tuntas-tracking-container" class="space-y-3">
                            <!-- Accordion Content will be generated by JS -->
                        </div>
                    </section>
                    
                    <footer class="text-center py-8 mt-8">
                        <div class="bg-gray-800 text-white p-6 rounded-2xl shadow-lg">
                            <div class="flex justify-center items-center gap-3 mb-3">
                                 <div class="bg-amber-500 p-2 rounded-lg text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                </div>
                                <span class="font-bold text-lg">Setor.in</span>
                            </div>
                            <p class="text-sm text-gray-300">Dibuat untuk Asrama 1 Abu Bakar Ash-Shiddiq.</p>
                            <p class="text-xs text-gray-400 mt-2">&copy; 2025 - Semua Hak Cipta Dilindungi.</p>
                        </div>
                    </footer>
                </div>
            </div>

            <!-- SKELETON: Form -->
            <div id="skeleton-page-form" class="skeleton-container p-4 sm:p-6 lg:p-8 space-y-6">
                <div class="h-12 w-3/4 skeleton rounded-lg"></div>
                <div class="p-6 space-y-4 skeleton rounded-2xl">
                    <div class="h-8 w-1/2 skeleton rounded-lg"></div>
                    <div class="h-10 w-full skeleton rounded-lg"></div>
                    <div class="h-10 w-full skeleton rounded-lg"></div>
                </div>
                 <div class="p-6 space-y-4 skeleton rounded-2xl">
                    <div class="h-8 w-1/2 skeleton rounded-lg"></div>
                    <div class="h-10 w-full skeleton rounded-lg"></div>
                    <div class="h-10 w-full skeleton rounded-lg"></div>
                </div>
            </div>
            
            <!-- PAGE: Form -->
            <div id="page-form" class="page-content hidden p-4 sm:p-6 lg:p-8">
                 <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8 fade-in">
                     <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> Formulir Setoran Baru</h2>
                     <p class="text-gray-700 mt-2 sm:pl-11">Catat kemajuan hafalan santri dengan mudah dan cepat.</p>
                 </div>
                
                 <form id="setoranForm" class="max-w-2xl mx-auto flex flex-col gap-6">
                    <!-- Basic Information Card -->
                    <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 50ms;">
                        <fieldset>
                            <legend class="flex items-center gap-3 text-lg font-semibold text-blue-800 mb-4 border-b border-white/30 pb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Informasi Dasar
                            </legend>
                            <div>
                                <label for="tanggal" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg><span>Tanggal & Waktu</span></label>
                                <input type="datetime-local" id="tanggal" name="tanggal" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required>
                                <div class="text-right mt-2"><button type="button" id="nowBtn" class="text-xs text-amber-700 hover:underline">Gunakan waktu sekarang</button></div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Santri Details Card -->
                    <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 150ms;">
                        <fieldset>
                            <legend class="flex items-center gap-3 text-lg font-semibold text-green-800 mb-4 border-b border-white/30 pb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                Detail Santri
                            </legend>
                            <div class="flex flex-col gap-5">
                                <div>
                                    <label for="musyrif" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg><span>Musyrif</span></label>
                                    <select id="musyrif" name="musyrif" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required><option value="">Pilih Musyrif</option></select>
                                </div>
                                <div>
                                    <label for="namaSantri" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg><span>Nama Santri</span></label>
                                    <select id="namaSantri" name="namaSantri" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Musyrif dahulu</option></select>
                                    <input type="hidden" id="santriId" name="santriId">
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                    <div>
                                        <label for="kelas" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg><span>Kelas</span></label>
                                        <input type="text" id="kelas" name="kelas" class="w-full mt-1 p-3 rounded-lg disabled:bg-gray-200/50 glass-input" readonly disabled>
                                    </div>
                                    <div>
                                        <label for="program" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm2 1v2h6V5H7zm0 4v2h6V9H7zm0 4v2h6v-2H7z" /></svg><span>Program</span></label>
                                        <input type="text" id="program" name="program" class="w-full mt-1 p-3 rounded-lg disabled:bg-gray-200/50 glass-input" readonly disabled>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Setoran Details Card -->
                    <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 250ms;">
                        <fieldset>
                            <legend class="flex items-center gap-3 text-lg font-semibold text-amber-800 mb-4 border-b border-white/30 pb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                Detail Setoran
                            </legend>
                            <div class="flex flex-col gap-5">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                    <div>
                                        <label for="jenis" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg><span>Jenis Setoran</span></label>
                                        <select id="jenis" name="jenis" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Santri dahulu</option></select>
                                    </div>
                                    <div>
                                        <label for="juz" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" /></svg><span>Juz</span></label>
                                        <select id="juz" name="juz" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Jenis dahulu</option></select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                    <div id="halaman-container" class="hidden">
                                        <label for="halaman" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg><span>Halaman</span></label>
                                        <input type="number" id="halaman" name="halaman" min="1" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled>
                                    </div>
                                    <div id="surat-container" class="hidden">
                                        <label for="surat" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804V4.804A7.968 7.968 0 0014.5 4z" /></svg><span>Surat</span></label>
                                        <select id="surat" name="surat" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required></select>
                                    </div>
                                    <div>
                                        <label for="kualitas" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg><span>Kualitas</span></label>
                                        <select id="kualitas" name="kualitas" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required>
                                            <option value="Mumtaz">Mumtaz</option><option value="Jayyid Jiddan">Jayyid Jiddan</option><option value="Jayyid">Jayyid</option><option value="Maqbul">Maqbul</option><option value="Dhoif">Dhoif</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Submit Button -->
                    <div class="mt-2">
                        <button type="submit" class="w-full group inline-flex items-center justify-center gap-2 bg-gradient-to-br from-amber-500 to-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:from-amber-600 hover:to-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300 group-hover:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                            Simpan Setoran
                        </button>
                    </div>
                 </form>
            </div>

            <!-- SKELETON: Riwayat -->
            <div id="skeleton-page-riwayat" class="skeleton-container p-4 sm:p-6 lg:p-8 space-y-6">
                <div class="h-12 w-3/4 skeleton rounded-lg"></div>
                <div class="h-24 skeleton rounded-2xl"></div>
                <div class="space-y-2">
                    <div class="h-12 w-full skeleton rounded-lg"></div>
                    <div class="h-12 w-full skeleton rounded-lg"></div>
                    <div class="h-12 w-full skeleton rounded-lg"></div>
                    <div class="h-12 w-full skeleton rounded-lg"></div>
                    <div class="h-12 w-full skeleton rounded-lg"></div>
                </div>
            </div>

            <!-- PAGE: Riwayat -->
            <div id="page-riwayat" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg> Riwayat Setoran</h2><p class="text-gray-700 mt-2 sm:pl-11">Cari dan filter 50 riwayat setoran terakhir yang tercatat.</p></div>
                    
                    <!-- Filter Section -->
                    <div class="p-4 rounded-xl mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end glass-card">
                        <div class="lg:col-span-2">
                            <label for="search-riwayat" class="text-sm font-medium text-gray-800">Cari Nama Santri</label>
                            <div class="relative">
                                <input type="search" id="search-riwayat" placeholder="Ketik nama..." class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input" autocomplete="off">
                                <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg hidden"></div>
                            </div>
                        </div>
                        <div>
                             <label for="filter-program" class="text-sm font-medium text-gray-800">Program</label>
                             <select id="filter-program" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                                 <option value="Semua">Semua Program</option>
                                 <option value="Tahfizh">Tahfizh</option>
                                 <option value="Unggulan">Unggulan</option>
                             </select>
                        </div>
                        <div>
                            <label for="filter-tanggal-mulai" class="text-sm font-medium text-gray-800">Dari Tanggal</label>
                            <input type="date" id="filter-tanggal-mulai" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                        </div>
                        <div>
                            <label for="filter-tanggal-akhir" class="text-sm font-medium text-gray-800">Sampai Tanggal</label>
                            <input type="date" id="filter-tanggal-akhir" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                        </div>
                    </div>

                    <div id="icon-legend-riwayat" class="mb-6"></div>

                    <!-- History Table -->
                    <div id="content-riwayat" class="rounded-2xl overflow-hidden glass-card overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="glass-nav border-b border-white/30 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Santri</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Detail Setoran</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Kualitas</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider hidden sm:table-cell">Tanggal</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="setoranTableBody" class="divide-y divide-gray-200/60"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- SKELETON: Rekap -->
            <div id="skeleton-page-rekap" class="skeleton-container p-4 sm:p-6 lg:p-8 space-y-6">
                <div class="h-12 w-3/4 skeleton rounded-lg"></div>
                <div class="h-12 w-full skeleton rounded-lg"></div>
                <div class="h-96 skeleton rounded-2xl"></div>
            </div>

            <!-- PAGE: Rekap -->
            <div id="page-rekap" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> Rekapitulasi Setoran</h2><p class="text-gray-700 mt-2 sm:pl-11">Pantau perkembangan setiap kelas dan ekspor laporannya.</p></div>
                    <div id="icon-legend-rekap" class="mb-6"></div>
                    <div id="content-rekap" class="rounded-2xl p-5 glass-card">
                        <div class="flex justify-center border-b border-gray-200/50">
                            <div id="rekap-tabs" class="carousel-container flex space-x-1 overflow-x-auto hide-scrollbar">
                                <!-- Rekap tabs will be generated here -->
                            </div>
                        </div>
                        <div id="rekap-content-container" class="mt-6">
                            <!-- Rekap content will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- =================================================================
    MODALS & NOTIFICATIONS
    ================================================================== -->
    <!-- Password Confirmation Modal -->
    <div id="passwordConfirmModal" class="modal fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0" aria-hidden="true"></div>
        <div class="modal-content w-full max-w-sm relative z-50 p-6 rounded-2xl glass-modal-content">
            <h3 class="text-lg font-bold text-gray-900">Masukkan Kata Sandi</h3>
            <p class="text-sm text-gray-800 my-4">Untuk menghapus data, silakan masukkan kata sandi.</p>
            <input type="password" id="passwordInput" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input" placeholder="Kata Sandi">
            <div id="passwordError" class="text-red-500 text-xs mt-2 hidden">Kata sandi salah.</div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancelPasswordBtn" class="px-6 py-2 rounded-lg bg-gray-200/50 text-gray-800 font-semibold hover:bg-gray-200/80">Batal</button>
                <button id="confirmPasswordBtn" class="px-6 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700">Konfirmasi</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 sm:bottom-8 left-1/2 z-50 flex items-center gap-3 bg-gray-900/80 text-white text-sm font-semibold py-3 px-5 rounded-lg border border-gray-700/50 backdrop-blur-sm">
        <svg id="toast-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg>
        <span id="toast-message"></span>
    </div>

    <!-- =================================================================
    HTML TEMPLATES
    ================================================================== -->
    <!-- Template for History Table Row -->
    <template id="history-row-template">
        <tr class="hover:bg-gray-100/50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="font-medium text-gray-900 data-nama"></div>
                    <span class="data-program-icon"></span>
                    <span class="data-kelas-icon"></span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                <div><span class="data-jenis"></span> <span class="data-juz-text"></span></div>
                <div class="text-xs text-gray-500 data-unit"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 data-kualitas"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell data-tanggal"></td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
                <button class="delete-btn text-gray-500 hover:text-red-500 p-1 rounded-full transition-colors" aria-label="Hapus setoran">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </td>
        </tr>
    </template>
    
    <!-- Template for Recent Activity Item -->
    <template id="recent-activity-template">
         <div class="flex items-start justify-between gap-3">
            <div class="flex items-start gap-3">
                <div class="data-emoji bg-gray-200/80 p-2 text-xl rounded-full mt-1"></div>
                <div>
                    <p class="text-sm font-semibold text-gray-800 flex items-center">
                        <span class="data-nama"></span>
                        <span class="data-program-icon"></span>
                        <span class="data-kelas-icon"></span>
                    </p>
                    <p class="text-xs text-gray-500 data-detail"></p>
                </div>
            </div>
            <p class="text-xs text-gray-400 font-medium whitespace-nowrap data-timestamp"></p>
        </div>
    </template>

    <!-- Template for Rekap Tab and Content -->
    <template id="rekap-tab-template">
        <button class="rekap-tab-btn flex-shrink-0 snap-center whitespace-nowrap py-2 px-5 text-sm font-medium text-gray-700 rounded-t-lg"></button>
    </template>
    <template id="rekap-content-template">
        <div class="rekap-tab-content hidden">
            <div class="bg-white/20 p-4 rounded-t-xl border-b border-white/30 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div>
                    <h3 class="font-bold text-amber-700 text-lg data-title"></h3>
                    <p class="text-sm text-gray-600 data-musyrif"></p>
                    <p class="text-xs text-gray-500 data-timestamp"></p>
                </div>
                <button class="export-pdf-btn mt-3 sm:mt-0 bg-green-600 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Ekspor ke PDF</button>
            </div>
            <div class="overflow-x-auto bg-white/10 p-2 rounded-b-xl">
                <table class="min-w-full divide-y divide-gray-200/80">
                    <thead class="bg-gray-100/80">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ziyadah (hlm)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200/80 data-table-body"></tbody>
                </table>
            </div>
        </div>
    </template>

<script>
    /**
     * @file Manages the Setor.in application.
     * @author Refactored by Gemini
     * @version 2.7 - Final UI Polish & Interactivity
     * @description This script is organized into modular objects for better maintainability and clarity.
     * Includes major UI redesigns for progress tracking, class tracking, and header.
     * Fixes bugs related to skeleton loading and initial tab content visibility.
     */

    // -------------------------------------------------------------------
    // MODULE: CONFIGURATION & STATIC DATA
    // -------------------------------------------------------------------
    const Config = {
        scriptURL: 'https://script.google.com/macros/s/AKfycbyl2FCcGUtolkJIDsoiTYFKeKp8IQwHT0V3z8n1pOHH9CLiyvYZTBaimrojILJM_A-HLg/exec',
        deletePassword: 'sparman68',
        musyrifSortOrder: ['Andi Aqillah Fadia Haswat', 'Abdullah', 'Muhammad Zhafir Setiaji'],
        deadlineJuz30Score: new Date('2026-01-03T23:59:59'),
        deadlineTahfizhTuntas: new Date('2025-09-30T23:59:59'),
        santriEmojis: ['👨🏻‍🎓', '👨🏻‍🏫', '👨🏻‍⚖️', '👨🏻‍🌾', '👨🏻‍🍳', '👨🏻‍🔧', '👨🏻‍🏭', '👨🏻‍💼', '👨🏻‍🔬', '👨🏻‍💻', '👨🏻‍🎨', '👨�‍✈️', '👨🏻‍🚀', '👮🏻‍♂️', '🕵🏻‍♂️', '👷🏻‍♂️', '🤵🏻‍♂️'],
        classIconColors: {
            'A': 'bg-red-100 text-red-800',
            'B': 'bg-yellow-100 text-yellow-800',
            'C': 'bg-green-100 text-green-800',
            'D': 'bg-green-100 text-green-800',
            'G': 'bg-blue-100 text-blue-800',
            'H': 'bg-blue-100 text-blue-800',
            'default': 'bg-gray-200 text-gray-800'
        },
        santriList: [
            // Data santri lengkap di sini...
            { id: 'santri1', nama: 'Adelio Daffa Syahrizha', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri2', nama: 'Ahmad Ahsanur Rizqi', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri3', nama: 'Arkana El Sabilly', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri4', nama: "Athaya Auza'I Mubarak", kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri5', nama: 'Dama Arza Evannova', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri6', nama: 'Danar Nizam Daniswara', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri7', nama: 'Devgan Jadid Sahlvatico', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri8', nama: 'Fariq Imtiyas Aufaa Kamil', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri9', nama: 'Firaas Izzulhaq', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri10', nama: 'Gilang Omar F', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri11', nama: 'Jaladri Arif Wirasena', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri12', nama: 'Kemal Mubarak Siregar', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri13', nama: 'Khairil Nizam', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri14', nama: 'Mirza Nasyath Ahza Attaillah', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri15', nama: 'Muhammad Farros Linggar Cahyono', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri16', nama: 'Muhammad Fathir Alfalah', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri17', nama: 'Narendra Wibawa', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri18', nama: 'Naufal Zhafran Purnama', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri19', nama: 'Alano Faaiq Alfeno', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri20', nama: 'Arfandhika Fakhrul Islam', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri21', nama: 'Aydin Rafif', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri22', nama: 'Danish Alzahid Dinasti', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri23', nama: 'Ghani Arif Witjaksono', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri24', nama: 'Haidarrafid Satriaa Ardhani', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri25', nama: 'Iqbal Zulfikar Al Hanif', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri26', nama: 'Jangky Dausat', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri27', nama: 'Kumara Banyu Argani', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri28', nama: 'M. Dede Afkar', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri29', nama: 'Mekha Ilham Lutfianto', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri30', nama: 'Muhammad Aiman Naim', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri31', nama: 'Muhammad Karel Ashiddiq', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri32', nama: 'Naufal Fahmi Darsono', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri33', nama: 'Nazhif Fahreza Zuhairy', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri34', nama: 'Rais Abqari Ash Shidqi', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri35', nama: 'William Ramadhan Al Ghazali', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri36', nama: 'Zia El Ibrahim Aqeela Putra Wijaya', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' },
            { id: 'santri37', nama: "Ahmad Arkan Sya'Bani", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri38', nama: 'Ahmad Darwis', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri39', nama: 'Ahmad Ghozi El Muntazhor', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri40', nama: "Aldan 'Izzul Islam", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri41', nama: 'Fawwaz Elfareza Zuhri', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri42', nama: 'M. Fathan Alfarisi Harahap', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri43', nama: 'Muhammad Ahsani Taqwim', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri44', nama: 'Muhammad Ayyub Al Fatih', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri45', nama: 'Muhammad Gibran Rafassya', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri46', nama: 'Narendra Gerrardi Kusumah', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri47', nama: "Rijal Abdul A'Ziz", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri48', nama: 'Rizki Chandra Dewantara', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' },
            { id: 'santri49', nama: 'Ahmad Miqdad', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri50', nama: 'Dzaky Salman Al Farisi', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri51', nama: 'Muhammad Alvi Mumtaz Brillian Hafizh', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri52', nama: 'Muhammad Mahdi Hafidz', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri53', nama: 'Muhammad Naufal Rasyid Arafi', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri54', nama: 'Nahsif Ilman Hazim Purwono', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri55', nama: 'Nawwaf Bahy Rafif', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri56', nama: 'Nizar Adhyatma Aryanda', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri57', nama: 'Rafa Agitananda Az Zayyan', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri58', nama: "Rafa Faeyza Fa'Iz", kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri59', nama: 'Rizqi Satria Putra Surya', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri60', nama: 'Umar Ubaidillah Tsaqif', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri61', nama: 'Wildan Faiz Mahendra', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' },
            { id: 'santri62', nama: 'Faiq Fauzil Adhim', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri63', nama: 'Fairuz Azzam Mahfuzh', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri64', nama: 'Muhammad Arkhan Attaqi', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri65', nama: 'Muhammad Daffa Naufal Alaika', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri66', nama: 'Muzakki Fairuzzaman', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri67', nama: 'Neymar Tsaqif Hikmatyar', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri68', nama: 'Rifqi Maliki', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri69', nama: "Yasykur Slamer'Abqariy", kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri70', nama: 'Zhafran Dhiaurrahman Hakim', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri71', nama: 'Achmad Adi Darwis Elfaza', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri72', nama: 'Galang Afkar Artyanto', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri73', nama: 'Gilang Asytar Artyanto', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri74', nama: 'Muhammad Alif Al-Fatih', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri75', nama: 'Muhammad Faiz Ibnu Zakaria', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri76', nama: 'Muhammad Mahdi Hanafi', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri77', nama: 'Muhammad Muhdi Hafidz', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri78', nama: 'Rizqi Ahmad Altaf Zafar', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri79', nama: 'Dzaky Anthony Akbar', kelas: '2G', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri80', nama: 'Muwafaqi Amru Ahmad', kelas: '2G', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri81', nama: 'Abdul Ghani Irfan Rafif', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri82', nama: 'Abid Fadhil Abiyah', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri83', nama: "Ahmad Dahlan Asy'Ari", kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri84', nama: 'Athallah Azmi Ghaisan Muhammad', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri85', nama: 'Azmi Zulfadli Syafiq', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri86', nama: 'Azri Labibul Khawarizmi', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri87', nama: 'Dzar Al Ghifari', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri88', nama: 'Fatihan Al Ghifari', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri89', nama: 'Hisyam Nabil Pasha', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri90', nama: 'Ibadillah Kaiazmi Mubarak', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri91', nama: 'Kashvi Jabbar Azana', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri92', nama: 'Khawarizmi Fakhrulhaq', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri93', nama: 'Muh. Naufal Alif', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri94', nama: 'Muhammad Aghna Ilman Rafa', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri95', nama: 'Royyan Abdurrahman Ibtisam', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            { id: 'santri96', nama: 'Sakhi Arkan Elfariza', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
        ],
        surahData: {
            juz30FirstHalfSurahs: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infitar', 'Al-Mutaffifin', 'Al-Inshiqaq', 'Al-Buruj', 'At-Tariq'],
            surahPageValues: { 'Al-Mulk': 2, 'Al-Qalam': 2, 'Al-Haqqah': 2, 'Al-Ma\'arij': 1.5, 'Nuh': 1.5, 'Al-Jinn': 1.5, 'Al-Muzzammil': 1.5, 'Al-Muddaththir': 1.5, 'Al-Qiyamah': 1, 'Al-Insan': 1.5, 'Al-Mursalat': 1.5, 'Al-Mujadilah': 2, 'Al-Hashr': 2.5, 'Al-Mumtahanah': 1.5, 'As-Saff': 1, 'Al-Jumu\'ah': 1, 'Al-Munafiqun': 1, 'At-Taghabun': 1.5, 'At-Talaq': 1.5, 'At-Tahrim': 1.5, 'An-Naba': 1.5, 'An-Nazi\'at': 1, 'Abasa': 1, 'At-Takwir': 0.5, 'Al-Infitar': 0.5, 'Al-Mutaffifin': 1, 'Al-Inshiqaq': 0.5, 'Al-Buruj': 0.5, 'At-Tariq': 0.5, 'Al-A\'la': 0.5, 'Al-Ghashiyah': 0.5, 'Al-Fajr': 1, 'Al-Balad': 0.5, 'Ash-Shams': 0.5, 'Al-Lail': 0.5, 'Ad-Duha': 0.25, 'Ash-Sharh': 0.25, 'At-Tin': 0.25, 'Al-\'Alaq': 0.5, 'Al-Qadr': 0.25, 'Al-Bayyinah': 0.5, 'Az-Zalzalah': 0.25, 'Al-\'Adiyat': 0.5, 'Al-Qari\'ah': 0.25, 'At-Takathur': 0.25, 'Al-\'Asr': 0.25, 'Al-Humazah': 0.25, 'Al-Fil': 0.25, 'Quraysh': 0.25, 'Al-Ma\'un': 0.25, 'Al-Kawthar': 0.25, 'Al-Kafirun': 0.25, 'An-Nasr': 0.25, 'Al-Masad': 0.25, 'Al-Ikhlas': 0.25, 'Al-Falaq': 0.25, 'An-Nas': 0.25 },
            28: { list: ['Al-Mujadilah', 'Al-Hashr', 'Al-Mumtahanah', 'As-Saff', 'Al-Jumu\'ah', 'Al-Munafiqun', 'At-Taghabun', 'At-Talaq', 'At-Tahrim'] },
            29: { list: ['Al-Mulk', 'Al-Qalam', 'Al-Haqqah', 'Al-Ma\'arij', 'Nuh', 'Al-Jinn', 'Al-Muzzammil', 'Al-Muddaththir', 'Al-Qiyamah', 'Al-Insan', 'Al-Mursalat'] },
            30: { list: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infitar', 'Al-Mutaffifin', 'Al-Inshiqaq', 'Al-Buruj', 'At-Tariq', 'Al-A\'la', 'Al-Ghashiyah', 'Al-Fajr', 'Al-Balad', 'Ash-Shams', 'Al-Lail', 'Ad-Duha', 'Ash-Sharh', 'At-Tin', 'Al-\'Alaq', 'Al-Qadr', 'Al-Bayyinah', 'Az-Zalzalah', 'Al-\'Adiyat', 'Al-Qari\'ah', 'At-Takathur', 'Al-\'Asr', 'Al-Humazah', 'Al-Fil', 'Quraysh', 'Al-Ma\'un', 'Al-Kawthar', 'Al-Kafirun', 'An-Nasr', 'Al-Masad', 'Al-Ikhlas', 'Al-Falaq', 'An-Nas'] }
        }
    };

    // -------------------------------------------------------------------
    // MODULE: APPLICATION STATE
    // -------------------------------------------------------------------
    const State = {
        allSetoran: [],
        santriData: [], // This will be processed data from Config.santriList
        classGroups: {},
        setoranIdToDelete: null,
        weeklyChart: null,
        searchDebounceTimer: null,
    };

    // -------------------------------------------------------------------
    // MODULE: DOM ELEMENT CACHE
    // -------------------------------------------------------------------
    const Cache = {};

    /** Caches all necessary DOM elements for faster access. */
    function cacheElements() {
        const ids = [
            'main-nav', 'main-content', 'setoranForm', 'tanggal', 'nowBtn', 'musyrif', 'namaSantri', 'santriId', 
            'kelas', 'program', 'jenis', 'juz', 'halaman-container', 'halaman', 'surat-container', 'surat', 
            'kualitas', 'setoranTableBody', 'history-row-template', 'search-riwayat', 'suggestions-container', 
            'filter-tanggal-mulai', 'filter-tanggal-akhir', 'filter-program', 'stats-total-setoran', 
            'stats-santri-aktif', 'stats-total-halaman', 'recent-activity-list', 'weeklyChart', 
            'weekly-chart-container', 'rekap-tabs', 
            'rekap-content-container', 'toast', 'toast-message', 'toast-icon', 'passwordConfirmModal', 
            'passwordInput', 'passwordError', 'cancelPasswordBtn', 'confirmPasswordBtn', 
            'icon-legend-beranda', 'icon-legend-riwayat', 'datetime-container', 'icon-legend-rekap',
            'recent-activity-template', 'rekap-tab-template', 'rekap-content-template',
            'mutqin-progress-container', 'overall-progress-container',
            'tuntas-tracking-container'
        ];
        ids.forEach(id => {
            const key = id.replace(/-(\w)/g, (_, p1) => p1.toUpperCase());
            Cache[key] = document.getElementById(id);
        });
        Cache.pages = document.querySelectorAll('.page-content');
        Cache.skeletonContainers = document.querySelectorAll('.skeleton-container');
    }
    
    // -------------------------------------------------------------------
    // MODULE: API (Data Fetching)
    // -------------------------------------------------------------------
    const API = {
        /** Fetches all setoran data from the Google Apps Script backend. */
        async fetchSetoranData() {
            try {
                const response = await fetch(Config.scriptURL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Failed to load setoran data:', error);
                UI.showToast('Gagal memuat riwayat setoran.', 'error');
                return []; // Return empty array on failure
            }
        },

        /** Posts form data to the backend. */
        async postData(formData) {
            try {
                const response = await fetch(Config.scriptURL, { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Failed to post data:', error);
                UI.showToast(`Gagal: ${error.message}`, 'error');
                return { result: 'error', error: error.message };
            }
        }
    };

    // -------------------------------------------------------------------
    // MODULE: UTILITIES
    // -------------------------------------------------------------------
    const Utils = {
        /** Sets the date-time input to the current local time. */
        setCurrentDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            Cache.tanggal.value = now.toISOString().slice(0, 16);
        },

        /** Populates a select element with options. */
        populateSelect(selectEl, options, placeholder) {
            selectEl.innerHTML = '';
            if (placeholder) selectEl.add(new Option(placeholder, ''));
            options.forEach(opt => {
                const option = (typeof opt === 'string') ? new Option(opt, opt) : new Option(opt.text, opt.value);
                selectEl.add(option);
            });
        },

        /** Normalizes a name string for reliable comparison. */
        normalizeName(name) {
            if (typeof name !== 'string') return '';
            return name.trim().toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ');
        },

        /** Generates SVG for quality rating stars. */
        getKualitasSVG(kualitas) {
            const qualityMap = { 'Mumtaz': 5, 'Jayyid Jiddan': 4, 'Jayyid': 3, 'Maqbul': 2, 'Dhoif': 1 };
            const stars = qualityMap[kualitas] || 0;
            const starIcon = `<svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
            const emptyStarIcon = `<svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
            return `<div class="flex">${starIcon.repeat(stars)}${emptyStarIcon.repeat(5 - stars)}</div>`;
        },

        /** Generates HTML for a program icon. */
        getProgramIcon(program) {
            const title = program === 'Unggulan' ? 'Unggulan' : 'Tahfizh';
            const initial = program === 'Unggulan' ? 'U' : 'T';
            const colors = program === 'Unggulan' ? 'bg-gray-200 text-gray-800' : 'bg-purple-200 text-purple-800';
            return `<span title="${title}" class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full ${colors} text-xs font-bold">${initial}</span>`;
        },
        
        /** Generates HTML for a class icon with color coding. */
        getClassIcon(className) {
            if (!className) return '';
            const classInitial = className.charAt(1);
            const colorClass = Config.classIconColors[classInitial] || Config.classIconColors.default;
            return `<span title="Kelas ${className}" class="ml-1 inline-flex items-center justify-center h-5 w-5 rounded-full ${colorClass} text-xs font-bold">${className}</span>`;
        },

        /** Calculates the page value (score) for a single setoran. */
        calculatePageValue(setoran) {
            if (setoran.jenis === 'Mutqin' && String(setoran.juz) === "juz30_setengah") return 0;
            if (setoran.jenis === 'Mutqin' && (!setoran.halaman || parseInt(setoran.halaman, 10) >= 20)) return 20;
            if (setoran.halaman) return parseFloat(setoran.halaman) || 0;
            if (setoran.surat) return Config.surahData.surahPageValues[setoran.surat] || 0;
            return 0;
        },

        /** Exports a recap table to PDF. */
        exportRecapToPDF(classGroup) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                const group = State.classGroups[classGroup];
                if (!group) return UI.showToast('Grup kelas tidak ditemukan.', 'error');

                doc.autoTable({
                    head: [['No.', 'Nama Santri', 'Nilai', 'Ziyadah (hlm)', 'Keterangan']],
                    body: group.santri.sort((a, b) => a.nama.localeCompare(b.nama)).map((santri, index) => [ 
                        index + 1, 
                        santri.nama, 
                        santri.nilai.toFixed(1),
                        santri.program === 'Tahfizh' ? santri.ziyadahPages.toFixed(1) : '-',
                        santri.isTuntas ? 'Tuntas' : 'Belum Tuntas'
                    ]),
                    theme: 'grid',
                    headStyles: { fillColor: [217, 119, 6] },
                    styles: { font: 'Inter', cellPadding: 6, valign: 'middle' },
                    columnStyles: {
                        0: { cellWidth: 30 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 40, halign: 'center' },
                        3: { cellWidth: 70, halign: 'center' }, 4: { cellWidth: 80, halign: 'center' }
                    },
                    didParseCell: (data) => { if (data.column.index === 1) data.cell.styles.fontSize = 8; },
                    didDrawPage: (data) => {
                        doc.setFontSize(20); doc.setTextColor(180, 83, 9); doc.setFont('helvetica', 'bold');
                        doc.text('Laporan Capaian Tahfizh', data.settings.margin.left, 40);
                        doc.setFontSize(12); doc.setTextColor(40); doc.setFont('helvetica', 'normal');
                        doc.text(`Kelas: ${classGroup} | Musyrif: ${group.musyrif}`, data.settings.margin.left, 58);
                        const pageCount = doc.internal.getNumberOfPages();
                        doc.setFontSize(8); doc.setTextColor(150);
                        doc.text(`Halaman ${data.pageNumber} dari ${pageCount}`, data.settings.margin.left, doc.internal.pageSize.height - 20);
                        doc.text(`Dibuat pada: ${new Date().toLocaleString('id-ID')}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 20, { align: 'right' });
                    },
                    margin: { top: 70, bottom: 40 }
                });
                doc.save(`rekap_setoran_${classGroup.replace(/, /g, '_')}_${Date.now()}.pdf`);
            } catch (error) {
                console.error("PDF Export Error:", error);
                UI.showToast('Gagal mengekspor PDF.', 'error');
            }
        },
        
        /** Formats a date string into a relative time string. */
        formatTimeAgo(dateString) {
            if (!dateString) return '';
            const now = new Date();
            const past = new Date(dateString);
            const seconds = Math.floor((now - past) / 1000);

            if (seconds < 60) return "beberapa saat lalu";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} menit yg lalu`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} jam yg lalu`;
            const days = Math.floor(hours / 24);
            if (days === 1) return "Kemarin";
            if (days < 7) return `${days} hari yg lalu`;
            const weeks = Math.floor(days / 7);
            return `${weeks} pekan yg lalu`;
        }
    };

    // -------------------------------------------------------------------
    // MODULE: UI (Rendering and DOM Manipulation)
    // -------------------------------------------------------------------
    const UI = {
        /** Renders all major UI components based on the current state. */
        renderAll() {
            this.beranda.render();
            this.history.renderTable();
            this.rekap.renderAll();
            this.renderIconLegends();
        },

        // --- Sub-module for Beranda Page ---
        beranda: {
            render() {
                const totalHalaman = State.allSetoran.reduce((sum, s) => sum + Utils.calculatePageValue(s), 0);
                const santriAktifIds = new Set(State.allSetoran.map(s => s.namaSantri));

                Cache.statsTotalSetoran.textContent = State.allSetoran.length;
                Cache.statsSantriAktif.textContent = santriAktifIds.size;
                Cache.statsTotalHalaman.textContent = totalHalaman.toFixed(1);
                
                this.renderRecentActivity();
                this.renderWeeklySummaryChart();
                this.renderMutqinProgress();
                this.renderTuntasTracking();
            },
            renderRecentActivity() {
                const recentActivities = State.allSetoran.slice(0, 5);
                const container = Cache.recentActivityList;
                const template = Cache.recentActivityTemplate;
                container.innerHTML = '';

                if (recentActivities.length === 0) {
                    container.innerHTML = `<p class="text-sm text-gray-500">Belum ada aktivitas.</p>`;
                    return;
                }
                
                const fragment = document.createDocumentFragment();
                recentActivities.forEach(setoran => {
                    const santri = State.santriData.find(s => s.id === setoran.santriId);
                    const clone = template.content.cloneNode(true);
                    
                    clone.querySelector('.data-nama').textContent = setoran.namaSantri;
                    clone.querySelector('.data-emoji').textContent = Config.santriEmojis[setoran.namaSantri.charCodeAt(0) % Config.santriEmojis.length];
                    clone.querySelector('.data-detail').textContent = `Menyetor ${setoran.jenis} ${setoran.halaman ? `${setoran.halaman} halaman` : setoran.surat}`;
                    clone.querySelector('.data-timestamp').textContent = Utils.formatTimeAgo(setoran.createdAt);
                    if (santri) {
                        clone.querySelector('.data-program-icon').innerHTML = Utils.getProgramIcon(santri.program);
                        clone.querySelector('.data-kelas-icon').innerHTML = Utils.getClassIcon(santri.kelas);
                    }
                    fragment.appendChild(clone);
                });
                container.appendChild(fragment);
            },
            renderWeeklySummaryChart() {
                if (State.allSetoran.length === 0) {
                    Cache.weeklyChartContainer.classList.add('hidden');
                    return;
                }
                Cache.weeklyChartContainer.classList.remove('hidden');

                const labels = [];
                const data = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    labels.push(d.toLocaleDateString('id-ID', { weekday: 'short' }));
                    const setoranOnDay = State.allSetoran.filter(s => new Date(s.createdAt).toDateString() === d.toDateString());
                    data.push(setoranOnDay.length);
                }

                if (State.weeklyChart) State.weeklyChart.destroy();
                
                State.weeklyChart = new Chart(Cache.weeklyChart, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Setoran', data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.4)', borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1, borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1, color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            },
            renderMutqinProgress() {
                const container = Cache.mutqinProgressContainer;
                const overallContainer = Cache.overallProgressContainer;
                container.innerHTML = '';
                overallContainer.innerHTML = '';

                const tahfizhSantri = State.santriData.filter(s => s.program === 'Tahfizh');
                const unggulanSantri = State.santriData.filter(s => s.program === 'Unggulan');

                // Donut Chart Progress
                const progressData = [
                    {
                        title: 'P. Unggulan (Nilai 100)',
                        santriList: unggulanSantri,
                        completed: unggulanSantri.filter(s => s.isTuntas).length,
                        color: 'text-sky-500', trackColor: 'stroke-sky-200', barColor: 'stroke-sky-500'
                    },
                    {
                        title: 'P. Tahfizh (Mutqin Juz 30)',
                        santriList: tahfizhSantri,
                        completed: tahfizhSantri.filter(s => s.mutqinJuz.has(30)).length,
                        color: 'text-green-500', trackColor: 'stroke-green-200', barColor: 'stroke-green-500'
                    },
                    {
                        title: 'P. Tahfizh (Mutqin Juz 29)',
                        santriList: tahfizhSantri,
                        completed: tahfizhSantri.filter(s => s.mutqinJuz.has(29)).length,
                        color: 'text-amber-500', trackColor: 'stroke-amber-200', barColor: 'stroke-amber-500'
                    }
                ];

                progressData.forEach(data => {
                    if (data.santriList.length > 0) {
                        const total = data.santriList.length;
                        const percentage = total > 0 ? (data.completed / total) * 100 : 0;
                        const circumference = 2 * Math.PI * 45;
                        const offset = circumference - (percentage / 100) * circumference;

                        const item = document.createElement('div');
                        item.className = 'flex flex-col items-center justify-center text-center p-4';
                        item.innerHTML = `
                            <div class="relative w-28 h-28">
                                <svg class="w-full h-full" viewBox="0 0 100 100">
                                    <circle class="${data.trackColor}" stroke-width="10" cx="50" cy="50" r="45" fill="transparent" />
                                    <circle class="${data.barColor}" stroke-width="10" cx="50" cy="50" r="45" fill="transparent"
                                        stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                                        transform="rotate(-90 50 50)" style="transition: stroke-dashoffset 0.5s ease-out;" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center text-2xl font-bold ${data.color}">${Math.round(percentage)}%</div>
                            </div>
                            <h4 class="font-bold text-gray-800 mt-3 text-sm">${data.title}</h4>
                            <p class="text-xs text-gray-600">${data.completed} dari ${total} santri</p>`;
                        container.appendChild(item);
                    }
                });

                // Linear Progress Bars
                const tahfizhTuntasJuz2930 = tahfizhSantri.filter(s => s.mutqinJuz.has(29) && s.mutqinJuz.has(30)).length;
                const totalTahfizh = tahfizhSantri.length;
                const pctTahfizh = totalTahfizh > 0 ? (tahfizhTuntasJuz2930 / totalTahfizh) * 100 : 0;

                const asramaTuntas = State.santriData.filter(s => s.isTuntas).length;
                const totalAsrama = State.santriData.length;
                const pctAsrama = totalAsrama > 0 ? (asramaTuntas / totalAsrama) * 100 : 0;
                
                const linearProgressHTML = `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="text-sm font-semibold text-gray-800">Progres Mutqin Juz 29 & 30 (Tahfizh)</h4>
                            <span class="text-sm font-bold text-purple-600">${Math.round(pctTahfizh)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-purple-500 h-2.5 rounded-full" style="width: ${pctTahfizh}%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="text-sm font-semibold text-gray-800">Progres Ketuntasan 1 Asrama</h4>
                            <span class="text-sm font-bold text-red-600">${Math.round(pctAsrama)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-red-500 h-2.5 rounded-full" style="width: ${pctAsrama}%"></div></div>
                    </div>
                `;
                overallContainer.innerHTML = linearProgressHTML;
            },
            renderTuntasTracking() {
                const container = Cache.tuntasTrackingContainer;
                container.innerHTML = '';
                const fragment = document.createDocumentFragment();

                for (const groupName in State.classGroups) {
                    const group = State.classGroups[groupName];
                    const tuntasCount = group.santri.filter(s => s.isTuntas).length;
                    const totalCount = group.santri.length;
                    const percentage = totalCount > 0 ? (tuntasCount / totalCount) * 100 : 0;

                    const accordion = document.createElement('div');
                    accordion.className = 'glass-card rounded-xl transition-shadow hover:shadow-lg';
                    accordion.innerHTML = `
                        <button class="accordion-button w-full p-4 text-left flex justify-between items-center" data-target="accordion-${groupName.replace(/, /g, '')}">
                            <div>
                                <h4 class="font-bold text-gray-800">Kelas ${groupName}</h4>
                                <p class="text-xs text-gray-600">${tuntasCount} dari ${totalCount} santri tuntas</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="w-24 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
                                <span class="text-sm font-bold text-green-600">${Math.round(percentage)}%</span>
                                <div class="accordion-icon text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                                </div>
                            </div>
                        </button>
                        <div id="accordion-${groupName.replace(/, /g, '')}" class="accordion-content px-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs border-t border-white/30">
                                <div>
                                    <h5 class="font-semibold text-green-700 my-2">✅ Sudah Tuntas (${tuntasCount})</h5>
                                    <ul class="space-y-1 list-disc list-inside text-gray-700">${group.santri.filter(s => s.isTuntas).map(s => `<li>${s.nama}</li>`).join('') || '<li class="list-none text-gray-500">Belum ada</li>'}</ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-red-700 my-2">❌ Belum Tuntas (${totalCount - tuntasCount})</h5>
                                    <ul class="space-y-1 list-disc list-inside text-gray-700">${group.santri.filter(s => !s.isTuntas).map(s => `<li>${s.nama}</li>`).join('') || '<li class="list-none text-gray-500">Semua tuntas</li>'}</ul>
                                </div>
                            </div>
                        </div>`;
                    fragment.appendChild(accordion);
                }
                container.appendChild(fragment);
            }
        },

        // --- Sub-module for Riwayat Page ---
        history: {
            getFilteredData() {
                const searchTerm = Cache.searchRiwayat.value.toLowerCase();
                const programFilter = Cache.filterProgram.value;
                const startDate = Cache.filterTanggalMulai.value ? new Date(Cache.filterTanggalMulai.value) : null;
                const endDate = Cache.filterTanggalAkhir.value ? new Date(Cache.filterTanggalAkhir.value) : null;
                if(startDate) startDate.setHours(0,0,0,0);
                if(endDate) endDate.setHours(23,59,59,999);

                return State.allSetoran.filter(s => {
                    const setoranDate = new Date(s.createdAt);
                    const santri = State.santriData.find(st => st.id === s.santriId);
                    return s.namaSantri.toLowerCase().includes(searchTerm) &&
                           (programFilter === 'Semua' || (santri && santri.program === programFilter)) &&
                           (!startDate || setoranDate >= startDate) &&
                           (!endDate || setoranDate <= endDate);
                });
            },
            renderTable() {
                const filteredSetoran = this.getFilteredData();
                const itemsToRender = filteredSetoran.slice(0, 50); // Limit to 50 items
                const tableBody = Cache.setoranTableBody;
                const template = Cache.historyRowTemplate;
                tableBody.innerHTML = '';

                if (itemsToRender.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">Tidak ada data yang cocok.</td></tr>`;
                    return;
                }
                
                const fragment = document.createDocumentFragment();
                itemsToRender.forEach(setoran => {
                    const santri = State.santriData.find(s => s.id === setoran.santriId);
                    const clone = template.content.cloneNode(true);
                    
                    const juzText = String(setoran.juz) === "juz30_setengah" ? "Setengah Juz 30" : `Juz ${setoran.juz}`;

                    clone.querySelector('.data-nama').textContent = setoran.namaSantri;
                    clone.querySelector('.data-jenis').textContent = setoran.jenis;
                    clone.querySelector('.data-juz-text').textContent = juzText;
                    clone.querySelector('.data-unit').textContent = setoran.halaman ? `${setoran.halaman} halaman` : setoran.surat;
                    clone.querySelector('.data-kualitas').innerHTML = Utils.getKualitasSVG(setoran.kualitas);
                    clone.querySelector('.data-tanggal').textContent = new Date(setoran.createdAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                    clone.querySelector('.delete-btn').dataset.id = setoran.id;
                    
                    if (santri) {
                        clone.querySelector('.data-program-icon').innerHTML = Utils.getProgramIcon(santri.program);
                        clone.querySelector('.data-kelas-icon').innerHTML = Utils.getClassIcon(santri.kelas);
                    }
                    fragment.appendChild(clone);
                });
                tableBody.appendChild(fragment);
            },
            renderSearchSuggestions(query) {
                if (query.length < 2) {
                    Cache.suggestionsContainer.classList.add('hidden');
                    return;
                }
                const suggestions = State.santriData
                    .filter(s => s.nama.toLowerCase().includes(query.toLowerCase()))
                    .slice(0, 5);
                
                if (suggestions.length > 0) {
                    Cache.suggestionsContainer.innerHTML = suggestions
                        .map(s => `<div class="suggestion-item p-2 hover:bg-gray-100 cursor-pointer">${s.nama}</div>`)
                        .join('');
                    Cache.suggestionsContainer.classList.remove('hidden');
                } else {
                    Cache.suggestionsContainer.classList.add('hidden');
                }
            },
        },

        // --- Sub-module for Rekap Page ---
        rekap: {
            renderAll() {
                const sortedGroupNames = Object.keys(State.classGroups).sort((a,b) => a.localeCompare(b));
                const tabsContainer = Cache.rekapTabs;
                const contentContainer = Cache.rekapContentContainer;
                tabsContainer.innerHTML = '';
                contentContainer.innerHTML = '';

                const tabsFragment = document.createDocumentFragment();
                const contentFragment = document.createDocumentFragment();

                sortedGroupNames.forEach((groupName, index) => {
                    const tabClone = Cache.rekapTabTemplate.content.cloneNode(true);
                    const tabButton = tabClone.querySelector('button');
                    tabButton.dataset.tab = groupName.replace(/, | /g, '');
                    tabButton.textContent = `Kelas ${groupName}`;
                    if (index === 0) tabButton.classList.add('active');
                    tabsFragment.appendChild(tabClone);

                    const contentClone = Cache.rekapContentTemplate.content.cloneNode(true);
                    const group = State.classGroups[groupName];
                    const contentDiv = contentClone.querySelector('.rekap-tab-content');
                    contentDiv.id = `rekap-tab-${groupName.replace(/, | /g, '')}`;
                    
                    // FIX: Show the first tab content on initial render
                    if (index === 0) {
                        contentDiv.classList.remove('hidden');
                    }
                    
                    contentDiv.querySelector('.data-title').textContent = `Rekap Capaian - Kelas ${groupName}`;
                    contentDiv.querySelector('.data-musyrif').textContent = `Musyrif: ${group.musyrif}`;
                    contentDiv.querySelector('.data-timestamp').textContent = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                    contentDiv.querySelector('.export-pdf-btn').dataset.classGroup = groupName;
                    
                    const tableBody = contentDiv.querySelector('.data-table-body');
                    group.santri.sort((a,b) => a.nama.localeCompare(b.nama)).forEach((santri, idx) => {
                        const isTuntas = santri.isTuntas;
                        const keterangan = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isTuntas ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${isTuntas ? 'Tuntas' : 'Belum Tuntas'}</span>`;
                        const row = tableBody.insertRow();
                        row.className = 'hover:bg-gray-50/50';
                        row.innerHTML = `
                            <td class="px-4 py-2 text-gray-800">${idx + 1}</td>
                            <td class="px-4 py-2 text-sm text-gray-800"><div class="flex items-center">${santri.nama}${Utils.getProgramIcon(santri.program)}${Utils.getClassIcon(santri.kelas)}</div></td>
                            <td class="px-4 py-2 font-medium text-gray-800 text-center">${santri.nilai.toFixed(1)}</td>
                            <td class="px-4 py-2 font-medium text-gray-800 text-center">${santri.program === 'Tahfizh' ? santri.ziyadahPages.toFixed(1) : '-'}</td>
                            <td class="px-4 py-2 text-center">${keterangan}</td>
                        `;
                    });
                    contentFragment.appendChild(contentClone);
                });

                tabsContainer.appendChild(tabsFragment);
                contentContainer.appendChild(contentFragment);
            },
        },
        
        // --- Sub-module for Form ---
        form: {
            reset() {
                Cache.setoranForm.reset();
                Utils.setCurrentDateTime();
                Cache.musyrif.value = "";
                ['namaSantri', 'jenis', 'juz'].forEach(key => {
                    Utils.populateSelect(Cache[key], [], `Pilih ${key === 'namaSantri' ? 'Musyrif' : '...'} dahulu`);
                    Cache[key].disabled = true;
                });
                ['kelas', 'program', 'santriId'].forEach(key => Cache[key].value = '');
                this.resetSetoranInputs();
            },
            resetSetoranInputs() {
                Cache.halamanContainer.classList.add('hidden');
                Cache.suratContainer.classList.add('hidden');
                ['halaman', 'surat'].forEach(key => {
                    Cache[key].disabled = true;
                    Cache[key].required = false;
                    Cache[key].value = '';
                });
                Cache.halaman.min = 1;
                Cache.halaman.placeholder = '';
            },
            updateSantriOptions() {
                const selectedMusyrif = Cache.musyrif.value;
                this.resetSetoranInputs();
                ['jenis', 'juz'].forEach(key => { Cache[key].disabled = true; });
                if (selectedMusyrif) {
                    const santriOptions = State.santriData
                        .filter(s => s.musyrif === selectedMusyrif)
                        .sort((a, b) => a.nama.localeCompare(b.nama))
                        .map(s => ({ text: s.nama, value: s.id }));
                    Utils.populateSelect(Cache.namaSantri, santriOptions, 'Pilih Santri');
                    Cache.namaSantri.disabled = false;
                } else {
                    Utils.populateSelect(Cache.namaSantri, [], 'Pilih Musyrif dahulu');
                    Cache.namaSantri.disabled = true;
                }
                this.updateSantriDetails();
            },
            updateSantriDetails() {
                const santri = State.santriData.find(s => s.id === Cache.namaSantri.value);
                this.resetSetoranInputs();
                if (santri) {
                    Cache.kelas.value = santri.kelas;
                    Cache.program.value = santri.program;
                    Cache.santriId.value = santri.id;
                } else {
                    ['kelas', 'program', 'santriId'].forEach(key => Cache[key].value = '');
                }
            },
            updateJenisOptions() {
                const santri = State.santriData.find(s => s.id === Cache.namaSantri.value);
                if (santri) {
                    const jenisOptions = [];
                    if (santri.program === "Unggulan" || (santri.program === "Tahfizh" && santri.isTuntas)) {
                        jenisOptions.push("Ziyadah");
                    }
                    jenisOptions.push("Murajaah", "Mutqin");
                    Utils.populateSelect(Cache.jenis, jenisOptions, 'Pilih Jenis');
                    Cache.jenis.disabled = false;
                } else {
                    Cache.jenis.disabled = true;
                    Utils.populateSelect(Cache.jenis, [], 'Pilih Santri dahulu');
                }
                this.updateJuzOptions();
            },
            updateJuzOptions() {
                const jenis = Cache.jenis.value;
                const santri = State.santriData.find(s => s.id === Cache.namaSantri.value);
                this.resetSetoranInputs();
                if (!jenis || !santri) {
                    Cache.juz.disabled = true;
                    Utils.populateSelect(Cache.juz, [], 'Pilih Jenis dahulu');
                    return;
                }
                let juzOptions = [];
                if (jenis === "Mutqin") {
                    if (!santri.nilai || santri.nilai < 100) {
                        juzOptions.push({ text: "Setengah Juz 30 (An-Naba' - At-Tariq)", value: "juz30_setengah" });
                    }
                    for (let i = 1; i <= 30; i++) {
                        if (!santri.mutqinJuz.has(i)) juzOptions.push({ text: `Juz ${i}`, value: i });
                    }
                } else { // Ziyadah or Murajaah
                    for (let i = 1; i <= 30; i++) juzOptions.push({ text: `Juz ${i}`, value: i });
                }
                Utils.populateSelect(Cache.juz, juzOptions, 'Pilih Juz');
                Cache.juz.disabled = false;
                this.updateSetoranInputs();
            },
            updateSetoranInputs() {
                const jenis = Cache.jenis.value;
                const juz = Cache.juz.value;
                this.resetSetoranInputs();
                if (!jenis || !juz) return;

                if (juz === "juz30_setengah") return;
                
                const juzNum = parseInt(juz, 10);
                const surahList = Config.surahData[juzNum]?.list || [];
                const isSurahBased = ['Ziyadah', 'Murajaah'].includes(jenis) && [28, 29, 30].includes(juzNum) && surahList.length > 0;

                if (isSurahBased) {
                    Cache.suratContainer.classList.remove('hidden');
                    Cache.surat.required = true;
                    Cache.surat.disabled = false;
                    Utils.populateSelect(Cache.surat, surahList, 'Pilih Surat');
                } else if (jenis === 'Ziyadah' || jenis === 'Murajaah') {
                    Cache.halamanContainer.classList.remove('hidden');
                    Cache.halaman.required = true;
                    Cache.halaman.disabled = false;
                } else if (jenis === 'Mutqin') {
                    Cache.halamanContainer.classList.remove('hidden');
                    Cache.halaman.disabled = false;
                    Cache.halaman.placeholder = 'Kosongkan untuk 1 Juz penuh';
                    Cache.halaman.required = false;
                }
            },
        },

        // --- General UI Helpers ---
        renderIconLegends() {
            const legendItems = [
                { icon: Utils.getProgramIcon('Tahfizh'), text: 'Program Tahfizh' },
                { icon: Utils.getProgramIcon('Unggulan'), text: 'Program Unggulan' },
                { icon: Utils.getClassIcon('2A'), text: 'Kelas 2A' },
                { icon: Utils.getClassIcon('2B'), text: 'Kelas 2B' },
                { icon: Utils.getClassIcon('2C'), text: 'Kelas 2C/D' },
                { icon: Utils.getClassIcon('2H'), text: 'Kelas 2G/H' }
            ];
            const legendItemsHTML = legendItems.map(item => `
                <div class="flex items-center text-xs font-medium text-gray-700 bg-gray-100/80 rounded-full px-3 py-1">
                    ${item.icon}<span class="ml-2">${item.text}</span>
                </div>`).join('');
            const fullLegendHTML = `
                <div class="p-4 rounded-xl glass-card">
                    <h4 class="font-bold text-gray-800 text-sm mb-3">Keterangan Ikon</h4>
                    <div class="flex flex-wrap items-center gap-2">${legendItemsHTML}</div>
                </div>`;
            
            Cache.iconLegendBeranda.innerHTML = fullLegendHTML;
            Cache.iconLegendRiwayat.innerHTML = fullLegendHTML;
            Cache.iconLegendRekap.innerHTML = fullLegendHTML;
        },
        showToast(message, type = 'success') {
            Cache.toastMessage.textContent = message;
            const isSuccess = type === 'success';
            Cache.toastIcon.innerHTML = isSuccess 
                ? `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />`
                : `<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`;
            Cache.toastIcon.classList.toggle('text-green-400', isSuccess);
            Cache.toastIcon.classList.toggle('text-red-400', !isSuccess);
            Cache.toast.classList.add('show');
            setTimeout(() => Cache.toast.classList.remove('show'), 3000);
        },
        toggleModal(modalId, show) { 
            const modal = Cache[modalId];
            if (modal) modal.classList.toggle('hidden', !show);
        },
        switchPage(pageId, showSkeleton = true) {
            if (!pageId) return;
            
            this.hideAllContent();
            if (showSkeleton) this.showSkeleton(pageId);

            // Give skeleton a moment to render before loading content
            setTimeout(() => {
                document.getElementById(pageId)?.classList.remove('hidden');
                this.hideAllSkeletons();
                
                Cache.mainNav.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
                Cache.mainNav.querySelector(`a[data-page="${pageId}"]`)?.classList.add('active');
            }, 300); // Increased delay slightly for smoother feel
        },
        switchTab(container, contentSelector, clickedBtn, idPrefix) {
            container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            clickedBtn.classList.add('active');
            
            const targetTabId = clickedBtn.dataset.tab.replace(/, | /g, '');
            const parentContainer = container.closest('.glass-card, .page-content');
            parentContainer.querySelectorAll(contentSelector).forEach(content => content.classList.add('hidden'));
            document.getElementById(`${idPrefix}-${targetTabId}`)?.classList.remove('hidden');
        },
        updateDateTime() {
            const now = new Date();
            const time = new Intl.DateTimeFormat('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false }).format(now).replace(/\./g, ':');
            const gregorianDate = new Intl.DateTimeFormat('id-ID', { weekday: 'long', day: 'numeric', month: 'long' }).format(now);
            const hijriDate = new Intl.DateTimeFormat('id-ID-u-ca-islamic', { day: 'numeric', month: 'long', year: 'numeric' }).format(now);
            Cache.datetimeContainer.innerHTML = `
                <div class="text-2xl font-bold text-gray-800">${time}</div>
                <div class="border-l border-gray-400/50 h-8 mx-2"></div>
                <div class="text-left">
                    <div class="text-xs font-semibold text-gray-700">${gregorianDate}</div>
                    <div class="text-xs text-gray-500">${hijriDate}</div>
                </div>
            `;
        },
        showSkeleton(pageId) {
            this.hideAllSkeletons();
            document.getElementById(`skeleton-${pageId}`)?.classList.remove('hidden');
        },
        hideAllSkeletons() { Cache.skeletonContainers.forEach(s => s.classList.add('hidden')); },
        hideAllContent() { Cache.pages.forEach(p => p.classList.add('hidden')); },
    };

    // -------------------------------------------------------------------
    // MODULE: EVENT HANDLERS
    // -------------------------------------------------------------------
    const Handlers = {
        async handleFormSubmit(e) {
            e.preventDefault();
            const form = Cache.setoranForm;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Menyimpan...';

            const santriSelect = Cache.namaSantri;
            const selectedSantriName = santriSelect.options[santriSelect.selectedIndex].text;
            const formData = new FormData(form);
            formData.set('namaSantri', selectedSantriName);

            const data = await API.postData(formData);

            if (data.result === 'success') {
                UI.showToast('Setoran berhasil disimpan!', 'success');
                UI.form.reset();
                await App.reloadData();
            }

            submitButton.disabled = false;
            submitButton.innerHTML = 'Simpan Setoran';
        },

        async handleConfirmDelete() {
            if (Cache.passwordInput.value !== Config.deletePassword) {
                Cache.passwordError.classList.remove('hidden');
                return;
            }
            Cache.passwordError.classList.add('hidden');
            
            const setoranToDelete = State.allSetoran.find(s => s.id === State.setoranIdToDelete);
            if (!setoranToDelete) return;

            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('rowNumber', setoranToDelete.rowNumber);
            formData.append('password', Cache.passwordInput.value); 

            UI.toggleModal('passwordConfirmModal', false);
            const data = await API.postData(formData);

            if (data.result === 'success') {
                UI.showToast('Data berhasil dihapus.', 'success');
                await App.reloadData();
            } else {
                UI.showToast(`Gagal menghapus: ${data.error || 'Terjadi kesalahan server.'}`, 'error');
            }
        },

        handleNavClick(e) {
            const link = e.target.closest('.nav-link[data-page]');
            if (link) {
                e.preventDefault();
                UI.switchPage(link.dataset.page);
            }
        },

        handleMainContentClick(e) {
            const target = e.target.closest('.export-pdf-btn, .delete-btn, .quick-access-btn, .accordion-button');
            if (!target) return;

            if (target.matches('.export-pdf-btn')) {
                Utils.exportRecapToPDF(target.dataset.classGroup);
            } else if (target.matches('.delete-btn')) {
                State.setoranIdToDelete = target.dataset.id;
                UI.toggleModal('passwordConfirmModal', true);
            } else if (target.matches('.quick-access-btn')) {
                UI.switchPage(target.dataset.targetPage);
            } else if (target.matches('.accordion-button')) {
                const contentId = target.dataset.target;
                const content = document.getElementById(contentId);
                if (content) {
                    target.classList.toggle('open');
                    content.classList.toggle('open');
                }
            }
        },

        handleHistorySearch(e) {
            clearTimeout(State.searchDebounceTimer);
            State.searchDebounceTimer = setTimeout(() => {
                UI.history.renderTable();
                UI.history.renderSearchSuggestions(e.target.value);
            }, 300);
        },

        handleSuggestionClick(e) {
            if (e.target.matches('.suggestion-item')) {
                Cache.searchRiwayat.value = e.target.textContent;
                Cache.suggestionsContainer.classList.add('hidden');
                UI.history.renderTable();
            }
        },
        
        handleTabClick(e) {
            const button = e.target.closest('.rekap-tab-btn[data-tab]');
            if (button) {
                UI.switchTab(button.parentElement, '.rekap-tab-content', button, 'rekap-tab');
            }
        },
    };

    // -------------------------------------------------------------------
    // MODULE: APP (Main Controller)
    // -------------------------------------------------------------------
    const App = {
        /** Initializes the application. */
        async init() {
            cacheElements();
            this.setupEventListeners();
            
            UI.showSkeleton('page-beranda');
            Utils.setCurrentDateTime();
            UI.updateDateTime();
            setInterval(UI.updateDateTime, 60000);

            this.processStaticData();
            await this.reloadData();
            
            UI.switchPage('page-beranda', false);
        },

        /** Sets up all global event listeners. */
        setupEventListeners() {
            Cache.setoranForm.addEventListener('submit', Handlers.handleFormSubmit);
            Cache.nowBtn.addEventListener('click', Utils.setCurrentDateTime);
            Cache.mainNav.addEventListener('click', Handlers.handleNavClick);
            Cache.mainContent.addEventListener('click', Handlers.handleMainContentClick);
            
            // Form select changes
            Cache.musyrif.addEventListener('change', UI.form.updateSantriOptions.bind(UI.form));
            Cache.namaSantri.addEventListener('change', () => { UI.form.updateSantriDetails(); UI.form.updateJenisOptions(); });
            Cache.jenis.addEventListener('change', UI.form.updateJuzOptions.bind(UI.form));
            Cache.juz.addEventListener('change', UI.form.updateSetoranInputs.bind(UI.form));

            // Riwayat page filters
            Cache.searchRiwayat.addEventListener('input', Handlers.handleHistorySearch);
            Cache.suggestionsContainer.addEventListener('click', Handlers.handleSuggestionClick);
            [Cache.filterTanggalMulai, Cache.filterTanggalAkhir, Cache.filterProgram].forEach(el => {
                el.addEventListener('input', () => UI.history.renderTable());
            });
            
            // Rekap page tabs
            Cache.rekapTabs.addEventListener('click', Handlers.handleTabClick);

            // Modal listeners
            Cache.cancelPasswordBtn.addEventListener('click', () => UI.toggleModal('passwordConfirmModal', false));
            Cache.confirmPasswordBtn.addEventListener('click', Handlers.handleConfirmDelete);
            Cache.passwordConfirmModal.addEventListener('click', (e) => { 
                if (e.target === Cache.passwordConfirmModal) UI.toggleModal('passwordConfirmModal', false); 
            });

            // Global click listener to hide suggestions
            document.addEventListener('click', (e) => {
                if (!Cache.searchRiwayat.contains(e.target) && !Cache.suggestionsContainer.contains(e.target)) {
                    Cache.suggestionsContainer.classList.add('hidden');
                }
            });
        },

        /** Processes static data from Config into a more usable format in State. */
        processStaticData() {
            State.santriNameMap = new Map(Config.santriList.map(s => [Utils.normalizeName(s.nama), s.id]));
            State.santriData = JSON.parse(JSON.stringify(Config.santriList));

            const tempGroups = {};
            State.santriData.forEach(santri => {
                const groupKey = santri.musyrif;
                if (!tempGroups[groupKey]) {
                    tempGroups[groupKey] = { santri: [], musyrif: santri.musyrif, classes: new Set() };
                }
                tempGroups[groupKey].santri.push(santri);
                tempGroups[groupKey].classes.add(santri.kelas);
            });
            
            for (const musyrif in tempGroups) {
                const group = tempGroups[musyrif];
                const classList = [...group.classes].sort();
                // FIX: Combine class names for specific musyrif
                const groupName = (musyrif === 'Muhammad Zhafir Setiaji') ? '2CDGH' : classList.join(', ');
                State.classGroups[groupName] = { santri: group.santri, musyrif: group.musyrif };
            }

            const musyrifList = [...new Set(State.santriData.map(s => s.musyrif))];
            musyrifList.sort((a, b) => {
                const indexA = Config.musyrifSortOrder.indexOf(a);
                const indexB = Config.musyrifSortOrder.indexOf(b);
                if (indexA > -1 && indexB > -1) return indexA - indexB;
                if (indexA > -1) return -1;
                if (indexB > -1) return 1;
                return a.localeCompare(b);
            });
            Utils.populateSelect(Cache.musyrif, musyrifList, 'Pilih Musyrif');
        },

        /** Fetches new data and re-processes it. */
        async reloadData() {
            const dataFromServer = await API.fetchSetoranData();
            
            const unmatchedNames = new Set();
            State.allSetoran = dataFromServer.map(item => {
                const santriNameFromSheet = item.namaSantri || item['Nama Santri'] || '';
                const normalizedSheetName = Utils.normalizeName(santriNameFromSheet);
                const santriId = State.santriNameMap.get(normalizedSheetName);
                
                if (!santriId && santriNameFromSheet) {
                    unmatchedNames.add(santriNameFromSheet.trim());
                }
                
                return {
                    id: `row-${item.rowNumber}`,
                    santriId: santriId || null, 
                    createdAt: item.tanggal,
                    ...item
                };
            }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (unmatchedNames.size > 0) {
                console.warn("PERINGATAN: Nama santri berikut dari spreadsheet tidak dapat ditemukan:", Array.from(unmatchedNames));
            }

            this.calculateAllSantriStats();
            UI.renderAll();
        },

        /**
         * REFACTORED: Calculates all santri statistics from scratch based on the new logic.
         * This ensures data is always in sync and corrects previous calculation bugs.
         */
        calculateAllSantriStats() {
            // 1. Reset all calculated stats for every santri
            State.santriData.forEach(s => {
                s.mutqinJuz = new Set();
                s.nilai = 0;
                s.isTuntas = false;
                s.tuntasDate = null;
                s.ziyadahPages = 0;
            });

            // 2. Process all setoran records for each santri
            State.santriData.forEach(santri => {
                const santriSetoran = State.allSetoran.filter(s => s.santriId === santri.id);
                if (santriSetoran.length === 0) return;

                // --- A. Find key milestone events ---
                const mutqinSetengahJuz = santriSetoran.find(s => s.jenis === 'Mutqin' && String(s.juz) === "juz30_setengah");
                const mutqinJuz30 = santriSetoran.find(s => s.jenis === 'Mutqin' && s.juz == 30 && (!s.halaman || parseInt(s.halaman) >= 20));
                const mutqinJuz29 = santriSetoran.find(s => s.jenis === 'Mutqin' && s.juz == 29 && (!s.halaman || parseInt(s.halaman) >= 20));

                if (mutqinJuz30) santri.mutqinJuz.add(30);
                if (mutqinJuz29) santri.mutqinJuz.add(29);

                // --- B. Determine Tuntas Status and Date ---
                const scoreMilestoneAchieved = mutqinSetengahJuz || (mutqinJuz30 && new Date(mutqinJuz30.createdAt) <= Config.deadlineJuz30Score);
                
                if (santri.program === 'Unggulan') {
                    if (scoreMilestoneAchieved) {
                        santri.isTuntas = true;
                        santri.tuntasDate = new Date(scoreMilestoneAchieved.createdAt);
                    }
                } else if (santri.program === 'Tahfizh') {
                    const hasRequiredMutqin = santri.mutqinJuz.has(29) && santri.mutqinJuz.has(30);
                    const deadlineMet = mutqinJuz29 && mutqinJuz30 && new Date(mutqinJuz29.createdAt) <= Config.deadlineTahfizhTuntas && new Date(mutqinJuz30.createdAt) <= Config.deadlineTahfizhTuntas;
                    if (scoreMilestoneAchieved && hasRequiredMutqin && deadlineMet) {
                        santri.isTuntas = true;
                        santri.tuntasDate = new Date(Math.max(new Date(mutqinJuz29.createdAt), new Date(mutqinJuz30.createdAt), new Date(scoreMilestoneAchieved.createdAt)));
                    }
                }
                
                // --- C. Calculate Final Nilai and Ziyadah Pages ---
                if (santri.isTuntas) {
                    santri.nilai = 100;
                } else {
                    // If not tuntas, nilai is based on mutqin pages after deadline
                    const mutqinPagesAfterDeadline = santriSetoran
                        .filter(s => s.jenis === 'Mutqin' && new Date(s.createdAt) > Config.deadlineJuz30Score)
                        .reduce((sum, s) => sum + (parseFloat(s.halaman) || 0), 0);
                    santri.nilai = mutqinPagesAfterDeadline;
                }

                // For Tahfizh, add scores for setoran after tuntas date
                if (santri.isTuntas && santri.program === 'Tahfizh' && santri.tuntasDate) {
                    let postTuntasScore = 0;
                    santriSetoran.forEach(setoran => {
                        if (new Date(setoran.createdAt) > santri.tuntasDate) {
                            const pageValue = Utils.calculatePageValue(setoran);
                            if (setoran.jenis === 'Ziyadah') {
                                santri.ziyadahPages += pageValue;
                            }
                            postTuntasScore += pageValue;
                        }
                    });
                    santri.nilai += postTuntasScore;
                }
            });
        }
    };

    // Initialize the application when the DOM is fully loaded.
    document.addEventListener('DOMContentLoaded', () => App.init());

</script>
</body>
</html>
�
