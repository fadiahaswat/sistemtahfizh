<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setor.in - Aplikasi Setoran Hafalan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right top, #d1d5db, #e5e7eb, #f3f4f6, #f9fafb, #ffffff);
            background-attachment: fixed;
            color: #1f2937;
        }
        .page-content.hidden, .skeleton-container.hidden { display: none; }

        /* Glassmorphism Styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border-color: rgba(255, 255, 255, 0.4) !important;
        }
        .glass-input {
            background-color: rgba(255, 255, 255, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
        }
        .glass-input:focus {
             background-color: rgba(255, 255, 255, 0.6) !important;
        }
        .glass-input::placeholder {
            color: #6b7280;
        }
        .glass-modal-content {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes highlight { from { background-color: rgba(254, 243, 199, 0.5); } to { background-color: transparent; } }
        .highlight-new-row { animation: highlight 2s ease-out forwards; }

        /* UI Transitions */
        #toast { transition: transform 0.5s ease, opacity 0.5s ease; opacity: 0; transform: translate(-50%, 100px); }
        #toast.show { opacity: 1; transform: translate(-50%, 0); }
        .modal { transition: opacity 0.3s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal.hidden .modal-content { opacity: 0; transform: translateY(-20px); }

        /* Active Tab & Nav Styles */
        .tab-btn { transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .tab-btn.active { border-color: #f59e0b; color: #b45309; }
        .rekap-tab-btn, .time-filter-btn { transition: all 0.2s ease-in-out; }
        .rekap-tab-btn.active, .time-filter-btn.active { background-color: #f59e0b; color: white; box-shadow: 0 2px 8px -1px rgb(0 0 0 / 0.1); }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active, .nav-link.active svg { color: #f59e0b; }
        .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07); }

        /* Scrollbar Hiding */
        .rekap-slider-container, .table-container, .history-table-wrapper { -ms-overflow-style: none; scrollbar-width: none; }
        .rekap-slider-container::-webkit-scrollbar, .table-container::-webkit-scrollbar, .history-table-wrapper::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-gray-900">

    <div class="sm:flex min-h-screen">
        <!-- Navigation Menu -->
        <nav class="fixed bottom-0 left-0 w-full border-t border-gray-200 sm:relative sm:w-64 sm:flex-shrink-0 sm:border-r sm:border-t-0 z-30 glass-nav">
            <div class="flex sm:flex-col sm:py-4 sm:px-3 h-full">
                <div class="hidden sm:flex items-center gap-3 p-3 mb-4">
                    <div class="bg-amber-500 p-2 rounded-lg text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></div>
                    <span class="font-bold text-lg text-gray-900">Setor.in</span>
                </div>
                <div id="main-nav" class="flex sm:flex-col w-full">
                    <a href="#" data-page="page-beranda" class="nav-link active flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                        <span class="text-xs sm:text-sm">Beranda</span>
                    </a>
                    <a href="#" data-page="page-form" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span class="text-xs sm:text-sm">Formulir</span></a>
                    <a href="#" data-page="page-riwayat" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg><span class="text-xs sm:text-sm">Riwayat</span></a>
                    <a href="#" data-page="page-rekap" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="text-xs sm:text-sm">Rekap</span></a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 pb-20 sm:pb-0 overflow-y-auto">
            
            <!-- Page: Beranda -->
            <div id="page-beranda" class="page-content p-4 sm:p-6 lg:p-8">
                <!-- 1. Hero Section -->
                <header class="text-center pt-12 sm:pt-0 pb-8 fade-in">
                    <div class="mx-auto mb-6 w-16 h-16 rounded-2xl bg-amber-500 text-white flex items-center justify-center text-3xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                    </div>
                    <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight text-gray-900">Selamat Datang di Setor.in</h1>
                    <p class="mt-4 text-base sm:text-lg text-gray-700 max-w-2xl mx-auto">Mencatat setiap langkah, merayakan setiap pencapaian. Mari mudahkan pencatatan setoran hafalan.</p>
                    <div class="mt-8">
                        <button data-target-page="page-form" class="quick-access-btn bg-amber-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all duration-300 shadow-lg hover:shadow-xl">
                            Input Setoran Baru
                        </button>
                    </div>
                </header>
                
                <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <!-- Left Column -->
                    <div class="lg:col-span-1 space-y-8">
                        <!-- 2. Quick Access -->
                        <section class="fade-in" style="animation-delay: 200ms;">
                             <h3 class="text-xl font-bold text-gray-900 mb-4">Akses Cepat</h3>
                             <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                 <button data-target-page="page-form" class="quick-access-btn flex flex-col items-center justify-center p-4 rounded-xl card-hover text-amber-700 glass-card"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span class="text-sm font-semibold">Input Setoran</span></button>
                                 <button data-target-page="page-riwayat" class="quick-access-btn flex flex-col items-center justify-center p-4 rounded-xl card-hover text-blue-700 glass-card"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg><span class="text-sm font-semibold">Lihat Riwayat</span></button>
                                 <button data-target-page="page-rekap" class="quick-access-btn flex flex-col items-center justify-center p-4 rounded-xl card-hover text-green-700 glass-card"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="text-sm font-semibold">Buka Rekap</span></button>
                             </div>
                        </section>
                        <!-- 3. Leaderboard -->
                        <section class="fade-in" style="animation-delay: 400ms;">
                             <h3 class="text-xl font-bold text-gray-900 mb-4">Papan Peringkat</h3>
                             <div class="glass-card p-5 rounded-xl">
                                 <div class="border-b border-white/30"><nav id="leaderboard-tabs" class="-mb-px flex justify-center space-x-6"><button data-tab="tahfizh" class="tab-btn active whitespace-nowrap py-4 px-1 text-base font-medium text-gray-700">Tahfizh</button><button data-tab="unggulan" class="tab-btn whitespace-nowrap py-4 px-1 text-base font-medium text-gray-700">Unggulan</button></nav></div>
                                 <div id="leaderboard-content-container" class="mt-6">
                                     <div id="tab-tahfizh" class="tab-content grid grid-cols-1 md:grid-cols-3 gap-6">
                                         <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-amber-800 text-lg">📚 Halaman Terbanyak</h3><div id="stats-tahfizh-terbanyak-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terbanyak" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-amber-700 hover:underline">Lihat semua...</button></div>
                                         <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-orange-800 text-lg">🏃‍♂️ Paling Rajin</h3><div id="stats-tahfizh-terrajin-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terrajin" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-orange-700 hover:underline">Lihat semua...</button></div>
                                         <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-red-800 text-lg">⭐ Kualitas Terbaik</h3><div id="stats-tahfizh-kualitas-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="kualitas" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-red-700 hover:underline">Lihat semua...</button></div>
                                     </div>
                                     <div id="tab-unggulan" class="tab-content hidden grid grid-cols-1 md:grid-cols-3 gap-6">
                                         <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-amber-800 text-lg">📚 Halaman Terbanyak</h3><div id="stats-unggulan-terbanyak-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terbanyak" data-program="unggulan" class="see-all-btn mt-4 text-sm text-amber-700 hover:underline">Lihat semua...</button></div>
                                         <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-orange-800 text-lg">🏃‍♂️ Paling Rajin</h3><div id="stats-unggulan-terrajin-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terrajin" data-program="unggulan" class="see-all-btn mt-4 text-sm text-orange-700 hover:underline">Lihat semua...</button></div>
                                         <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-red-800 text-lg">⭐ Kualitas Terbaik</h3><div id="stats-unggulan-kualitas-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="kualitas" data-program="unggulan" class="see-all-btn mt-4 text-sm text-red-700 hover:underline">Lihat semua...</button></div>
                                     </div>
                                 </div>
                             </div>
                        </section>
                         <!-- 4. Charts Section -->
                        <section class="fade-in" style="animation-delay: 600ms;">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                 <div id="weekly-chart-container" class="hidden">
                                     <h3 class="text-xl font-bold text-gray-900 mb-4">Grafik Setoran Mingguan</h3>
                                     <div class="p-5 rounded-xl glass-card h-64">
                                         <canvas id="weeklyChart"></canvas>
                                     </div>
                                 </div>
                                 <div id="mutqin-juz30-chart-container" class="hidden">
                                     <h3 class="text-xl font-bold text-gray-900 mb-4">Progres Mutqin Juz 30</h3>
                                     <div class="p-5 rounded-xl glass-card h-64">
                                         <canvas id="mutqinJuz30Chart"></canvas>
                                     </div>
                                 </div>
                                 <div id="mutqin-juz29-chart-container" class="hidden">
                                     <h3 class="text-xl font-bold text-gray-900 mb-4">Progres Mutqin Juz 29</h3>
                                     <div class="p-5 rounded-xl glass-card h-64">
                                         <canvas id="mutqinJuz29Chart"></canvas>
                                     </div>
                                 </div>
                             </div>
                        </section>
                    </div>

                    <!-- Right Column -->
                    <div class="lg:col-span-1 space-y-8">
                        <!-- Overall Stats -->
                        <section class="fade-in" style="animation-delay: 300ms;">
                             <h3 class="text-xl font-bold text-gray-900 mb-4">Statistik Umum</h3>
                             <div class="space-y-4">
                                 <div class="p-5 rounded-xl flex items-center gap-4 glass-card">
                                     <div class="bg-blue-100 text-blue-600 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                                     <div>
                                         <p class="text-sm text-gray-800">Total Setoran</p>
                                         <p id="stats-total-setoran" class="text-2xl font-bold text-gray-900">0</p>
                                     </div>
                                 </div>
                                 <div class="p-5 rounded-xl flex items-center gap-4 glass-card">
                                     <div class="bg-green-100 text-green-600 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div>
                                     <div>
                                         <p class="text-sm text-gray-800">Santri Aktif</p>
                                         <p id="stats-santri-aktif" class="text-2xl font-bold text-gray-900">0</p>
                                     </div>
                                 </div>
                                 <div class="p-5 rounded-xl flex items-center gap-4 glass-card">
                                     <div class="bg-amber-100 text-amber-600 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" /></svg></div>
                                     <div>
                                         <p class="text-sm text-gray-800">Total Halaman</p>
                                         <p id="stats-total-halaman" class="text-2xl font-bold text-gray-900">0</p>
                                     </div>
                                 </div>
                             </div>
                        </section>
                        <!-- Recent Activity -->
                        <section class="p-5 rounded-xl glass-card fade-in" style="animation-delay: 500ms;">
                             <h3 class="text-xl font-bold text-gray-900 mb-4">Aktivitas Terbaru</h3>
                             <div id="recent-activity-list" class="space-y-3"></div>
                        </section>
                        <!-- Info Box -->
                        <section class="bg-blue-100/80 border-l-4 border-blue-500 text-blue-900 p-4 rounded-r-lg fade-in" style="animation-delay: 100ms;">
                             <h3 class="text-xl font-bold mb-2">Mari Berkembang Bersama!</h3>
                             <p class="text-sm">Aplikasi ini ibarat santri baru yang masih terus belajar. Jika Anda menemukan hal yang janggal atau punya ide cemerlang, jangan ragu untuk menyampaikannya ke tim pengasuhan asrama. Kontribusi Anda sangat berarti!</p>
                         </section>
                    </div>
                </div>

                <footer class="text-center text-sm text-gray-500 py-8 mt-8">
                    Setor.in &copy; 2025 - Dibuat untuk Asrama 1 Abu Bakar Ash-Shiddiq.
                </footer>
            </div>

            <!-- Page: Form -->
            <div id="page-form" class="page-content hidden p-4 sm:p-6 lg:p-8">
                 <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8 fade-in">
                     <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> Formulir Setoran Baru</h2>
                     <p class="text-gray-700 mt-2 sm:pl-11">Catat kemajuan hafalan santri dengan mudah dan cepat.</p>
                 </div>
                
                 <form id="setoranForm" class="max-w-2xl mx-auto flex flex-col gap-6">
                     <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 50ms;">
                         <fieldset>
                             <legend class="flex items-center gap-3 text-lg font-semibold text-blue-800 mb-4 border-b border-white/30 pb-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                 Informasi Dasar
                             </legend>
                             <div>
                                 <label for="tanggal" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg><span>Tanggal & Waktu</span></label>
                                 <input type="datetime-local" id="tanggal" name="tanggal" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required>
                                 <div class="text-right mt-2"><button type="button" id="nowBtn" class="text-xs text-amber-700 hover:underline">Gunakan waktu sekarang</button></div>
                             </div>
                         </fieldset>
                     </div>

                     <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 150ms;">
                         <fieldset>
                              <legend class="flex items-center gap-3 text-lg font-semibold text-green-800 mb-4 border-b border-white/30 pb-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                 Detail Santri
                             </legend>
                             <div class="flex flex-col gap-5">
                                 <div>
                                     <label for="musyrif" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg><span>Musyrif</span></label>
                                     <select id="musyrif" name="musyrif" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required><option value="">Pilih Musyrif</option></select>
                                 </div>
                                 <div>
                                     <label for="namaSantri" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg><span>Nama Santri</span></label>
                                     <select id="namaSantri" name="namaSantri" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Musyrif dahulu</option></select>
                                 </div>
                                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                     <div>
                                         <label for="kelas" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg><span>Kelas</span></label>
                                         <input type="text" id="kelas" name="kelas" class="w-full mt-1 p-3 rounded-lg disabled:bg-gray-200/50 glass-input" readonly disabled>
                                     </div>
                                     <div>
                                         <label for="program" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm2 1v2h6V5H7zm0 4v2h6V9H7zm0 4v2h6v-2H7z" /></svg><span>Program</span></label>
                                         <input type="text" id="program" name="program" class="w-full mt-1 p-3 rounded-lg disabled:bg-gray-200/50 glass-input" readonly disabled>
                                     </div>
                                 </div>
                             </div>
                         </fieldset>
                     </div>

                     <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 250ms;">
                         <fieldset>
                             <legend class="flex items-center gap-3 text-lg font-semibold text-amber-800 mb-4 border-b border-white/30 pb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                 Detail Setoran
                             </legend>
                             <div class="flex flex-col gap-5">
                                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                     <div>
                                         <label for="jenis" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg><span>Jenis Setoran</span></label>
                                         <select id="jenis" name="jenis" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Santri dahulu</option></select>
                                     </div>
                                     <div>
                                         <label for="juz" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" /></svg><span>Juz</span></label>
                                         <select id="juz" name="juz" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Jenis dahulu</option></select>
                                     </div>
                                 </div>
                                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                     <div id="halaman-container">
                                         <label for="halaman" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg><span>Halaman</span></label>
                                         <input type="number" id="halaman" name="halaman" min="1" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled>
                                     </div>
                                     <div id="surat-container" class="hidden">
                                         <label for="surat" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804V4.804A7.968 7.968 0 0014.5 4z" /></svg><span>Surat</span></label>
                                         <select id="surat" name="surat" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required></select>
                                     </div>
                                     <div>
                                         <label for="kualitas" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg><span>Kualitas</span></label>
                                         <select id="kualitas" name="kualitas" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required>
                                             <option value="Mumtaz">Mumtaz</option><option value="Jayyid Jiddan">Jayyid Jiddan</option><option value="Jayyid">Jayyid</option><option value="Maqbul">Maqbul</option><option value="Dhoif">Dhoif</option>
                                         </select>
                                     </div>
                                 </div>
                             </div>
                         </fieldset>
                     </div>

                     <div class="mt-2">
                         <button type="submit" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all duration-300">Simpan Setoran</button>
                     </div>
                 </form>
            </div>

            <!-- Page: Riwayat -->
            <div id="page-riwayat" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg> Riwayat Setoran</h2><p class="text-gray-700 mt-2 sm:pl-11">Cari dan filter seluruh riwayat setoran yang tercatat.</p></div>
                    
                    <!-- Filter Section -->
                    <div class="p-4 rounded-xl mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4 items-end glass-card">
                        <div class="relative">
                            <label for="search-riwayat" class="text-sm font-medium text-gray-800">Cari Nama Santri</label>
                            <input type="search" id="search-riwayat" placeholder="Ketik nama..." class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input" autocomplete="off">
                            <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg hidden"></div>
                        </div>
                        <div>
                             <label for="filter-program" class="text-sm font-medium text-gray-800">Program</label>
                             <select id="filter-program" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                                 <option value="Semua">Semua Program</option>
                                 <option value="Tahfizh">Tahfizh</option>
                                 <option value="Unggulan">Unggulan</option>
                             </select>
                        </div>
                        <div>
                            <label for="filter-tanggal-mulai" class="text-sm font-medium text-gray-800">Dari Tanggal</label>
                            <input type="date" id="filter-tanggal-mulai" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                        </div>
                        <div>
                            <label for="filter-tanggal-akhir" class="text-sm font-medium text-gray-800">Sampai Tanggal</label>
                            <input type="date" id="filter-tanggal-akhir" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                        </div>
                    </div>

                    <div id="content-riwayat" class="rounded-2xl overflow-hidden glass-card history-table-wrapper overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="glass-nav border-b border-white/30 sticky top-0 z-10"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Santri</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Detail Setoran</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Kualitas</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider hidden sm:table-cell">Tanggal</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Aksi</th></tr></thead>
                            <tbody id="setoranTableBody" class="divide-y divide-gray-200/60"><tr><td colspan="5" class="text-center p-8 text-gray-700">Memuat data...</td></tr></tbody>
                        </table>
                    </div>
                     <div id="load-more-container" class="text-center mt-6">
                         <button id="load-more-btn" class="bg-amber-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-amber-600 transition-colors hidden">Muat Lebih Banyak</button>
                     </div>
                </div>
            </div>
            
            <!-- Page: Rekap -->
            <div id="page-rekap" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> Rekapitulasi Setoran</h2><p class="text-gray-700 mt-2 sm:pl-11">Pantau perkembangan setiap kelas dan ekspor laporannya.</p></div>
                    <div id="content-rekap" class="rounded-2xl p-5 glass-card">
                        <div class="flex justify-center">
                            <div id="rekap-tabs" class="rekap-slider-container flex space-x-1 overflow-x-auto snap-x snap-mandatory rounded-lg bg-gray-200/50 p-1">
                                <!-- Tabs will be generated by JS -->
                            </div>
                        </div>
                        <div id="rekap-content-container" class="mt-6">
                            <!-- Recap content will be generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="leaderboardModal" class="modal fixed inset-0 bg-black/30 z-40 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0" aria-hidden="true"></div>
        <div class="modal-content w-full max-w-md max-h-[80vh] flex flex-col relative z-50 rounded-2xl glass-modal-content">
            <div class="p-5 border-b border-white/30 flex justify-between items-center"><h3 id="modalTitle" class="text-xl font-bold text-gray-900"></h3><button id="closeModalBtn" class="text-gray-600 hover:text-gray-900 text-2xl font-bold" aria-label="Tutup modal">&times;</button></div>
            <div id="modalBody" class="p-5 overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="confirmDeleteModal" class="modal fixed inset-0 bg-black/30 z-40 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0" aria-hidden="true"></div>
        <div class="modal-content w-full max-w-sm relative z-50 p-6 text-center rounded-2xl glass-modal-content">
            <h3 class="text-lg font-bold text-gray-900">Hapus Setoran?</h3>
            <p class="text-sm text-gray-800 my-4">Apakah Anda yakin ingin menghapus data setoran ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancelDeleteBtn" class="px-6 py-2 rounded-lg bg-gray-200/50 text-gray-800 font-semibold hover:bg-gray-200/80">Batal</button>
                <button id="confirmDeleteBtn" class="px-6 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 sm:bottom-8 left-1/2 z-50 flex items-center gap-3 bg-gray-900/80 text-white text-sm font-semibold py-3 px-5 rounded-lg border border-gray-700/50 backdrop-blur-sm">
        <svg id="toast-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg>
        <span id="toast-message"></span>
    </div>

    <!-- Template for History Table Row -->
    <template id="history-row-template">
        <tr class="hover:bg-gray-100/50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="font-medium text-gray-900 data-nama"></div>
                    <span class="data-program-icon"></span>
                    <span class="data-kelas-icon"></span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                <div><span class="data-jenis"></span> Juz <span class="data-juz"></span></div>
                <div class="text-xs text-gray-500 data-unit"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 data-kualitas"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell data-tanggal"></td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
                <button class="delete-btn text-gray-500 hover:text-red-500 p-1 rounded-full transition-colors" aria-label="Hapus setoran">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </td>
        </tr>
    </template>

<script>
    /**
     * =================================================================
     * App Object: Main container for the application's logic.
     * =================================================================
     */
    const App = {
        /**
         * -------------------------------------------------------------
         * STATE: Holds all dynamic data for the application.
         * -------------------------------------------------------------
         */
        state: {
            allSetoran: [],
            santriData: [],
            surahData: {},
            setoranIdToDelete: null,
            weeklyChart: null,
            mutqinJuz29Chart: null,
            mutqinJuz30Chart: null,
            displayedHistoryCount: 20,
            historyItemsPerPage: 20,
            searchDebounceTimer: null,
        },

        /**
         * -------------------------------------------------------------
         * CACHE: Caches frequently accessed DOM elements for performance.
         * -------------------------------------------------------------
         */
        cache: {},

        /**
         * -------------------------------------------------------------
         * DATA SOURCES: Static or processed data used throughout the app.
         * -------------------------------------------------------------
         */
        dataSources: {
            classGroups: {},
            santriEmojis: ['🧑‍🦱', '👦', '👨‍🦱', '🧑', '👨', '🧒', '👨‍🎓']
        },
        
        /**
         * -------------------------------------------------------------
         * INIT: The starting point of the application.
         * -------------------------------------------------------------
         */
        init() {
            this.cacheElements();
            this.setupEventListeners();
            this.UI.switchPage('page-beranda');
            this.UI.setCurrentDateTime();
            
            this.data.loadMockData();
            this.processSantriData();
            this.UI.renderAll();
        },

        /**
         * -------------------------------------------------------------
         * CACHE & DATA PROCESSING
         * -------------------------------------------------------------
         */
        cacheElements() {
            this.cache = {
                mainNav: document.getElementById('main-nav'),
                mainContent: document.getElementById('main-content'),
                pages: document.querySelectorAll('.page-content'),
                form: document.getElementById('setoranForm'),
                tanggalInput: document.getElementById('tanggal'),
                musyrifSelect: document.getElementById('musyrif'),
                santriSelect: document.getElementById('namaSantri'),
                kelasInput: document.getElementById('kelas'),
                programInput: document.getElementById('program'),
                jenisSelect: document.getElementById('jenis'),
                juzSelect: document.getElementById('juz'),
                halamanContainer: document.getElementById('halaman-container'),
                halamanInput: document.getElementById('halaman'),
                suratContainer: document.getElementById('surat-container'),
                suratSelect: document.getElementById('surat'),
                nowBtn: document.getElementById('nowBtn'),
                tableBody: document.getElementById('setoranTableBody'),
                historyRowTemplate: document.getElementById('history-row-template'),
                riwayatSearch: document.getElementById('search-riwayat'),
                suggestionsContainer: document.getElementById('suggestions-container'),
                riwayatTglMulai: document.getElementById('filter-tanggal-mulai'),
                riwayatTglAkhir: document.getElementById('filter-tanggal-akhir'),
                riwayatProgram: document.getElementById('filter-program'),
                loadMoreBtn: document.getElementById('load-more-btn'),
                stats: {
                    totalSetoran: document.getElementById('stats-total-setoran'),
                    santriAktif: document.getElementById('stats-santri-aktif'),
                    totalHalaman: document.getElementById('stats-total-halaman'),
                },
                recentActivityList: document.getElementById('recent-activity-list'),
                weeklyChartCanvas: document.getElementById('weeklyChart'),
                weeklyChartContainer: document.getElementById('weekly-chart-container'),
                mutqinJuz29ChartCanvas: document.getElementById('mutqinJuz29Chart'),
                mutqinJuz29ChartContainer: document.getElementById('mutqin-juz29-chart-container'),
                mutqinJuz30ChartCanvas: document.getElementById('mutqinJuz30Chart'),
                mutqinJuz30ChartContainer: document.getElementById('mutqin-juz30-chart-container'),
                leaderboardTabs: document.getElementById('leaderboard-tabs'),
                rekapTabs: document.getElementById('rekap-tabs'),
                rekapContentContainer: document.getElementById('rekap-content-container'),
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
                toastIcon: document.getElementById('toast-icon'),
                leaderboardModal: document.getElementById('leaderboardModal'),
                modalTitle: document.getElementById('modalTitle'),
                modalBody: document.getElementById('modalBody'),
                closeModalBtn: document.getElementById('closeModalBtn'),
                confirmDeleteModal: document.getElementById('confirmDeleteModal'),
                confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
                cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
            };
        },

        processSantriData() {
            const musyrifList = [...new Set(this.state.santriData.map(s => s.musyrif))];
            
            musyrifList.sort((a, b) => {
                const order = ['Andi Aqillah Fadia Haswat', 'Abdullah'];
                const indexA = order.indexOf(a);
                const indexB = order.indexOf(b);

                if (indexA > -1 && indexB > -1) return indexA - indexB;
                if (indexA > -1) return -1;
                if (indexB > -1) return 1;
                return a.localeCompare(b);
            });

            this.dataSources.classGroups = {};
            const tempGroups = {};

            this.state.santriData.forEach(santri => {
                if (!tempGroups[santri.musyrif]) {
                    tempGroups[santri.musyrif] = {
                        santri: [],
                        musyrif: santri.musyrif,
                        classes: new Set()
                    };
                }
                tempGroups[santri.musyrif].santri.push(santri);
                tempGroups[santri.musyrif].classes.add(santri.kelas);
            });

            for (const musyrif in tempGroups) {
                const group = tempGroups[musyrif];
                let groupName;
                if (musyrif === 'Muhammad Zhafir Setiaji') {
                    groupName = '2CDGH';
                } else {
                    groupName = [...group.classes].sort().join(', ');
                }
                this.dataSources.classGroups[groupName] = {
                    santri: group.santri,
                    musyrif: group.musyrif
                };
            }

            this.UI.populateSelect(this.cache.musyrifSelect, musyrifList, 'Pilih Musyrif');
        },


        /**
         * -------------------------------------------------------------
         * EVENT LISTENERS: Sets up all user interaction listeners.
         * -------------------------------------------------------------
         */
        setupEventListeners() {
            this.cache.form.addEventListener('submit', this.handlers.handleFormSubmit.bind(this));
            this.cache.nowBtn.addEventListener('click', this.UI.setCurrentDateTime.bind(this));
            this.cache.musyrifSelect.addEventListener('change', this.handlers.handleMusyrifChange.bind(this));
            this.cache.santriSelect.addEventListener('change', this.handlers.handleSantriChange.bind(this));
            this.cache.jenisSelect.addEventListener('change', this.handlers.handleJenisChange.bind(this));
            this.cache.juzSelect.addEventListener('change', this.handlers.handleJuzChange.bind(this));
            this.cache.mainNav.addEventListener('click', this.handlers.handleNavClick.bind(this));
            this.cache.leaderboardTabs.addEventListener('click', this.handlers.handleTabClick.bind(this, '.tab-content', 'tab'));
            this.cache.rekapTabs.addEventListener('click', this.handlers.handleTabClick.bind(this, '.rekap-tab-content', 'rekap-tab'));
            this.cache.riwayatSearch.addEventListener('input', this.handlers.handleHistorySearch.bind(this));
            this.cache.suggestionsContainer.addEventListener('click', this.handlers.handleSuggestionClick.bind(this));
            document.addEventListener('click', (e) => {
                if (!this.cache.riwayatSearch.contains(e.target) && !this.cache.suggestionsContainer.contains(e.target)) {
                    this.cache.suggestionsContainer.classList.add('hidden');
                }
            });
            [this.cache.riwayatTglMulai, this.cache.riwayatTglAkhir, this.cache.riwayatProgram].forEach(el => {
                el.addEventListener('input', () => {
                    this.state.displayedHistoryCount = this.state.historyItemsPerPage;
                    this.UI.renderHistoryTable();
                });
            });
            this.cache.loadMoreBtn.addEventListener('click', () => {
                this.state.displayedHistoryCount += this.state.historyItemsPerPage;
                this.UI.renderHistoryTable();
            });
            this.cache.closeModalBtn.addEventListener('click', () => this.UI.closeModal('leaderboardModal'));
            this.cache.leaderboardModal.addEventListener('click', (e) => { if (e.target === this.cache.leaderboardModal) this.UI.closeModal('leaderboardModal'); });
            this.cache.cancelDeleteBtn.addEventListener('click', () => this.UI.closeModal('confirmDeleteModal'));
            this.cache.confirmDeleteBtn.addEventListener('click', this.handlers.handleConfirmDelete.bind(this));
            this.cache.confirmDeleteModal.addEventListener('click', (e) => { if (e.target === this.cache.confirmDeleteModal) this.UI.closeModal('confirmDeleteModal'); });
            this.cache.mainContent.addEventListener('click', this.handlers.handleMainContentClick.bind(this));
        },

        /**
         * -------------------------------------------------------------
         * EVENT HANDLERS: Logic that runs on user interaction.
         * -------------------------------------------------------------
         */
        handlers: {
            handleFormSubmit(e) {
                e.preventDefault();
                const formData = new FormData(this.cache.form);
                const setoranData = Object.fromEntries(formData.entries());
                const santri = this.data.findSantriById(setoranData.namaSantri);
                
                if (!santri) return this.UI.showToast('Error: Santri tidak ditemukan!', 'error');

                Object.assign(setoranData, {
                    id: `mock-${Date.now()}`,
                    santriId: santri.id,
                    namaSantri: santri.nama,
                    musyrif: santri.musyrif,
                    program: santri.program,
                    createdAt: new Date(setoranData.tanggal).toISOString()
                });

                const juz = parseInt(setoranData.juz);
                if (setoranData.jenis === 'Ziyadah' && [28, 29, 30].includes(juz)) {
                    if (!setoranData.surat) return this.UI.showToast('Error: Silakan pilih surat.', 'error');
                    setoranData.setoranUnit = setoranData.surat;
                } else if (setoranData.jenis === 'Mutqin' && !setoranData.halaman) {
                    setoranData.setoranUnit = '1 Juz';
                } else {
                    if (!setoranData.halaman) return this.UI.showToast('Error: Jumlah halaman harus diisi.', 'error');
                    setoranData.setoranUnit = `${setoranData.halaman} halaman`;
                }
                
                delete setoranData.tanggal;

                this.data.addSetoran(setoranData);
                this.UI.showToast('Setoran berhasil disimpan!', 'success');
                this.UI.resetForm();
            },

            handleMusyrifChange() { this.UI.updateSantriOptions(); },
            handleSantriChange() { this.UI.updateSantriDetails(); this.UI.updateJenisOptions(); },
            handleJenisChange() { this.UI.updateJuzOptions(); },
            handleJuzChange() { this.UI.updateSetoranInputs(); },

            handleNavClick(e) {
                const link = e.target.closest('.nav-link');
                if (link) {
                    e.preventDefault();
                    this.UI.switchPage(link.dataset.page);
                }
            },

            handleTabClick(contentSelector, idPrefix, e) {
                const button = e.target.closest('button');
                if (button) {
                    this.UI.switchTab(button.parentElement, contentSelector, button, idPrefix);
                }
            },

            handleHistorySearch(e) {
                clearTimeout(this.state.searchDebounceTimer);
                this.state.searchDebounceTimer = setTimeout(() => {
                    this.state.displayedHistoryCount = this.state.historyItemsPerPage;
                    this.UI.renderHistoryTable();
                    this.UI.renderSearchSuggestions(e.target.value);
                }, 300);
            },

            handleSuggestionClick(e) {
                if (e.target.matches('.suggestion-item')) {
                    this.cache.riwayatSearch.value = e.target.textContent;
                    this.cache.suggestionsContainer.classList.add('hidden');
                    this.state.displayedHistoryCount = this.state.historyItemsPerPage;
                    this.UI.renderHistoryTable();
                }
            },

            handleConfirmDelete() {
                this.data.deleteSetoran(this.state.setoranIdToDelete);
                this.UI.closeModal('confirmDeleteModal');
                this.UI.showToast('Data berhasil dihapus.', 'success');
            },

            handleMainContentClick(e) {
                const seeAllBtn = e.target.closest('.see-all-btn');
                const exportBtn = e.target.closest('.export-pdf-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const quickAccessBtn = e.target.closest('.quick-access-btn');

                if (seeAllBtn) {
                    const { category, program } = seeAllBtn.dataset;
                    this.UI.showLeaderboardModal(program, category);
                }
                if (exportBtn) {
                    this.UI.exportRecapToPDF(exportBtn.dataset.classGroup);
                }
                if (deleteBtn) {
                    this.state.setoranIdToDelete = deleteBtn.dataset.id;
                    this.UI.openModal('confirmDeleteModal');
                }
                if (quickAccessBtn) {
                    this.UI.switchPage(quickAccessBtn.dataset.targetPage);
                }
            }
        },

        /**
         * -------------------------------------------------------------
         * DATA LOGIC: Functions for getting and manipulating mock data.
         * -------------------------------------------------------------
         */
        data: {
            loadMockData() {
                App.state.santriData = [
                    { id: 'santri1', nama: 'Adelio Daffa Syahrizha', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri2', nama: 'Ahmad Ahsanur Rizqi', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri3', nama: 'Arkana El Sabilly', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri4', nama: "Athaya Auza'I Mubarak", kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri5', nama: 'Dama Arza Evannova', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri6', nama: 'Danar Nizam Daniswara', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri7', nama: 'Devgan Jadid Sahlvatico', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri8', nama: 'Fariq Imtiyas Aufaa Kamil', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri9', nama: 'Firaas Izzulhaq', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri10', nama: 'Gilang Omar F', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri11', nama: 'Jaladri Arif Wirasena', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri12', nama: 'Kemal Mubarak Siregar', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri13', nama: 'Khairil Nizam', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri14', nama: 'Mirza Nasyath Ahza Attaillah', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri15', nama: 'Muhammad Farros Linggar Cahyono', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri16', nama: 'Muhammad Fathir Alfalah', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri17', nama: 'Narendra Wibawa', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri18', nama: 'Naufal Zhafran Purnama', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri19', nama: 'Alano Faaiq Alfeno', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri20', nama: 'Arfandhika Fakhrul Islam', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri21', nama: 'Aydin Rafif', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri22', nama: 'Danish Alzahid Dinasti', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri23', nama: 'Ghani Arif Witjaksono', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri24', nama: 'Haidarrafid Satriaa Ardhani', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri25', nama: 'Iqbal Zulfikar Al Hanif', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri26', nama: 'Jangky Dausat', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri27', nama: 'Kumara Banyu Argani', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri28', nama: 'M. Dede Afkar', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri29', nama: 'Mekha Ilham Lutfianto', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri30', nama: 'Muhammad Aiman Naim', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri31', nama: 'Muhammad Karel Ashiddiq', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri32', nama: 'Naufal Fahmi Darsono', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri33', nama: 'Nazhif Fahreza Zuhairy', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri34', nama: 'Rais Abqari Ash Shidqi', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri35', nama: 'William Ramadhan Al Ghazali', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri36', nama: 'Zia El Ibrahim Aqeela Putra Wijaya', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri37', nama: "Ahmad Arkan Sya'Bani", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri38', nama: 'Ahmad Darwis', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri39', nama: 'Ahmad Ghozi El Muntazhor', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri40', nama: "Aldan 'Izzul Islam", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri41', nama: 'Fawwaz Elfareza Zuhri', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri42', nama: 'M. Fathan Alfarisi Harahap', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri43', nama: 'Muhammad Ahsani Taqwim', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri44', nama: 'Muhammad Ayyub Al Fatih', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri45', nama: 'Muhammad Gibran Rafassya', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri46', nama: 'Narendra Gerrardi Kusumah', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri47', nama: "Rijal Abdul A'Ziz", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri48', nama: 'Rizki Chandra Dewantara', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat', setoranMutqin: new Set() },
                    { id: 'santri49', nama: 'Ahmad Miqdad', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri50', nama: 'Dzaky Salman Al Farisi', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri51', nama: 'Muhammad Alvi Mumtaz Brillian Hafizh', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri52', nama: 'Muhammad Mahdi Hafidz', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri53', nama: 'Muhammad Naufal Rasyid Arafi', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri54', nama: 'Nahsif Ilman Hazim Purwono', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri55', nama: 'Nawwaf Bahy Rafif', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri56', nama: 'Nizar Adhyatma Aryanda', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri57', nama: 'Rafa Agitananda Az Zayyan', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri58', nama: "Rafa Faeyza Fa'Iz", kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri59', nama: 'Rizqi Satria Putra Surya', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri60', nama: 'Umar Ubaidillah Tsaqif', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri61', nama: 'Wildan Faiz Mahendra', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah', setoranMutqin: new Set() },
                    { id: 'santri62', nama: 'Faiq Fauzil Adhim', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri63', nama: 'Fairuz Azzam Mahfuzh', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri64', nama: 'Muhammad Arkhan Attaqi', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri65', nama: 'Muhammad Daffa Naufal Alaika', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri66', nama: 'Muzakki Fairuzzaman', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri67', nama: 'Neymar Tsaqif Hikmatyar', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri68', nama: 'Rifqi Maliki', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri69', nama: "Yasykur Slamer'Abqariy", kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri70', nama: 'Zhafran Dhiaurrahman Hakim', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri71', nama: 'Achmad Adi Darwis Elfaza', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri72', nama: 'Galang Afkar Artyanto', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri73', nama: 'Gilang Asytar Artyanto', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri74', nama: 'Muhammad Alif Al-Fatih', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri75', nama: 'Muhammad Faiz Ibnu Zakaria', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri76', nama: 'Muhammad Mahdi Hanafi', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri77', nama: 'Muhammad Muhdi Hafidz', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri78', nama: 'Rizqi Ahmad Altaf Zafar', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri79', nama: 'Dzaky Anthony Akbar', kelas: '2G', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri80', nama: 'Muwafaqi Amru Ahmad', kelas: '2G', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri81', nama: 'Abdul Ghani Irfan Rafif', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri82', nama: 'Abid Fadhil Abiyah', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri83', nama: "Ahmad Dahlan Asy'Ari", kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri84', nama: 'Athallah Azmi Ghaisan Muhammad', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri85', nama: 'Azmi Zulfadli Syafiq', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri86', nama: 'Azri Labibul Khawarizmi', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri87', nama: 'Dzar Al Ghifari', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri88', nama: 'Fatihan Al Ghifari', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri89', nama: 'Hisyam Nabil Pasha', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri90', nama: 'Ibadillah Kaiazmi Mubarak', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri91', nama: 'Kashvi Jabbar Azana', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri92', nama: 'Khawarizmi Fakhrulhaq', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri93', nama: 'Muh. Naufal Alif', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri94', nama: 'Muhammad Aghna Ilman Rafa', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri95', nama: 'Royyan Abdurrahman Ibtisam', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                    { id: 'santri96', nama: 'Sakhi Arkan Elfariza', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji', setoranMutqin: new Set() },
                ];
                App.state.allSetoran = [];
                App.state.surahData = {
                    "28": { "list": ["An-Naba", "An-Nazi'at"] },
                    "29": { "list": ["Al-Mulk", "Al-Qalam"] },
                    "30": { "list": ["Al-Fatihah", "An-Nas", "Al-Falaq", "Al-Ikhlas"] },
                    "surahPageValues": { "An-Naba": 2, "An-Nazi'at": 2, "Al-Mulk": 2.5, "Al-Qalam": 2, "Al-Fatihah": 1, "An-Nas": 0.5, "Al-Falaq": 0.5, "Al-Ikhlas": 0.5 }
                };
            },

            addSetoran(setoranData) {
                App.state.allSetoran.unshift(setoranData);
                if (setoranData.jenis === 'Mutqin' && setoranData.setoranUnit === '1 Juz') {
                    const santri = App.data.findSantriById(setoranData.santriId);
                    if (santri) {
                        santri.setoranMutqin.add(parseInt(setoranData.juz));
                    }
                }
                App.UI.renderAll();
            },

            deleteSetoran(id) {
                if (!id) return;
                
                const setoranToDelete = App.state.allSetoran.find(s => s.id === id);
                App.state.allSetoran = App.state.allSetoran.filter(s => s.id !== id);

                if (setoranToDelete && setoranToDelete.jenis === 'Mutqin' && setoranToDelete.setoranUnit === '1 Juz') {
                    const santri = App.data.findSantriById(setoranToDelete.santriId);
                    if (santri) {
                        santri.setoranMutqin.delete(parseInt(setoranToDelete.juz));
                    }
                }
                
                App.UI.renderAll();
            },

            findSantriById(id) { return App.state.santriData.find(s => s.id == id); },
            
            calculatePageValue(setoran) {
                if (setoran.setoranUnit === '1 Juz') return 20;
                if (setoran.setoranUnit.includes('halaman')) return parseFloat(setoran.setoranUnit) || 0;
                const surahInfo = App.state.surahData.surahPageValues;
                return surahInfo ? (surahInfo[setoran.setoranUnit] || 0) : 0;
            },

            getFilteredHistory() {
                const searchTerm = App.cache.riwayatSearch.value.toLowerCase();
                const programFilter = App.cache.riwayatProgram.value;
                const startDate = App.cache.riwayatTglMulai.value ? new Date(App.cache.riwayatTglMulai.value) : null;
                const endDate = App.cache.riwayatTglAkhir.value ? new Date(App.cache.riwayatTglAkhir.value) : null;
                if(startDate) startDate.setHours(0,0,0,0);
                if(endDate) endDate.setHours(23,59,59,999);

                return App.state.allSetoran
                    .filter(s => {
                        const setoranDate = new Date(s.createdAt);
                        const nameMatch = s.namaSantri.toLowerCase().includes(searchTerm);
                        const programMatch = programFilter === 'Semua' || s.program === programFilter;
                        const startDateMatch = !startDate || setoranDate >= startDate;
                        const endDateMatch = !endDate || setoranDate <= endDate;
                        return nameMatch && programMatch && startDateMatch && endDateMatch;
                    })
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            },
            
            getLeaderboardStats() {
                const statsBySantri = App.state.allSetoran.reduce((acc, s) => {
                    const santri = App.data.findSantriById(s.santriId);
                    if (!santri) return acc;
                    const programKey = s.program.toLowerCase();
                    
                    if (!acc[programKey]) acc[programKey] = {};
                    if (!acc[programKey][s.santriId]) {
                        acc[programKey][s.santriId] = { nama: s.namaSantri, program: s.program, kelas: santri.kelas, totalHalaman: 0, frekuensi: 0, totalKualitas: 0 };
                    }
                    
                    const qualityMap = { 'Mumtaz': 5, 'Jayyid Jiddan': 4, 'Jayyid': 3, 'Maqbul': 2, 'Dhoif': 1 };
                    acc[programKey][s.santriId].totalHalaman += App.data.calculatePageValue(s);
                    acc[programKey][s.santriId].frekuensi += 1;
                    acc[programKey][s.santriId].totalKualitas += qualityMap[s.kualitas] || 0;
                    return acc;
                }, {});

                const leaderboards = { unggulan: {}, tahfizh: {} };
                ['unggulan', 'tahfizh'].forEach(programKey => {
                    const statsArray = Object.values(statsBySantri[programKey] || {});
                    leaderboards[programKey].terbanyak = [...statsArray].sort((a, b) => b.totalHalaman - a.totalHalaman);
                    leaderboards[programKey].terrajin = [...statsArray].sort((a, b) => b.frekuensi - a.frekuensi);
                    leaderboards[programKey].kualitas = statsArray
                        .filter(a => a.frekuensi > 0)
                        .map(a => ({ ...a, avgKualitas: a.totalKualitas / a.frekuensi }))
                        .sort((a, b) => b.avgKualitas - a.avgKualitas);
                });
                return leaderboards;
            },
            
            getMutqinStats() {
                const tahfizhSantri = App.state.santriData.filter(s => s.program === 'Tahfizh');
                const totalTahfizh = tahfizhSantri.length;
                const mutqin30 = tahfizhSantri.filter(s => s.setoranMutqin.has(30)).length;
                const mutqin29 = tahfizhSantri.filter(s => s.setoranMutqin.has(29)).length;
                return { totalTahfizh, mutqin29, mutqin30 };
            }
        },

        /**
         * -------------------------------------------------------------
         * UI: Functions for rendering and updating the DOM.
         * -------------------------------------------------------------
         */
        UI: {
            renderAll() {
                this.renderHistoryTable();
                this.renderBeranda();
                this.renderAllRecaps();
            },

            renderBeranda() {
                const leaderboards = App.data.getLeaderboardStats();
                const totalHalaman = App.state.allSetoran.reduce((sum, s) => sum + App.data.calculatePageValue(s), 0);
                const santriAktifIds = new Set(App.state.allSetoran.map(s => s.santriId));

                App.cache.stats.totalSetoran.textContent = App.state.allSetoran.length;
                App.cache.stats.santriAktif.textContent = santriAktifIds.size;
                App.cache.stats.totalHalaman.textContent = totalHalaman.toFixed(1);

                ['unggulan', 'tahfizh'].forEach(programKey => {
                    this.displayLeaderboard(programKey, 'terbanyak', leaderboards[programKey].terbanyak.slice(0, 3));
                    this.displayLeaderboard(programKey, 'terrajin', leaderboards[programKey].terrajin.slice(0, 3));
                    this.displayLeaderboard(programKey, 'kualitas', leaderboards[programKey].kualitas.slice(0, 3));
                });
                
                this.renderRecentActivity();
                this.renderWeeklySummaryChart();
                this.renderMutqinCharts();
            },

            renderHistoryTable() {
                const filteredSetoran = App.data.getFilteredHistory();
                const itemsToRender = filteredSetoran.slice(0, App.state.displayedHistoryCount);
                const tableBody = App.cache.tableBody;
                const template = App.cache.historyRowTemplate;

                tableBody.innerHTML = '';

                if (itemsToRender.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">Tidak ada data yang cocok.</td></tr>`;
                } else {
                    const fragment = document.createDocumentFragment();
                    itemsToRender.forEach(setoran => {
                        const santri = App.data.findSantriById(setoran.santriId);
                        const clone = template.content.cloneNode(true);
                        
                        clone.querySelector('.data-nama').textContent = setoran.namaSantri;
                        clone.querySelector('.data-program-icon').innerHTML = this.getProgramIcon(setoran.program);
                        clone.querySelector('.data-kelas-icon').innerHTML = this.getClassIcon(santri ? santri.kelas : '');
                        clone.querySelector('.data-jenis').textContent = setoran.jenis;
                        clone.querySelector('.data-juz').textContent = setoran.juz;
                        clone.querySelector('.data-unit').textContent = setoran.setoranUnit;
                        clone.querySelector('.data-kualitas').innerHTML = this.getKualitasSVG(setoran.kualitas);
                        clone.querySelector('.data-tanggal').textContent = new Date(setoran.createdAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                        clone.querySelector('.delete-btn').dataset.id = setoran.id;

                        fragment.appendChild(clone);
                    });
                    tableBody.appendChild(fragment);
                }

                if (filteredSetoran.length > App.state.displayedHistoryCount) {
                    App.cache.loadMoreBtn.classList.remove('hidden');
                    App.cache.loadMoreBtn.textContent = `Muat Lebih Banyak (${filteredSetoran.length - App.state.displayedHistoryCount} lagi)`;
                } else {
                    App.cache.loadMoreBtn.classList.add('hidden');
                }
            },

            renderAllRecaps() {
                const classGroups = App.dataSources.classGroups;
                const sortedGroupNames = Object.keys(classGroups).sort((a,b) => {
                    if (a.startsWith('2') && b.startsWith('2')) {
                        return a.localeCompare(b);
                    }
                    return a.localeCompare(b);
                });

                App.cache.rekapTabs.innerHTML = sortedGroupNames.map((groupName, index) => 
                    `<button data-tab="${groupName.replace(/, /g, '')}" class="rekap-tab-btn ${index === 0 ? 'active' : ''} flex-shrink-0 snap-center whitespace-nowrap py-2 px-5 text-sm font-medium text-gray-700 rounded-md">Kelas ${groupName}</button>`
                ).join('');

                App.cache.rekapContentContainer.innerHTML = sortedGroupNames.map((groupName, index) => `
                    <div id="rekap-tab-${groupName.replace(/, /g, '')}" class="rekap-tab-content ${index > 0 ? 'hidden' : ''}">${this.createRecapHTML(groupName)}</div>
                `).join('');
            },

            renderRecentActivity() {
                const recentActivities = [...App.state.allSetoran].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
                if(recentActivities.length > 0) {
                    App.cache.recentActivityList.innerHTML = recentActivities.map(s => {
                        const santri = App.data.findSantriById(s.santriId);
                        const emoji = App.dataSources.santriEmojis[s.santriId.charCodeAt(s.santriId.length - 1) % App.dataSources.santriEmojis.length];
                        return `
                        <div class="flex items-start gap-3">
                            <div class="bg-gray-200/80 p-2 text-xl rounded-full mt-1">${emoji}</div>
                            <div>
                                <p class="text-sm font-semibold text-gray-800 flex items-center">${s.namaSantri} ${this.getProgramIcon(s.program)} ${this.getClassIcon(santri.kelas)}</p>
                                <p class="text-xs text-gray-500">Menyetor ${s.jenis} ${s.setoranUnit === '1 Juz' ? `Juz ${s.juz}` : s.setoranUnit}</p>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    App.cache.recentActivityList.innerHTML = `<p class="text-sm text-gray-500">Belum ada aktivitas.</p>`;
                }
            },
            
            renderWeeklySummaryChart() {
                if (App.state.allSetoran.length === 0) {
                    App.cache.weeklyChartContainer.classList.add('hidden');
                    return;
                }
                App.cache.weeklyChartContainer.classList.remove('hidden');

                const labels = [];
                const data = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    labels.push(d.toLocaleDateString('id-ID', { weekday: 'short' }));
                    const setoranOnDay = App.state.allSetoran.filter(s => new Date(s.createdAt).toDateString() === d.toDateString());
                    data.push(setoranOnDay.length);
                }

                if (App.state.weeklyChart) App.state.weeklyChart.destroy();
                
                App.state.weeklyChart = new Chart(App.cache.weeklyChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Setoran',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.4)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        onHover: (event, chartElement) => {
                            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1, color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            },

            renderMutqinCharts() {
                const stats = App.data.getMutqinStats();
                if (stats.totalTahfizh === 0) {
                    App.cache.mutqinJuz29ChartContainer.classList.add('hidden');
                    App.cache.mutqinJuz30ChartContainer.classList.add('hidden');
                    return;
                }
                App.cache.mutqinJuz29ChartContainer.classList.remove('hidden');
                App.cache.mutqinJuz30ChartContainer.classList.remove('hidden');
                
                // Chart for Juz 30
                if (App.state.mutqinJuz30Chart) App.state.mutqinJuz30Chart.destroy();
                App.state.mutqinJuz30Chart = this.createDoughnutChart(
                    App.cache.mutqinJuz30ChartCanvas,
                    ['Sudah', 'Belum'],
                    [stats.mutqin30, stats.totalTahfizh - stats.mutqin30],
                    stats.totalTahfizh,
                    ['rgba(16, 185, 129, 0.7)', 'rgba(209, 213, 219, 0.7)']
                );
                
                // Chart for Juz 29
                if (App.state.mutqinJuz29Chart) App.state.mutqinJuz29Chart.destroy();
                App.state.mutqinJuz29Chart = this.createDoughnutChart(
                    App.cache.mutqinJuz29ChartCanvas,
                    ['Sudah', 'Belum'],
                    [stats.mutqin29, stats.totalTahfizh - stats.mutqin29],
                    stats.totalTahfizh,
                    ['rgba(245, 158, 11, 0.7)', 'rgba(209, 213, 219, 0.7)']
                );
            },

            createDoughnutChart(canvas, labels, data, total, backgroundColors) {
                 return new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Santri',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverOffset: 8,
                            hoverBorderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '50%',
                        onHover: (event, chartElement) => {
                            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#1f2937', padding: 15, usePointStyle: true, pointStyle: 'rectRounded' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} santri (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            },
            
            renderSearchSuggestions(query) {
                if (query.length < 2) {
                    App.cache.suggestionsContainer.classList.add('hidden');
                    return;
                }
                const suggestions = App.state.santriData
                    .filter(s => s.nama.toLowerCase().includes(query.toLowerCase()))
                    .slice(0, 5);
                
                if (suggestions.length > 0) {
                    App.cache.suggestionsContainer.innerHTML = suggestions
                        .map(s => `<div class="suggestion-item p-2 hover:bg-gray-100 cursor-pointer">${s.nama}</div>`)
                        .join('');
                    App.cache.suggestionsContainer.classList.remove('hidden');
                } else {
                    App.cache.suggestionsContainer.classList.add('hidden');
                }
            },

            resetForm() {
                App.cache.form.reset();
                this.setCurrentDateTime();
                App.cache.musyrifSelect.value = "";
                ['santriSelect', 'jenisSelect', 'juzSelect'].forEach(key => {
                    this.populateSelect(App.cache[key], [], `Pilih ${key === 'santriSelect' ? 'Musyrif' : '...'} dahulu`);
                    App.cache[key].disabled = true;
                });
                ['kelasInput', 'programInput'].forEach(key => App.cache[key].value = '');
                this.resetSetoranInputs();
            },

            resetSetoranInputs() {
                App.cache.halamanContainer.classList.add('hidden');
                App.cache.suratContainer.classList.add('hidden');
                App.cache.halamanInput.disabled = true;
                App.cache.halamanInput.required = false;
                App.cache.halamanInput.value = '';
                App.cache.halamanInput.min = 1;
                App.cache.halamanInput.placeholder = '';
                App.cache.suratSelect.required = false;
            },
            
            updateSantriOptions() {
                const selectedMusyrif = App.cache.musyrifSelect.value;
                this.resetSetoranInputs();
                App.cache.jenisSelect.disabled = true;
                App.cache.juzSelect.disabled = true;
                if (selectedMusyrif) {
                    const santriOptions = App.state.santriData
                        .filter(s => s.musyrif === selectedMusyrif)
                        .sort((a, b) => a.nama.localeCompare(b.nama))
                        .map(s => ({ text: s.nama, value: s.id }));
                    this.populateSelect(App.cache.santriSelect, santriOptions, 'Pilih Santri');
                    App.cache.santriSelect.disabled = false;
                } else {
                    this.populateSelect(App.cache.santriSelect, [], 'Pilih Musyrif dahulu');
                    App.cache.santriSelect.disabled = true;
                }
            },

            updateSantriDetails() {
                const santri = App.data.findSantriById(App.cache.santriSelect.value);
                this.resetSetoranInputs();
                if (santri) {
                    App.cache.kelasInput.value = santri.kelas;
                    App.cache.programInput.value = santri.program;
                }
            },

            updateJenisOptions() {
                const santri = App.data.findSantriById(App.cache.santriSelect.value);
                if (santri) {
                    const hasCompletedBasicMutqin = santri.setoranMutqin.has(29) && santri.setoranMutqin.has(30);
                    const jenisOptions = [];
                    if (santri.program === "Unggulan" || (santri.program === "Tahfizh" && hasCompletedBasicMutqin)) {
                        jenisOptions.push("Ziyadah");
                    }
                    jenisOptions.push("Mutqin");
                    this.populateSelect(App.cache.jenisSelect, jenisOptions, 'Pilih Jenis');
                    App.cache.jenisSelect.disabled = false;
                } else {
                    App.cache.jenisSelect.disabled = true;
                }
            },

            updateJuzOptions() {
                const jenis = App.cache.jenisSelect.value;
                const santri = App.data.findSantriById(App.cache.santriSelect.value);
                this.resetSetoranInputs();
                if (!jenis || !santri) {
                    App.cache.juzSelect.disabled = true;
                    return;
                }
                let juzOptions = [];
                if (jenis === "Mutqin") {
                    for (let i = 1; i <= 30; i++) if (!santri.setoranMutqin.has(i)) juzOptions.push({ text: `Juz ${i}`, value: i });
                } else if (jenis === "Ziyadah") {
                    for (let i = 1; i <= 30; i++) juzOptions.push({ text: `Juz ${i}`, value: i });
                }
                this.populateSelect(App.cache.juzSelect, juzOptions, 'Pilih Juz');
                App.cache.juzSelect.disabled = false;
            },

            updateSetoranInputs() {
                const jenis = App.cache.jenisSelect.value;
                const juz = parseInt(App.cache.juzSelect.value);
                this.resetSetoranInputs();

                const surahList = App.state.surahData[juz] ? App.state.surahData[juz].list : [];

                if (jenis === 'Ziyadah') {
                    if ([28, 29, 30].includes(juz) && surahList.length > 0) {
                        App.cache.suratContainer.classList.remove('hidden');
                        App.cache.suratSelect.required = true;
                        this.populateSelect(App.cache.suratSelect, surahList, 'Pilih Surat');
                    } else {
                        App.cache.halamanContainer.classList.remove('hidden');
                        App.cache.halamanInput.required = true;
                        App.cache.halamanInput.disabled = false;
                    }
                } else if (jenis === 'Mutqin') {
                    App.cache.halamanContainer.classList.remove('hidden');
                    App.cache.halamanInput.disabled = false;
                    App.cache.halamanInput.placeholder = 'Min 5 hlm / Kosongkan utk 1 Juz';
                    App.cache.halamanInput.min = 5;
                    App.cache.halamanInput.required = false;
                }
            },

            setCurrentDateTime() {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                App.cache.tanggalInput.value = now.toISOString().slice(0, 16);
            },
            
            showToast(message, type = 'success') {
                App.cache.toastMessage.textContent = message;
                const isSuccess = type === 'success';
                App.cache.toastIcon.innerHTML = isSuccess 
                    ? `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />`
                    : `<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`;
                App.cache.toastIcon.classList.toggle('text-green-400', isSuccess);
                App.cache.toastIcon.classList.toggle('text-red-400', !isSuccess);
                App.cache.toast.classList.add('show');
                setTimeout(() => App.cache.toast.classList.remove('show'), 3000);
            },

            openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); },
            closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); },
            
            switchPage(pageId) {
                if (!pageId) return;
                App.cache.pages.forEach(page => page.classList.add('hidden'));
                const targetPage = document.getElementById(pageId);
                if(targetPage) targetPage.classList.remove('hidden');

                App.cache.mainNav.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
                const activeLink = App.cache.mainNav.querySelector(`a[data-page="${pageId}"]`);
                if(activeLink) activeLink.classList.add('active');
            },

            switchTab(container, contentSelector, clickedBtn, idPrefix) {
                container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                clickedBtn.classList.add('active');
                
                const targetTabId = clickedBtn.dataset.tab.replace(/, /g, '');
                container.closest('.glass-card').querySelectorAll(contentSelector).forEach(content => content.classList.add('hidden'));
                const targetId = `${idPrefix}-${targetTabId}`;
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.classList.remove('hidden');
                }
            },
            
            displayLeaderboard(program, category, data) {
                const listEl = document.getElementById(`stats-${program}-${category}-list`);
                if (!listEl) return;
                if (data.length === 0) {
                    listEl.innerHTML = '<p class="text-sm text-gray-500">Belum ada data.</p>';
                    return;
                }
                const emojiMap = {1: '🥇', 2: '🥈', 3: '🥉'};
                listEl.innerHTML = data.map((item, index) => {
                    const rank = index + 1;
                    const emoji = emojiMap[rank] || `<span class="font-normal text-gray-500 w-6 text-center">${rank}.</span>`;
                    let valueText = '';
                    if (category === 'terbanyak') valueText = `${item.totalHalaman.toFixed(1)} hlm`;
                    else if (category === 'terrajin') valueText = `${item.frekuensi}x setor`;
                    else if (category === 'kualitas') valueText = `Avg: ${(item.avgKualitas).toFixed(2)}`;
                    return `<div class="text-sm flex justify-between items-center"><span class="font-semibold text-gray-800 truncate flex items-center"><span class="mr-2 w-6 inline-block text-center">${emoji}</span>${item.nama} ${this.getClassIcon(item.kelas)}</span><span class="text-gray-600 font-medium">${valueText}</span></div>`;
                }).join('');
            },
            
            showLeaderboardModal(program, category) {
                const leaderboards = App.data.getLeaderboardStats();
                const titles = { terbanyak: '📚 Top 10 Halaman Terbanyak', terrajin: '🏃‍♂️ Top 10 Paling Rajin', kualitas: '⭐ Top 10 Kualitas Terbaik' };
                App.cache.modalTitle.textContent = `${titles[category]} (${program.charAt(0).toUpperCase() + program.slice(1)})`;
                const fullData = leaderboards[program][category].slice(0, 10);
                App.cache.modalBody.innerHTML = fullData.length === 0 ? '<p class="text-center text-gray-500">Tidak ada data.</p>' : `<ol class="space-y-3">${fullData.map((item, index) => {
                    let valueText = '';
                    if (category === 'terbanyak') valueText = `${item.totalHalaman.toFixed(1)} halaman`;
                    else if (category === 'terrajin') valueText = `${item.frekuensi} setoran`;
                    else if (category === 'kualitas') valueText = `Rata-rata: ${(item.avgKualitas).toFixed(2)}`;
                    return `<li class="flex items-center justify-between pb-2 border-b border-gray-200/80"><div><span class="font-bold mr-3 w-6 inline-block text-center">${index + 1}.</span><span class="text-gray-800">${item.nama}</span></div><span class="font-semibold text-gray-700">${valueText}</span></li>`;
                }).join('')}</ol>`;
                this.openModal('leaderboardModal');
            },

            createRecapHTML(groupName) {
                const group = App.dataSources.classGroups[groupName];
                const timestamp = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                
                const tableRows = group.santri.sort((a,b) => a.nama.localeCompare(b.nama)).map((santri, index) => {
                    const totalHalaman = App.state.allSetoran
                        .filter(s => s.santriId === santri.id)
                        .reduce((sum, s) => sum + App.data.calculatePageValue(s), 0);
                    const isTuntas = (santri.setoranMutqin?.size || 0) >= 30;
                    const keterangan = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isTuntas ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${isTuntas ? 'Tuntas' : 'Belum'}</span>`;
                    return `<tr class="hover:bg-gray-50/50"><td class="px-4 py-2 text-gray-800">${index + 1}</td><td class="px-4 py-2 text-sm text-gray-800"><div class="flex items-center">${santri.nama}${this.getProgramIcon(santri.program)}${this.getClassIcon(santri.kelas)}</div></td><td class="px-4 py-2 font-medium text-gray-800">${totalHalaman.toFixed(1)}</td><td class="px-4 py-2">${keterangan}</td></tr>`;
                }).join('');

                return `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <div><h3 class="font-bold text-amber-700 text-lg">Rekap Capaian - Kelas ${groupName}</h3><p class="text-sm text-gray-600">Musyrif: ${group.musyrif}</p><p class="text-xs text-gray-500">${timestamp}</p></div>
                    <button data-class-group="${groupName}" class="export-pdf-btn mt-3 sm:mt-0 bg-green-600 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Ekspor ke PDF</button>
                </div>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200/80"><thead class="bg-gray-100/80"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skor</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th></tr></thead><tbody class="divide-y divide-gray-200/80">${tableRows}</tbody></table></div>
                `;
            },

            exportRecapToPDF(classGroup) {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'pt', 'a4');
                    const group = App.dataSources.classGroups[classGroup];
                    if (!group) return this.showToast('Grup kelas tidak ditemukan.', 'error');

                    doc.autoTable({
                        head: [['No.', 'Nama Santri', 'Program', 'Skor', 'Keterangan']],
                        body: group.santri.sort((a, b) => a.nama.localeCompare(b.nama)).map((santri, index) => {
                            const totalHalaman = App.state.allSetoran.filter(s => s.santriId === santri.id).reduce((sum, s) => sum + App.data.calculatePageValue(s), 0);
                            const isTuntas = (santri.setoranMutqin?.size || 0) >= 30;
                            return [
                                index + 1, santri.nama, santri.program, totalHalaman.toFixed(1), isTuntas ? 'Tuntas' : 'Belum Tuntas'
                            ];
                        }),
                        theme: 'grid',
                        headStyles: { fillColor: [217, 119, 6] },
                        styles: { font: 'Inter', cellPadding: 6, valign: 'middle' },
                        columnStyles: {
                            0: { cellWidth: 30 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 60 },
                            3: { cellWidth: 40, halign: 'center' }, 4: { cellWidth: 80, halign: 'center' }
                        },
                        didParseCell: (data) => { if (data.column.index === 1) data.cell.styles.fontSize = 8; },
                        didDrawPage: (data) => {
                            doc.setFontSize(20);
                            doc.setTextColor(180, 83, 9);
                            doc.setFont('helvetica', 'bold');
                            doc.text('Laporan Capaian Tahfizh', data.settings.margin.left, 40);

                            doc.setFontSize(12);
                            doc.setTextColor(40);
                            doc.setFont('helvetica', 'normal');
                            doc.text(`Kelas: ${classGroup} | Musyrif: ${group.musyrif}`, data.settings.margin.left, 58);

                            const pageCount = doc.internal.getNumberOfPages();
                            doc.setFontSize(8);
                            doc.setTextColor(150);
                            doc.text(`Halaman ${data.pageNumber} dari ${pageCount}`, data.settings.margin.left, doc.internal.pageSize.height - 20);
                            doc.text(`Dibuat pada: ${new Date().toLocaleString('id-ID')}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 20, { align: 'right' });
                        },
                        margin: { top: 70, bottom: 40 }
                    });

                    doc.save(`rekap_setoran_${classGroup.replace(/, /g, '_')}_${Date.now()}.pdf`);
                } catch (error) {
                    console.error("PDF Export Error:", error);
                    this.showToast('Gagal mengekspor PDF.', 'error');
                }
            },

            populateSelect(selectEl, options, placeholder) {
                selectEl.innerHTML = '';
                if (placeholder) selectEl.add(new Option(placeholder, ''));
                options.forEach(opt => selectEl.add(typeof opt === 'string' ? new Option(opt, opt) : new Option(opt.text, opt.value)));
            },

            getKualitasSVG(kualitas) {
                const qualityMap = { 'Mumtaz': 5, 'Jayyid Jiddan': 4, 'Jayyid': 3, 'Maqbul': 2, 'Dhoif': 1 };
                const stars = qualityMap[kualitas] || 0;
                const starIcon = `<svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
                const emptyStarIcon = `<svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
                return `<div class="flex">${starIcon.repeat(stars)}${emptyStarIcon.repeat(5 - stars)}</div>`;
            },

            getProgramIcon(program) { return program === 'Unggulan' ? `<span title="Unggulan" class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full bg-blue-100 text-blue-800 text-xs font-bold">U</span>` : `<span title="Tahfizh" class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full bg-green-100 text-green-800 text-xs font-bold">T</span>`; },
            
            getClassIcon(className) {
                let colorClass = 'bg-gray-200 text-gray-800'; // Default
                switch(className) {
                    case '2A': colorClass = 'bg-red-100 text-red-800'; break;
                    case '2B': colorClass = 'bg-yellow-100 text-yellow-800'; break;
                    case '2C': case '2D': colorClass = 'bg-green-100 text-green-800'; break;
                    case '2G': case '2H': colorClass = 'bg-blue-100 text-blue-800'; break;
                }
                return `<span title="Kelas ${className}" class="ml-1 inline-flex items-center justify-center h-5 w-5 rounded-full ${colorClass} text-xs font-bold">${className}</span>`;
            }
        }
    };

    // Initialize the application once the DOM is ready.
    document.addEventListener('DOMContentLoaded', () => {
        App.init();
    });

</script>
</body>
</html>
