<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Setoran Hafalan - Asrama 1 Abu Bakar Ash-Shiddiq, Madrasah Mu'allimin Muhammadiyah Yogyakarta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fffaf0; /* a very light orange */
        }
        .form-select:disabled, .form-input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .table-container {
            max-height: 450px;
            overflow-y: auto;
        }
        
        /* Animasi */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes highlight {
            from { background-color: #fee2e2; } /* red-100 */
            to { background-color: white; }
        }
        .highlight-new-row {
            animation: highlight 2s ease-out forwards;
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0;
            z-index: 50;
            transform: translate(-50%, 100px);
        }
        #toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        
        /* Modal */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.hidden .modal-backdrop {
            opacity: 0;
        }
        .modal.hidden .modal-content {
            opacity: 0;
            transform: translateY(-20px);
        }
        
        /* Tab Papan Peringkat */
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background-color: #f97316; /* orange-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .tab-content.hidden {
            display: none;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Form Card -->
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden fade-in">
            <div class="p-6 sm:p-8">
                <div class="text-center mb-8">
                    <div class="inline-block bg-gradient-to-br from-orange-400 to-amber-500 p-3 rounded-xl text-white mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-9-5.747h18" />
                        </svg>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">üìù Form Setoran Hafalan</h1>
                    <p class="text-gray-600 mt-1">Asrama 1 Abu Bakar Ash-Shiddiq<br>Madrasah Mu'allimin Muhammadiyah Yogyakarta</p>
                </div>

                <form id="setoranForm" class="flex flex-col gap-6">
                    
                    <fieldset>
                        <legend class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">Informasi Dasar</legend>
                        <div>
                            <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal & Waktu</label>
                            <div class="flex items-center gap-2">
                                <div class="relative flex-grow">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                    </div>
                                    <input type="datetime-local" id="tanggal" name="tanggal" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 form-input transition-all" required>
                                </div>
                                <button type="button" id="nowBtn" class="px-4 py-3 bg-orange-100 text-orange-700 font-semibold rounded-lg hover:bg-orange-200 transition-colors">Sekarang</button>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">Detail Santri</legend>
                        <div class="flex flex-col gap-4">
                            <div>
                                <label for="musyrif" class="block text-sm font-medium text-gray-700 mb-1">Musyrif</label>
                                <div class="relative mt-1">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                                    </div>
                                    <select id="musyrif" name="musyrif" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 form-select transition-all" required>
                                        <option value="">Pilih Musyrif</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label for="namaSantri" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label>
                                <div class="relative mt-1">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                    </div>
                                    <select id="namaSantri" name="namaSantri" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 form-select transition-all" required disabled>
                                        <option value="">Pilih Musyrif dahulu</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="kelas" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                    <div class="relative mt-1">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                                        </div>
                                        <input type="text" id="kelas" name="kelas" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm form-input" readonly disabled>
                                    </div>
                                </div>
                                <div>
                                    <label for="program" class="block text-sm font-medium text-gray-700 mb-1">Program</label>
                                    <div class="relative mt-1">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm2 1v2h6V5H7zm0 4v2h6V9H7zm0 4v2h6v-2H7z" /></svg>
                                        </div>
                                        <input type="text" id="program" name="program" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm form-input" readonly disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">Detail Setoran</legend>
                        <div class="flex flex-col gap-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="jenis" class="block text-sm font-medium text-gray-700 mb-1">Jenis Setoran</label>
                                    <div class="relative mt-1">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a1 1 0 00-1 1v1.172l-1.707.284A1 1 0 001.586 6.34l.707.707a1 1 0 001.414 0l.707-.707a1 1 0 000-1.414l-1.707-1.707A1 1 0 002 3.172V3a1 1 0 001-1H2zm13 0h-1a1 1 0 00-1 1v.172a1 1 0 00-.707.293l-1.707 1.707a1 1 0 000 1.414l.707.707a1 1 0 001.414 0l.707-.707A1 1 0 0018 4.414l.284-1.707A1 1 0 0017.414 2H18a1 1 0 001-1h-1zM5 18a1 1 0 011-1h1a1 1 0 110 2H6a1 1 0 01-1-1zm11 0a1 1 0 100 2h1a1 1 0 100-2h-1zM5 11a1 1 0 112 0v1a1 1 0 11-2 0v-1zm5 0a1 1 0 100 2h1a1 1 0 100-2h-1zm-1-4a1 1 0 100 2h1a1 1 0 100-2h-1z" clip-rule="evenodd" /></svg>
                                        </div>
                                        <select id="jenis" name="jenis" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 form-select transition-all" required disabled>
                                            <option value="">Pilih Santri dahulu</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label for="juz" class="block text-sm font-medium text-gray-700 mb-1">Juz</label>
                                    <div class="relative mt-1">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" /></svg>
                                        </div>
                                        <select id="juz" name="juz" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 form-select transition-all" required disabled>
                                            <option value="">Pilih Jenis dahulu</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div id="halaman-container">
                                    <label for="halaman" class="block text-sm font-medium text-gray-700 mb-1">Halaman</label>
                                    <div class="relative mt-1">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v10H5V5z" clip-rule="evenodd" /></svg>
                                        </div>
                                        <input type="number" id="halaman" name="halaman" min="1" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 form-input transition-all" required disabled>
                                    </div>
                                </div>
                                <div id="surat-container" class="hidden">
                                    <label for="surat" class="block text-sm font-medium text-gray-700 mb-1">Surat</label>
                                    <div class="relative mt-1">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804V4.804A7.968 7.968 0 0014.5 4z" /></svg>
                                        </div>
                                        <select id="surat" name="surat" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 form-select transition-all" required>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label for="kualitas" class="block text-sm font-medium text-gray-700 mb-1">Kualitas</label>
                                    <div class="relative mt-1">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                        </div>
                                        <select id="kualitas" name="kualitas" class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 form-select transition-all" required>
                                            <option value="Mumtaz">Mumtaz</option>
                                            <option value="Jayyid Jiddan">Jayyid Jiddan</option>
                                            <option value="Jayyid">Jayyid</option>
                                            <option value="Maqbul">Maqbul</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <div class="mt-2">
                        <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold py-3 px-4 rounded-lg hover:shadow-lg hover:from-orange-600 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all duration-300 transform hover:scale-105">
                            Simpan Setoran
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabel Data Setoran -->
        <div class="mt-12 max-w-6xl mx-auto fade-in" style="animation-delay: 200ms;">
             <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 text-center">üìú Riwayat Setoran</h2>
             <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Santri</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Musyrif</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Juz</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setoran</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kualitas</th>
                            </tr>
                        </thead>
                        <tbody id="setoranTableBody" class="bg-white divide-y divide-gray-200">
                             <tr><td colspan="8" class="text-center p-8 text-gray-500">Belum ada data setoran.</td></tr>
                        </tbody>
                    </table>
                </div>
             </div>
        </div>

        <!-- Papan Peringkat Statistik -->
        <div class="mt-12 max-w-6xl mx-auto fade-in" style="animation-delay: 300ms;">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 text-center">üëë Papan Peringkat</h2>
            
            <!-- Tabs -->
            <div class="mb-4 flex justify-center bg-gray-200 rounded-lg p-1">
                <button data-tab="unggulan" class="tab-btn active w-1/2 py-2 px-4 font-semibold rounded-md">Unggulan</button>
                <button data-tab="tahfizh" class="tab-btn w-1/2 py-2 px-4 font-semibold rounded-md">Tahfizh</button>
            </div>

            <!-- Tab Content -->
            <div id="leaderboard-tabs">
                <div id="tab-unggulan" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col"><h3 class="font-bold text-orange-600 text-lg">üìö Halaman Terbanyak</h3><div id="stats-unggulan-terbanyak-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terbanyak" data-program="unggulan" class="see-all-btn mt-4 text-sm text-orange-600 hover:underline">Lihat semua...</button></div>
                        <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col"><h3 class="font-bold text-amber-600 text-lg">üèÉ‚Äç‚ôÇÔ∏è Paling Rajin</h3><div id="stats-unggulan-terrajin-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terrajin" data-program="unggulan" class="see-all-btn mt-4 text-sm text-amber-600 hover:underline">Lihat semua...</button></div>
                        <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col"><h3 class="font-bold text-red-600 text-lg">‚≠ê Kualitas Terbaik</h3><div id="stats-unggulan-kualitas-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="kualitas" data-program="unggulan" class="see-all-btn mt-4 text-sm text-red-600 hover:underline">Lihat semua...</button></div>
                    </div>
                </div>
                <div id="tab-tahfizh" class="tab-content hidden">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col"><h3 class="font-bold text-orange-600 text-lg">üìö Halaman Terbanyak</h3><div id="stats-tahfizh-terbanyak-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terbanyak" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-orange-600 hover:underline">Lihat semua...</button></div>
                        <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col"><h3 class="font-bold text-amber-600 text-lg">üèÉ‚Äç‚ôÇÔ∏è Paling Rajin</h3><div id="stats-tahfizh-terrajin-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terrajin" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-amber-600 hover:underline">Lihat semua...</button></div>
                        <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col"><h3 class="font-bold text-red-600 text-lg">‚≠ê Kualitas Terbaik</h3><div id="stats-tahfizh-kualitas-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="kualitas" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-red-600 hover:underline">Lihat semua...</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="leaderboardModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[80vh] flex flex-col relative z-50">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-bold"></h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalBody" class="p-5 overflow-y-auto">
                <!-- Peringkat akan diisi di sini -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="flex items-center gap-3 bg-gray-900 text-white text-sm font-semibold py-3 px-5 rounded-lg shadow-2xl">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span id="toast-message"></span>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA SOURCE ---
        const rawData = {
            "Andi Aqillah Fadia Haswat": [{"id":1,"nama":"Adelio Daffa Syahrizha","kelas":"2A","program":"Unggulan"},{"id":2,"nama":"Ahmad Ahsanur Rizqi","kelas":"2A","program":"Unggulan"},{"id":3,"nama":"Arkana El Sabilly","kelas":"2A","program":"Unggulan"},{"id":4,"nama":"Athaya Auza'I Mubarak","kelas":"2A","program":"Unggulan"},{"id":5,"nama":"Dama Arza Evannova","kelas":"2A","program":"Unggulan"},{"id":6,"nama":"Danar Nizam Daniswara","kelas":"2A","program":"Unggulan"},{"id":7,"nama":"Devgan Jadid Sahlvatico","kelas":"2A","program":"Unggulan"},{"id":8,"nama":"Fariq Imtiyas Aufaa Kamil","kelas":"2A","program":"Unggulan"},{"id":9,"nama":"Firaas Izzulhaq","kelas":"2A","program":"Unggulan"},{"id":10,"nama":"Gilang Omar F","kelas":"2A","program":"Unggulan"},{"id":11,"nama":"Jaladri Arif Wirasena","kelas":"2A","program":"Unggulan"},{"id":12,"nama":"Kemal Mubarak Siregar","kelas":"2A","program":"Unggulan"},{"id":13,"nama":"Khairil Nizam","kelas":"2A","program":"Unggulan"},{"id":14,"nama":"Mirza Nasyath Ahza Attaillah","kelas":"2A","program":"Unggulan"},{"id":15,"nama":"Muhammad Farros Linggar Cahyono","kelas":"2A","program":"Unggulan"},{"id":16,"nama":"Muhammad Fathir Alfalah","kelas":"2A","program":"Unggulan"},{"id":17,"nama":"Narendra Wibawa","kelas":"2A","program":"Unggulan"},{"id":18,"nama":"Naufal Zhafran Purnama","kelas":"2A","program":"Unggulan"},{"id":19,"nama":"Ahmad Arkan Sya'Bani","kelas":"2A","program":"Tahfizh"},{"id":20,"nama":"Ahmad Darwis","kelas":"2A","program":"Tahfizh"},{"id":21,"nama":"Ahmad Ghozi El Muntazhor","kelas":"2A","program":"Tahfizh"},{"id":22,"nama":"Aldan 'Izzul Islam","kelas":"2A","program":"Tahfizh"},{"id":23,"nama":"Fawwaz Elfareza Zuhri","kelas":"2A","program":"Tahfizh"},{"id":24,"nama":"M. Fathan Alfarisi Harahap","kelas":"2A","program":"Tahfizh"},{"id":25,"nama":"Muhammad Ahsani Taqwim","kelas":"2A","program":"Tahfizh"},{"id":26,"nama":"Muhammad Ayyub Al Fatih","kelas":"2A","program":"Tahfizh"},{"id":27,"nama":"Muhammad Gibran Rafassya","kelas":"2A","program":"Tahfizh"},{"id":28,"nama":"Narendra Gerrardi Kusumah","kelas":"2A","program":"Tahfizh"},{"id":29,"nama":"Rijal Abdul A'Ziz","kelas":"2A","program":"Tahfizh"},{"id":30,"nama":"Rizki Chandra Dewantara","kelas":"2A","program":"Tahfizh"}],
            "Abdullah": [{"id":31,"nama":"Alano Faaiq Alfeno","kelas":"2B","program":"Unggulan"},{"id":32,"nama":"Arfandhika Fakhrul Islam","kelas":"2B","program":"Unggulan"},{"id":33,"nama":"Aydin Rafif","kelas":"2B","program":"Unggulan"},{"id":34,"nama":"Danish Alzahid Dinasti","kelas":"2B","program":"Unggulan"},{"id":35,"nama":"Ghani Arif Witjaksono","kelas":"2B","program":"Unggulan"},{"id":36,"nama":"Haidarrafid Satriaa Ardhani","kelas":"2B","program":"Unggulan"},{"id":37,"nama":"Iqbal Zulfikar Al Hanif","kelas":"2B","program":"Unggulan"},{"id":38,"nama":"Jangky Dausat","kelas":"2B","program":"Unggulan"},{"id":39,"nama":"Kumara Banyu Argani","kelas":"2B","program":"Unggulan"},{"id":40,"nama":"M. Dede Afkar","kelas":"2B","program":"Unggulan"},{"id":41,"nama":"Mekha Ilham Lutfianto","kelas":"2B","program":"Unggulan"},{"id":42,"nama":"Muhammad Aiman Naim","kelas":"2B","program":"Unggulan"},{"id":43,"nama":"Muhammad Karel Ashiddiq","kelas":"2B","program":"Unggulan"},{"id":44,"nama":"Naufal Fahmi Darsono","kelas":"2B","program":"Unggulan"},{"id":45,"nama":"Nazhif Fahreza Zuhairy","kelas":"2B","program":"Unggulan"},{"id":46,"nama":"Rais Abqari Ash Shidqi","kelas":"2B","program":"Unggulan"},{"id":47,"nama":"William Ramadhan Al Ghazali","kelas":"2B","program":"Unggulan"},{"id":48,"nama":"Zia El Ibrahim Aqeela Putra Wijaya","kelas":"2B","program":"Unggulan"},{"id":49,"nama":"Ahmad Miqdad","kelas":"2B","program":"Tahfizh"},{"id":50,"nama":"Dzaky Salman Al Farisi","kelas":"2B","program":"Tahfizh"},{"id":51,"nama":"Muhammad Alvi Mumtaz Brillian Hafizh","kelas":"2B","program":"Tahfizh"},{"id":52,"nama":"Muhammad Mahdi Hafidz","kelas":"2B","program":"Tahfizh"},{"id":53,"nama":"Muhammad Naufal Rasyid Arafi","kelas":"2B","program":"Tahfizh"},{"id":54,"nama":"Nahsif Ilman Hazim Purwono","kelas":"2B","program":"Tahfizh"},{"id":55,"nama":"Nawwaf Bahy Rafif","kelas":"2B","program":"Tahfizh"},{"id":56,"nama":"Nizar Adhyatma Aryanda","kelas":"2B","program":"Tahfizh"},{"id":57,"nama":"Rafa Agitananda Az Zayyan","kelas":"2B","program":"Tahfizh"},{"id":58,"nama":"Rafa Faeyza Fa'Iz","kelas":"2B","program":"Tahfizh"},{"id":59,"nama":"Rizqi Satria Putra Surya","kelas":"2B","program":"Tahfizh"},{"id":60,"nama":"Umar Ubaidillah Tsaqif","kelas":"2B","program":"Tahfizh"},{"id":61,"nama":"Wildan Faiz Mahendra","kelas":"2B","program":"Tahfizh"}],
            "Muhammad Zhafir Setiaji": [{"id":62,"nama":"Faiq Fauzil Adhim","kelas":"2C","program":"Tahfizh"},{"id":63,"nama":"Fairuz Azzam Mahfuzh","kelas":"2C","program":"Tahfizh"},{"id":64,"nama":"Muhammad Arkhan Attaqi","kelas":"2C","program":"Tahfizh"},{"id":65,"nama":"Muhammad Daffa Naufal Alaika","kelas":"2C","program":"Tahfizh"},{"id":66,"nama":"Muzakki Fairuzzaman","kelas":"2C","program":"Tahfizh"},{"id":67,"nama":"Neymar Tsaqif Hikmatyar","kelas":"2C","program":"Tahfizh"},{"id":68,"nama":"Rifqi Maliki","kelas":"2C","program":"Tahfizh"},{"id":69,"nama":"Yasykur Slamer'Abqariy","kelas":"2C","program":"Tahfizh"},{"id":70,"nama":"Zhafran Dhiaurrahman Hakim","kelas":"2C","program":"Tahfizh"},{"id":71,"nama":"Achmad Adi Darwis Elfaza","kelas":"2D","program":"Tahfizh"},{"id":72,"nama":"Galang Afkar Artyanto","kelas":"2D","program":"Tahfizh"},{"id":73,"nama":"Gilang Asytar Artyanto","kelas":"2D","program":"Tahfizh"},{"id":74,"nama":"Muhammad Alif Al-Fatih","kelas":"2D","program":"Tahfizh"},{"id":75,"nama":"Muhammad Faiz Ibnu Zakaria","kelas":"2D","program":"Tahfizh"},{"id":76,"nama":"Muhammad Mahdi Hanafi","kelas":"2D","program":"Tahfizh"},{"id":77,"nama":"Muhammad Muhdi Hafidz","kelas":"2D","program":"Tahfizh"},{"id":78,"nama":"Rizqi Ahmad Altaf Zafar","kelas":"2D","program":"Tahfizh"},{"id":79,"nama":"Dzaky Anthony Akbar","kelas":"2G","program":"Tahfizh"},{"id":80,"nama":"Muwafaqi Amru Ahmad","kelas":"2G","program":"Tahfizh"},{"id":81,"nama":"Abdul Ghani Irfan Rafif","kelas":"2H","program":"Tahfizh"},{"id":82,"nama":"Abid Fadhil Abiyah","kelas":"2H","program":"Tahfizh"},{"id":83,"nama":"Ahmad Dahlan Asy'Ari","kelas":"2H","program":"Tahfizh"},{"id":84,"nama":"Athallah Azmi Ghaisan Muhammad","kelas":"2H","program":"Tahfizh"},{"id":85,"nama":"Azmi Zulfadli Syafiq","kelas":"2H","program":"Tahfizh"},{"id":86,"nama":"Azri Labibul Khawarizmi","kelas":"2H","program":"Tahfizh"},{"id":87,"nama":"Dzar Al Ghifari","kelas":"2H","program":"Tahfizh"},{"id":88,"nama":"Fatihan Al Ghifari","kelas":"2H","program":"Tahfizh"},{"id":89,"nama":"Hisyam Nabil Pasha","kelas":"2H","program":"Tahfizh"},{"id":90,"nama":"Ibadillah Kaiazmi Mubarak","kelas":"2H","program":"Tahfizh"},{"id":91,"nama":"Kashvi Jabbar Azana","kelas":"2H","program":"Tahfizh"},{"id":92,"nama":"Khawarizmi Fakhrulhaq","kelas":"2H","program":"Tahfizh"},{"id":93,"nama":"Muh. Naufal Alif","kelas":"2H","program":"Tahfizh"},{"id":94,"nama":"Muhammad Aghna Ilman Rafa","kelas":"2H","program":"Tahfizh"},{"id":95,"nama":"Royyan Abdurrahman Ibtisam","kelas":"2H","program":"Tahfizh"},{"id":96,"nama":"Sakhi Arkan Elfariza","kelas":"2H","program":"Tahfizh"}]
        };
        
        const surahData = {
            '30': ["An-Naba'", "An-Nazi'at", "Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Insyiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghasyiyah", "Al-Fajr", "Al-Balad", "Asy-Syams", "Al-Lail", "Ad-Dhuha", "Asy-Syarh", "At-Tin", "Al-‚ÄòAlaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-‚ÄòAdiyat", "Al-Qari'ah", "At-Takasur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraisy", "Al-Ma'un", "Al-Kausar", "Al-Kafirun", "An-Nasr", "Al-Lahab", "Al-Ikhlas", "Al-Falaq", "An-Nas"],
            '29': ["Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzammil", "Al-Muddatstsir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat"],
            '28': ["Al-Mujadilah", "Al-Hasyr", "Al-Mumtahanah", "As-Shaff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "Ath-Thalaq", "At-Tahrim"]
        };
        
        const surahPageValues = {
            "An-Naba'": 1.5, "An-Nazi'at": 1.5, "Abasa": 1.0, "At-Takwir": 0.8, "Al-Infitar": 0.5, "Al-Mutaffifin": 1.0, "Al-Insyiqaq": 0.7, "Al-Buruj": 0.6, "At-Tariq": 0.4, "Al-A'la": 0.5, "Al-Ghasyiyah": 0.7, "Al-Fajr": 0.8, "Al-Balad": 0.5, "Asy-Syams": 0.4, "Al-Lail": 0.5, "Ad-Dhuha": 0.3, "Asy-Syarh": 0.2, "At-Tin": 0.2, "Al-‚ÄòAlaq": 0.5, "Al-Qadr": 0.2, "Al-Bayyinah": 0.3, "Az-Zalzalah": 0.2, "Al-‚ÄòAdiyat": 0.3, "Al-Qari'ah": 0.3, "At-Takasur": 0.2, "Al-Asr": 0.1, "Al-Humazah": 0.2, "Al-Fil": 0.2, "Quraisy": 0.1, "Al-Ma'un": 0.2, "Al-Kausar": 0.1, "Al-Kafirun": 0.2, "An-Nasr": 0.1, "Al-Lahab": 0.1, "Al-Ikhlas": 0.1, "Al-Falaq": 0.1, "An-Nas": 0.2,
            "Al-Mulk": 2.0, "Al-Qalam": 2.0, "Al-Haqqah": 1.8, "Al-Ma'arij": 1.5, "Nuh": 1.0, "Al-Jinn": 1.0, "Al-Muzammil": 0.8, "Al-Muddatstsir": 1.5, "Al-Qiyamah": 1.0, "Al-Insan": 1.0, "Al-Mursalat": 1.5,
            "Al-Mujadilah": 2.5, "Al-Hasyr": 2.5, "Al-Mumtahanah": 1.5, "As-Shaff": 1.0, "Al-Jumu'ah": 1.0, "Al-Munafiqun": 1.0, "At-Taghabun": 1.5, "Ath-Thalaq": 1.2, "At-Tahrim": 1.2
        };

        // --- DOM ELEMENTS ---
        const form = document.getElementById('setoranForm');
        const tanggalInput = document.getElementById('tanggal');
        const nowBtn = document.getElementById('nowBtn');
        const musyrifSelect = document.getElementById('musyrif');
        const santriSelect = document.getElementById('namaSantri');
        const kelasInput = document.getElementById('kelas');
        const programInput = document.getElementById('program');
        const jenisSelect = document.getElementById('jenis');
        const juzSelect = document.getElementById('juz');
        const halamanContainer = document.getElementById('halaman-container');
        const halamanInput = document.getElementById('halaman');
        const suratContainer = document.getElementById('surat-container');
        const suratSelect = document.getElementById('surat');
        const tableBody = document.getElementById('setoranTableBody');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const modal = document.getElementById('leaderboardModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalBackdrop = document.querySelector('.modal-backdrop');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // --- APP STATE ---
        let allSetoran = [];
        let santriData = [];
        let fullLeaderboards = { 
            unggulan: { terbanyak: [], terrajin: [], kualitas: [] },
            tahfizh: { terbanyak: [], terrajin: [], kualitas: [] }
        };

        // --- DATA INITIALIZATION ---
        function initializeData() {
            santriData = [];
            for (const musyrif in rawData) {
                rawData[musyrif].forEach(santri => {
                    santriData.push({
                        ...santri,
                        musyrif: musyrif,
                        setoranMutqin: new Set() // Gunakan Set untuk efisiensi
                    });
                });
            }
        }

        // --- HELPER FUNCTIONS ---
        function setCurrentDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            tanggalInput.value = now.toISOString().slice(0, 16);
        }

        function findSantriById(id) {
            return santriData.find(s => s.id == id);
        }

        function showToast(message) {
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function getKualitasBadge(kualitas) {
            switch(kualitas) {
                case 'Mumtaz': return 'bg-green-100 text-green-800';
                case 'Jayyid Jiddan': return 'bg-blue-100 text-blue-800';
                case 'Jayyid': return 'bg-yellow-100 text-yellow-800';
                case 'Maqbul': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // --- FORM LOGIC ---
        function populateMusyrif() {
            const musyrifKeys = Object.keys(rawData);
            musyrifSelect.innerHTML = '<option value="">Pilih Musyrif</option>';
            musyrifKeys.sort().forEach(musyrif => {
                musyrifSelect.add(new Option(musyrif, musyrif));
            });
        }

        function handleMusyrifChange() {
            const selectedMusyrif = musyrifSelect.value;
            santriSelect.innerHTML = '<option value="">Pilih Santri</option>';
            resetSantriFields();

            if (selectedMusyrif) {
                santriSelect.disabled = false;
                const filteredSantri = santriData
                    .filter(s => s.musyrif === selectedMusyrif)
                    .sort((a, b) => a.nama.localeCompare(b.nama));
                
                filteredSantri.forEach(santri => {
                    santriSelect.add(new Option(santri.nama, santri.id));
                });
            } else {
                santriSelect.disabled = true;
                santriSelect.innerHTML = '<option value="">Pilih Musyrif dahulu</option>';
            }
        }
        
        function handleSantriChange() {
            const santriId = santriSelect.value;
            resetSantriFields(true);
            const santri = findSantriById(santriId);
            
            if (santri) {
                kelasInput.value = santri.kelas;
                programInput.value = santri.program;
                updateJenisOptions(santri);
            }
        }
        
        function updateJenisOptions(santri) {
            jenisSelect.disabled = false;
            jenisSelect.innerHTML = '<option value="">Pilih Jenis</option>';
            
            const hasCompletedBasicMutqin = santri.setoranMutqin.has(29) && santri.setoranMutqin.has(30);

            // Semua program bisa Ziyadah, namun bersyarat untuk Tahfizh
            if (santri.program === "Unggulan" || (santri.program === "Tahfizh" && hasCompletedBasicMutqin)) {
                 jenisSelect.add(new Option("Ziyadah", "Ziyadah"));
            }
            
            // Opsi Mutqin
            jenisSelect.add(new Option("Mutqin", "Mutqin"));

            // Tambahkan opsi Ziyadah yang disabled untuk Tahfizh jika belum selesai prasyarat
            if (santri.program === "Tahfizh" && !hasCompletedBasicMutqin) {
                const ziyadahOption = new Option("Ziyadah (selesaikan Mutqin 29 & 30 dulu)", "Ziyadah_disabled");
                ziyadahOption.disabled = true;
                jenisSelect.add(ziyadahOption);
            }
        }

        function handleJenisChange() {
            const jenis = jenisSelect.value;
            const santri = findSantriById(santriSelect.value);

            juzSelect.innerHTML = '<option value="">Pilih Juz</option>';
            juzSelect.disabled = true;
            resetSetoranInputs();

            if (!jenis || !santri) return;

            juzSelect.disabled = false;
            
            if (jenis === "Mutqin") {
                // Untuk semua program, tawarkan juz 1-30 yang belum disetor untuk Mutqin.
                for (let i = 1; i <= 30; i++) {
                    if (!santri.setoranMutqin.has(i)) {
                        juzSelect.add(new Option(`Juz ${i}`, i));
                    }
                }
            } else if (jenis === "Ziyadah") {
                // Logika Ziyadah tetap sama
                for (let i = 1; i <= 30; i++) {
                    juzSelect.add(new Option(`Juz ${i}`, i));
                }
            }
            handleJuzChange(); // Trigger update
        }

        function handleJuzChange() {
            const jenis = jenisSelect.value;
            const juz = parseInt(juzSelect.value);

            resetSetoranInputs();

            if (jenis === 'Ziyadah') {
                if ([28, 29, 30].includes(juz)) {
                    // Ziyadah juz pendek -> by surat (dropdown)
                    suratContainer.classList.remove('hidden');
                    suratSelect.required = true;
                    populateSurat(juz);
                } else {
                    // Ziyadah juz panjang -> by halaman
                    halamanContainer.classList.remove('hidden');
                    halamanInput.required = true;
                    halamanInput.disabled = false;
                }
            } else if (jenis === 'Mutqin') {
                 // Mutqin -> by halaman (bisa 1 juz penuh)
                halamanContainer.classList.remove('hidden');
                halamanInput.required = false; // Tidak wajib jika setor 1 juz
                halamanInput.disabled = false;
                halamanInput.placeholder = 'Min 5 hlm / Kosongkan utk 1 Juz';
                halamanInput.min = 5;
            }
        }

        function populateSurat(juz) {
            suratSelect.innerHTML = '<option value="">Pilih Surat</option>';
            const surahs = surahData[juz] || [];
            surahs.forEach(surah => {
                suratSelect.add(new Option(surah, surah));
            });
        }
        
        // --- FORM & STATE RESET ---
        function resetSantriFields(keepStatic = false) {
             if (!keepStatic) {
                kelasInput.value = '';
                programInput.value = '';
             }
            jenisSelect.innerHTML = '<option value="">Pilih Santri dahulu</option>';
            jenisSelect.disabled = true;
            juzSelect.innerHTML = '<option value="">Pilih Jenis dahulu</option>';
            juzSelect.disabled = true;
            resetSetoranInputs();
        }

        function resetSetoranInputs() {
            halamanContainer.classList.add('hidden');
            suratContainer.classList.add('hidden');
            halamanInput.disabled = true;
            halamanInput.required = false;
            halamanInput.value = '';
            halamanInput.placeholder = '';
            halamanInput.min = 1;
            suratSelect.required = false;
            suratSelect.innerHTML = '';
        }

        function resetFormState() {
            form.reset();
            setCurrentDateTime();
            musyrifSelect.value = "";
            santriSelect.innerHTML = '<option value="">Pilih Musyrif dahulu</option>';
            santriSelect.disabled = true;
            kelasInput.value = '';
            programInput.value = '';
            resetSantriFields();
        }

        // --- RENDER & STATS ---
        function renderTable() {
            tableBody.innerHTML = '';
            if (allSetoran.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-gray-500">Belum ada data setoran.</td></tr>';
                 return;
            }

            const sortedSetoran = [...allSetoran].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            sortedSetoran.forEach((setoran, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors fade-in';
                if (index === 0) {
                    row.classList.add('highlight-new-row');
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${new Date(setoran.tanggal).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${setoran.namaSantri}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${setoran.musyrif}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${setoran.program}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${setoran.jenis}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${setoran.juz}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${setoran.setoranUnit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getKualitasBadge(setoran.kualitas)}">${setoran.kualitas}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function calculateAndDisplayStats() {
            const stats = { unggulan: {}, tahfizh: {} };
            const kualitasMap = { 'Mumtaz': 4, 'Jayyid Jiddan': 3, 'Jayyid': 2, 'Maqbul': 1 };

            allSetoran.forEach(s => {
                const programKey = s.program.toLowerCase();
                if (!stats[programKey]) return;

                if (!stats[programKey][s.namaSantri]) {
                    stats[programKey][s.namaSantri] = { nama: s.namaSantri, totalHalaman: 0, frekuensi: 0, totalKualitas: 0 };
                }
                
                let halaman = 0;
                if (s.setoranUnit === '1 Juz') {
                    halaman = 20;
                } else if (s.setoranUnit.includes('halaman')) {
                    halaman = parseFloat(s.setoranUnit) || 0;
                } else {
                    // Ini menangani setoran per surat
                    halaman += surahPageValues[s.setoranUnit] || 0;
                }
                
                stats[programKey][s.namaSantri].totalHalaman += halaman;
                stats[programKey][s.namaSantri].frekuensi += 1;
                stats[programKey][s.namaSantri].totalKualitas += kualitasMap[s.kualitas] || 0;
            });
            
            ['unggulan', 'tahfizh'].forEach(programKey => {
                const statsArray = Object.values(stats[programKey]);
                fullLeaderboards[programKey].terbanyak = [...statsArray].sort((a, b) => b.totalHalaman - a.totalHalaman);
                fullLeaderboards[programKey].terrajin = [...statsArray].sort((a, b) => b.frekuensi - a.frekuensi);
                fullLeaderboards[programKey].kualitas = [...statsArray]
                    .filter(a => a.frekuensi > 0) // Hindari pembagian dengan nol
                    .sort((a, b) => (b.totalKualitas / b.frekuensi) - (a.totalKualitas / a.frekuensi));
                
                displayLeaderboard(programKey, 'terbanyak', fullLeaderboards[programKey].terbanyak.slice(0, 5));
                displayLeaderboard(programKey, 'terrajin', fullLeaderboards[programKey].terrajin.slice(0, 5));
                displayLeaderboard(programKey, 'kualitas', fullLeaderboards[programKey].kualitas.slice(0, 5));
            });
        }

        function displayLeaderboard(program, category, data) {
            const listEl = document.getElementById(`stats-${program}-${category}-list`);
            listEl.innerHTML = '';
            if (data.length === 0) {
                listEl.innerHTML = '<p class="text-sm text-gray-500">Belum ada data.</p>';
                return;
            }
            const emojiMap = {1: 'ü•á', 2: 'ü•à', 3: 'ü•â'};

            data.forEach((item, index) => {
                const rank = index + 1;
                const emoji = emojiMap[rank] || `<span class="font-normal text-gray-400">${rank}.</span>`;
                let valueText = '';
                if (category === 'terbanyak') valueText = `${item.totalHalaman.toFixed(1)} hlm`;
                else if (category === 'terrajin') valueText = `${item.frekuensi}x setor`;
                else if (category === 'kualitas') valueText = `Avg: ${(item.totalKualitas / item.frekuensi).toFixed(2)}`;
                
                const itemEl = document.createElement('div');
                itemEl.className = 'text-sm flex justify-between items-center';
                itemEl.innerHTML = `
                    <span class="font-semibold text-gray-700 truncate"><span class="mr-2 w-6 inline-block">${emoji}</span>${item.nama}</span>
                    <span class="text-gray-500 font-medium">${valueText}</span>
                `;
                listEl.appendChild(itemEl);
            });
        }
        
        // --- MODAL ---
        function openModal(program, category) {
            const titles = {
                terbanyak: 'üìö Peringkat Halaman Terbanyak',
                terrajin: 'üèÉ‚Äç‚ôÇÔ∏è Peringkat Paling Rajin',
                kualitas: '‚≠ê Peringkat Kualitas Terbaik'
            };
            modalTitle.textContent = `${titles[category]} (${program.charAt(0).toUpperCase() + program.slice(1)})`;
            
            const fullData = fullLeaderboards[program][category];
            modalBody.innerHTML = '';
            
            if (fullData.length === 0) {
                modalBody.innerHTML = '<p class="text-center text-gray-500">Tidak ada data untuk ditampilkan.</p>';
            } else {
                const listContainer = document.createElement('ol');
                listContainer.className = 'space-y-3';
                fullData.forEach((item, index) => {
                    let valueText = '';
                    if (category === 'terbanyak') valueText = `${item.totalHalaman.toFixed(1)} halaman`;
                    else if (category === 'terrajin') valueText = `${item.frekuensi} setoran`;
                    else if (category === 'kualitas') valueText = `Rata-rata: ${(item.totalKualitas / item.frekuensi).toFixed(2)}`;

                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between text-gray-700 pb-2 border-b border-gray-100';
                    listItem.innerHTML = `
                        <div>
                            <span class="font-bold mr-3 w-6 inline-block text-center">${index + 1}.</span>
                            <span>${item.nama}</span>
                        </div>
                        <span class="font-semibold text-gray-600">${valueText}</span>
                    `;
                    listContainer.appendChild(listItem);
                });
                modalBody.appendChild(listContainer);
            }
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        // --- FORM SUBMISSION ---
        function handleFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(form);
            const setoranData = Object.fromEntries(formData.entries());
            
            const santri = findSantriById(setoranData.namaSantri);
            if (!santri) {
                showToast('Error: Santri tidak ditemukan!');
                return;
            }

            // Lengkapi data setoran
            setoranData.namaSantri = santri.nama;
            setoranData.musyrif = santri.musyrif;
            setoranData.program = santri.program;
            setoranData.id = Date.now(); // ID unik untuk setiap setoran

            // Tentukan unit setoran
            const juz = parseInt(setoranData.juz);
            if (setoranData.jenis === 'Ziyadah' && [28, 29, 30].includes(juz)) {
                if(!setoranData.surat || setoranData.surat === '') {
                    showToast('Error: Silakan pilih surat.');
                    return;
                }
                setoranData.setoranUnit = setoranData.surat;
            } else if (setoranData.jenis === 'Mutqin' && !setoranData.halaman) {
                setoranData.setoranUnit = '1 Juz';
            } else {
                if (!setoranData.halaman) {
                    showToast('Error: Jumlah halaman harus diisi.');
                    return;
                }
                setoranData.setoranUnit = `${setoranData.halaman} halaman`;
            }

            allSetoran.push(setoranData);

            // Update status Mutqin santri jika perlu (hanya jika setor 1 juz penuh)
            if (setoranData.jenis === 'Mutqin' && !setoranData.halaman) {
                santri.setoranMutqin.add(parseInt(setoranData.juz));
            }

            renderTable();
            calculateAndDisplayStats();
            showToast('Setoran berhasil disimpan!');
            resetFormState();
        }

        // --- EVENT LISTENERS ---
        nowBtn.addEventListener('click', setCurrentDateTime);
        musyrifSelect.addEventListener('change', handleMusyrifChange);
        santriSelect.addEventListener('change', handleSantriChange);
        jenisSelect.addEventListener('change', handleJenisChange);
        juzSelect.addEventListener('change', handleJuzChange);
        form.addEventListener('submit', handleFormSubmit);
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`tab-${button.dataset.tab}`).classList.remove('hidden');
            });
        });

        document.querySelectorAll('.see-all-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const { category, program } = e.target.dataset;
                openModal(program, category);
            });
        });

        closeModalBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);

        // --- INITIALIZATION ---
        function init() {
            initializeData();
            setCurrentDateTime();
            populateMusyrif();
            renderTable();
            calculateAndDisplayStats();
            resetFormState();
        }

        init();
    });
    </script>
</body>
</html>
