<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setor.in - Aplikasi Setoran Hafalan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(to right top, #d1d5db, #e5e7eb, #f3f4f6, #f9fafb, #ffffff);
            background-attachment: fixed;
        }
        .table-container { max-height: 500px; overflow-y: auto; }
        .page-content.hidden, .skeleton-container.hidden { display: none; }
        
        /* Glassmorphism Styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-color: rgba(255, 255, 255, 0.4) !important;
        }
        
        .glass-input {
            background-color: rgba(255, 255, 255, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
        }
        .glass-input:focus {
             background-color: rgba(255, 255, 255, 0.6) !important;
        }
        .glass-input::placeholder {
            color: #6b7280;
        }
        
        .glass-modal-content {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Animasi */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes highlight { from { background-color: rgba(254, 243, 199, 0.5); } to { background-color: transparent; } }
        .highlight-new-row { animation: highlight 2s ease-out forwards; }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton {
            background-color: #e2e8f0;
            background-image: linear-gradient(90deg, #e2e8f0, #f1f5f9, #e2e8f0);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        /* Transisi UI */
        #toast { transition: transform 0.5s ease, opacity 0.5s ease; opacity: 0; transform: translate(-50%, 100px); }
        #toast.show { opacity: 1; transform: translate(-50%, 0); }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal.hidden .modal-content { opacity: 0; transform: translateY(-20px); }
        /* Gaya Tab & Navigasi Aktif */
        .tab-btn, .rekap-tab-btn { transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .tab-btn.active, .rekap-tab-btn.active { border-color: #f59e0b; color: #b45309; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active, .nav-link.active svg { color: #f59e0b; }
        .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07); }
    </style>
</head>
<body class="text-gray-900">

    <div class="sm:flex">
        <!-- Menu Navigasi -->
        <nav class="fixed bottom-0 left-0 w-full border-t sm:relative sm:w-64 sm:h-screen sm:border-r sm:border-t-0 z-20 glass-nav">
            <div class="flex sm:flex-col sm:py-4 sm:px-3 h-full">
                <div class="hidden sm:flex items-center gap-3 p-3 mb-4">
                    <div class="bg-amber-500 p-2 rounded-lg text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></div>
                    <span class="font-bold text-lg text-gray-900">Setor.in</span>
                </div>
                <div id="main-nav" class="flex sm:flex-col w-full">
                    <a href="#" data-page="page-beranda" class="nav-link active flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                        <span class="text-xs sm:text-sm">Beranda</span>
                    </a>
                    <a href="#" data-page="page-form" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span class="text-xs sm:text-sm">Formulir</span></a>
                    <a href="#" data-page="page-riwayat" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg><span class="text-xs sm:text-sm">Riwayat</span></a>
                    <a href="#" data-page="page-rekap" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-700 hover:text-amber-600 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="text-xs sm:text-sm">Rekap</span></a>
                </div>
            </div>
        </nav>

        <!-- Konten Utama -->
        <main id="main-content" class="flex-1 pb-20 sm:pb-0 overflow-y-auto">
            <div id="page-beranda" class="page-content p-4 sm:p-6 lg:p-8">
                <div class="max-w-7xl mx-auto space-y-8">
                    <!-- Welcome Section -->
                    <header class="text-center py-12 sm:py-16 fade-in">
                        <div class="mx-auto mb-6 w-16 h-16 rounded-2xl bg-amber-500 text-white flex items-center justify-center text-3xl shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                        </div>
                        <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight text-gray-900">Selamat Datang di Setor.in</h1>
                        <p class="mt-4 text-base sm:text-lg text-gray-700 max-w-2xl mx-auto">Dasbor utama untuk memantau seluruh aktivitas setoran hafalan.</p>
                    </header>

                    <!-- Statistik (Cards) -->
                    <section id="statistik-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 fade-in" style="animation-delay: 100ms;">
                        <div class="p-5 rounded-xl flex items-center gap-4 glass-card">
                            <div class="bg-blue-100 text-blue-600 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                            <div>
                                <p class="text-sm text-gray-800">Total Setoran</p>
                                <p id="stats-total-setoran" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                         <div class="p-5 rounded-xl flex items-center gap-4 glass-card">
                            <div class="bg-green-100 text-green-600 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div>
                            <div>
                                <p class="text-sm text-gray-800">Santri Aktif</p>
                                <p id="stats-santri-aktif" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                        <div class="p-5 rounded-xl flex items-center gap-4 glass-card">
                            <div class="bg-amber-100 text-amber-600 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" /></svg></div>
                            <div>
                                <p class="text-sm text-gray-800">Total Halaman</p>
                                <p id="stats-total-halaman" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                         <div class="p-5 rounded-xl flex items-center gap-4 glass-card">
                            <div class="bg-red-100 text-red-600 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></div>
                            <div>
                                <p class="text-sm text-gray-800">Peringkat Teratas</p>
                                <p id="stats-peringkat-teratas" class="text-base font-bold text-gray-900 truncate">-</p>
                            </div>
                        </div>
                    </section>

                    <!-- Akses Cepat -->
                    <section id="akses-cepat-section" class="fade-in" style="animation-delay: 200ms;">
                         <h3 class="text-xl font-bold text-gray-900 mb-4">Akses Cepat</h3>
                         <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                             <button data-target-page="page-form" class="quick-access-btn flex flex-col items-center justify-center p-4 rounded-xl card-hover text-amber-700 glass-card"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span class="text-sm font-semibold">Input Setoran</span></button>
                             <button data-target-page="page-riwayat" class="quick-access-btn flex flex-col items-center justify-center p-4 rounded-xl card-hover text-blue-700 glass-card"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg><span class="text-sm font-semibold">Lihat Riwayat</span></button>
                             <button data-target-page="page-rekap" class="quick-access-btn flex flex-col items-center justify-center p-4 rounded-xl card-hover text-green-700 glass-card"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="text-sm font-semibold">Buka Rekap</span></button>
                             <button id="refresh-data-btn" class="flex flex-col items-center justify-center p-4 rounded-xl card-hover text-gray-700 glass-card"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5" /></svg><span class="text-sm font-semibold">Refresh Data</span></button>
                         </div>
                    </section>
                    
                    <!-- Papan Peringkat -->
                    <section id="peringkat-section" class="fade-in" style="animation-delay: 300ms;">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Papan Peringkat</h3>
                        <div id="content-peringkat" class="glass-card p-5 rounded-xl">
                            <div class="border-b border-white/30"><nav id="leaderboard-tabs" class="-mb-px flex justify-center space-x-6"><button data-tab="tahfizh" class="tab-btn active whitespace-nowrap py-4 px-1 text-base font-medium text-gray-700">Tahfizh</button><button data-tab="unggulan" class="tab-btn whitespace-nowrap py-4 px-1 text-base font-medium text-gray-700">Unggulan</button></nav></div>
                            <div id="leaderboard-content-container" class="mt-6">
                                <div id="tab-tahfizh" class="tab-content grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-amber-800 text-lg">üìö Halaman Terbanyak</h3><div id="stats-tahfizh-terbanyak-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terbanyak" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-amber-700 hover:underline">Lihat semua...</button></div>
                                    <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-orange-800 text-lg">üèÉ‚Äç‚ôÇÔ∏è Paling Rajin</h3><div id="stats-tahfizh-terrajin-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terrajin" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-orange-700 hover:underline">Lihat semua...</button></div>
                                    <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-red-800 text-lg">‚≠ê Kualitas Terbaik</h3><div id="stats-tahfizh-kualitas-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="kualitas" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-red-700 hover:underline">Lihat semua...</button></div>
                                </div>
                                <div id="tab-unggulan" class="tab-content hidden grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-amber-800 text-lg">üìö Halaman Terbanyak</h3><div id="stats-unggulan-terbanyak-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terbanyak" data-program="unggulan" class="see-all-btn mt-4 text-sm text-amber-700 hover:underline">Lihat semua...</button></div>
                                    <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-orange-800 text-lg">üèÉ‚Äç‚ôÇÔ∏è Paling Rajin</h3><div id="stats-unggulan-terrajin-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terrajin" data-program="unggulan" class="see-all-btn mt-4 text-sm text-orange-700 hover:underline">Lihat semua...</button></div>
                                    <div class="p-5 rounded-xl flex flex-col glass-card"><h3 class="font-bold text-red-800 text-lg">‚≠ê Kualitas Terbaik</h3><div id="stats-unggulan-kualitas-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="kualitas" data-program="unggulan" class="see-all-btn mt-4 text-sm text-red-700 hover:underline">Lihat semua...</button></div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Grafik & Aktivitas -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mt-8">
                        <section class="lg:col-span-3 p-5 rounded-xl glass-card fade-in" style="animation-delay: 400ms;">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Grafik Setoran Mingguan</h3>
                            <canvas id="summaryChart"></canvas>
                        </section>
                        <div class="lg:col-span-2 space-y-8">
                             <section id="riwayat-terbaru-section" class="p-5 rounded-xl glass-card fade-in" style="animation-delay: 500ms;">
                                <h3 class="text-xl font-bold text-gray-900 mb-4">Aktivitas Terbaru</h3>
                                <div id="recent-activity-list" class="space-y-3"></div>
                            </section>
                             <section id="pengumuman-section" class="bg-amber-500/30 border-l-4 border-amber-500 text-amber-900 p-4 rounded-r-lg fade-in" style="animation-delay: 600ms;">
                                <h3 class="text-xl font-bold mb-2">Info Penting</h3>
                                <p class="text-sm">Jadwal setoran untuk pekan ini adalah setiap hari setelah salat Subuh dan Ashar. Mohon untuk dipatuhi. Terima kasih.</p>
                            </section>
                        </div>
                    </div>
                     <!-- Footer -->
                    <footer class="text-center text-sm text-gray-700 py-8">
                        Setor.in &copy; 2024 - Dibuat untuk Asrama 1 Abu Bakar Ash-Shiddiq.
                    </footer>
                </div>
            </div>

            <div id="page-form" class="page-content hidden p-4 sm:p-6 lg:p-8">
                 <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8 fade-in">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">üìù Formulir Setoran</h2>
                    <p class="text-gray-700 mt-1">Catat setoran hafalan baru di sini.</p>
                </div>
                
                <form id="setoranForm" class="max-w-2xl mx-auto flex flex-col gap-6">
                    <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 50ms;">
                        <fieldset>
                            <legend class="flex items-center gap-3 text-lg font-semibold text-blue-800 mb-4 border-b border-white/30 pb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Informasi Dasar
                            </legend>
                            <div>
                                <label for="tanggal" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg><span>Tanggal & Waktu</span></label>
                                <input type="datetime-local" id="tanggal" name="tanggal" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required>
                                <div class="text-right mt-2"><button type="button" id="nowBtn" class="text-xs text-amber-700 hover:underline">Gunakan waktu sekarang</button></div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 150ms;">
                        <fieldset>
                             <legend class="flex items-center gap-3 text-lg font-semibold text-green-800 mb-4 border-b border-white/30 pb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                Detail Santri
                            </legend>
                            <div class="flex flex-col gap-5">
                                <div>
                                    <label for="musyrif" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg><span>Musyrif</span></label>
                                    <select id="musyrif" name="musyrif" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required><option value="">Pilih Musyrif</option></select>
                                </div>
                                <div>
                                    <label for="namaSantri" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg><span>Nama Santri</span></label>
                                    <select id="namaSantri" name="namaSantri" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Musyrif dahulu</option></select>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                    <div>
                                        <label for="kelas" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg><span>Kelas</span></label>
                                        <input type="text" id="kelas" name="kelas" class="w-full mt-1 p-3 rounded-lg disabled:bg-gray-200/50 glass-input" readonly disabled>
                                    </div>
                                    <div>
                                        <label for="program" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm2 1v2h6V5H7zm0 4v2h6V9H7zm0 4v2h6v-2H7z" /></svg><span>Program</span></label>
                                        <input type="text" id="program" name="program" class="w-full mt-1 p-3 rounded-lg disabled:bg-gray-200/50 glass-input" readonly disabled>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 250ms;">
                        <fieldset>
                            <legend class="flex items-center gap-3 text-lg font-semibold text-amber-800 mb-4 border-b border-white/30 pb-3">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                Detail Setoran
                            </legend>
                            <div class="flex flex-col gap-5">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                    <div>
                                        <label for="jenis" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg><span>Jenis Setoran</span></label>
                                        <select id="jenis" name="jenis" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Santri dahulu</option></select>
                                    </div>
                                    <div>
                                        <label for="juz" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" /></svg><span>Juz</span></label>
                                        <select id="juz" name="juz" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Jenis dahulu</option></select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                    <div id="halaman-container">
                                        <label for="halaman" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg><span>Halaman</span></label>
                                        <input type="number" id="halaman" name="halaman" min="1" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled>
                                    </div>
                                    <div id="surat-container" class="hidden">
                                        <label for="surat" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804V4.804A7.968 7.968 0 0014.5 4z" /></svg><span>Surat</span></label>
                                        <select id="surat" name="surat" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required></select>
                                    </div>
                                    <div>
                                        <label for="kualitas" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg><span>Kualitas</span></label>
                                        <select id="kualitas" name="kualitas" class="w-full mt-1 p-3 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition-all glass-input" required>
                                            <option value="Mumtaz">Mumtaz</option><option value="Jayyid Jiddan">Jayyid Jiddan</option><option value="Jayyid">Jayyid</option><option value="Maqbul">Maqbul</option><option value="Dhoif">Dhoif</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="mt-2">
                        <button type="submit" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all duration-300">Simpan Setoran</button>
                    </div>
                </form>
            </div>

            <div id="page-riwayat" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900">üìú Riwayat Setoran</h2><p class="text-gray-700 mt-2">Cari dan filter seluruh riwayat setoran yang tercatat.</p></div>
                    
                    <!-- Filter Section -->
                    <div class="p-4 rounded-xl mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end glass-card">
                        <div class="lg:col-span-2">
                            <label for="search-riwayat" class="text-sm font-medium text-gray-800">Cari Nama Santri</label>
                            <input type="search" id="search-riwayat" placeholder="Ketik nama..." class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                        </div>
                        <div>
                             <label for="filter-program" class="text-sm font-medium text-gray-800">Program</label>
                             <select id="filter-program" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                                 <option value="Semua">Semua Program</option>
                                 <option value="Tahfizh">Tahfizh</option>
                                 <option value="Unggulan">Unggulan</option>
                             </select>
                        </div>
                        <div>
                             <label for="filter-tanggal-mulai" class="text-sm font-medium text-gray-800">Dari Tanggal</label>
                             <input type="date" id="filter-tanggal-mulai" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                        </div>
                        <div>
                             <label for="filter-tanggal-akhir" class="text-sm font-medium text-gray-800">Sampai Tanggal</label>
                             <input type="date" id="filter-tanggal-akhir" class="w-full mt-1 p-2 rounded-lg focus:ring-amber-500 focus:border-amber-500 glass-input">
                        </div>
                    </div>


                    <div id="skeleton-riwayat" class="skeleton-container hidden">
                         <div class="rounded-2xl p-4 glass-card">
                            <div class="space-y-4">
                                <div class="h-10 skeleton rounded"></div>
                                <div class="h-10 skeleton rounded"></div>
                                <div class="h-10 skeleton rounded"></div>
                                <div class="h-10 skeleton rounded"></div>
                            </div>
                        </div>
                    </div>
                    <div id="content-riwayat" class="rounded-2xl overflow-hidden glass-card">
                        <div class="table-container">
                            <table class="min-w-full">
                                <thead class="glass-nav border-b border-white/30 sticky top-0 z-10"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Santri</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Detail Setoran</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Kualitas</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider hidden sm:table-cell">Tanggal</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Aksi</th></tr></thead>
                                <tbody id="setoranTableBody" class="divide-y divide-white/20"><tr><td colspan="5" class="text-center p-8 text-gray-700">Belum ada data setoran.</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                     <div id="load-more-container" class="text-center mt-6">
                        <button id="load-more-btn" class="bg-amber-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-amber-600 transition-colors hidden">Muat Lebih Banyak</button>
                    </div>
                </div>
            </div>
            
            <div id="page-rekap" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900">üìä Rekap Setoran Perkelas</h2><p class="text-gray-700 mt-2">Pantau perkembangan setiap kelas dan ekspor laporannya.</p></div>
                    <div id="skeleton-rekap" class="skeleton-container hidden">
                        <div class="rounded-2xl p-4 glass-card">
                            <div class="h-10 w-1/2 skeleton rounded mx-auto mb-4"></div>
                            <div class="h-48 skeleton rounded"></div>
                        </div>
                    </div>
                    <div id="content-rekap" class="rounded-2xl p-5 glass-card">
                        <div class="border-b border-white/30"><nav id="rekap-tabs" class="-mb-px flex justify-center space-x-6"><button data-tab="2A" class="rekap-tab-btn active whitespace-nowrap py-4 px-1 text-base font-medium text-gray-700">Kelas 2A</button><button data-tab="2B" class="rekap-tab-btn whitespace-nowrap py-4 px-1 text-base font-medium text-gray-700">Kelas 2B</button><button data-tab="2CDGH" class="rekap-tab-btn whitespace-nowrap py-4 px-1 text-base font-medium text-gray-700">Kelas 2CDGH</button></nav></div>
                        <div id="rekap-content-container" class="mt-6"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="leaderboardModal" class="modal fixed inset-0 bg-black/30 z-40 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content w-full max-w-md max-h-[80vh] flex flex-col relative z-50 rounded-2xl glass-modal-content">
            <div class="p-5 border-b border-white/30 flex justify-between items-center"><h3 id="modalTitle" class="text-xl font-bold text-gray-900"></h3><button id="closeModalBtn" class="text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button></div>
            <div id="modalBody" class="p-5 overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="confirmDeleteModal" class="modal fixed inset-0 bg-black/30 z-40 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content w-full max-w-sm relative z-50 p-6 text-center rounded-2xl glass-modal-content">
            <h3 class="text-lg font-bold text-gray-900">Hapus Setoran?</h3>
            <p class="text-sm text-gray-800 my-4">Apakah Anda yakin ingin menghapus data setoran ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancelDeleteBtn" class="px-6 py-2 rounded-lg bg-gray-200/50 text-gray-800 font-semibold hover:bg-gray-200/80">Batal</button>
                <button id="confirmDeleteBtn" class="px-6 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 sm:bottom-8 left-1/2 z-50 flex items-center gap-3 bg-gray-900/80 text-white text-sm font-semibold py-3 px-5 rounded-lg border border-gray-700/50 backdrop-blur-sm">
        <svg id="toast-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg>
        <span id="toast-message"></span>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA SOURCE ---
        const rawData = {"Andi Aqillah Fadia Haswat":[{"id":1,"nama":"Adelio Daffa Syahrizha","kelas":"2A","program":"Unggulan"},{"id":2,"nama":"Ahmad Ahsanur Rizqi","kelas":"2A","program":"Unggulan"},{"id":3,"nama":"Arkana El Sabilly","kelas":"2A","program":"Unggulan"},{"id":4,"nama":"Athaya Auza'I Mubarak","kelas":"2A","program":"Unggulan"},{"id":5,"nama":"Dama Arza Evannova","kelas":"2A","program":"Unggulan"},{"id":6,"nama":"Danar Nizam Daniswara","kelas":"2A","program":"Unggulan"},{"id":7,"nama":"Devgan Jadid Sahlvatico","kelas":"2A","program":"Unggulan"},{"id":8,"nama":"Fariq Imtiyas Aufaa Kamil","kelas":"2A","program":"Unggulan"},{"id":9,"nama":"Firaas Izzulhaq","kelas":"2A","program":"Unggulan"},{"id":10,"nama":"Gilang Omar F","kelas":"2A","program":"Unggulan"},{"id":11,"nama":"Jaladri Arif Wirasena","kelas":"2A","program":"Unggulan"},{"id":12,"nama":"Kemal Mubarak Siregar","kelas":"2A","program":"Unggulan"},{"id":13,"nama":"Khairil Nizam","kelas":"2A","program":"Unggulan"},{"id":14,"nama":"Mirza Nasyath Ahza Attaillah","kelas":"2A","program":"Unggulan"},{"id":15,"nama":"Muhammad Farros Linggar Cahyono","kelas":"2A","program":"Unggulan"},{"id":16,"nama":"Muhammad Fathir Alfalah","kelas":"2A","program":"Unggulan"},{"id":17,"nama":"Narendra Wibawa","kelas":"2A","program":"Unggulan"},{"id":18,"nama":"Naufal Zhafran Purnama","kelas":"2A","program":"Unggulan"},{"id":19,"nama":"Ahmad Arkan Sya'Bani","kelas":"2A","program":"Tahfizh"},{"id":20,"nama":"Ahmad Darwis","kelas":"2A","program":"Tahfizh"},{"id":21,"nama":"Ahmad Ghozi El Muntazhor","kelas":"2A","program":"Tahfizh"},{"id":22,"nama":"Aldan 'Izzul Islam","kelas":"2A","program":"Tahfizh"},{"id":23,"nama":"Fawwaz Elfareza Zuhri","kelas":"2A","program":"Tahfizh"},{"id":24,"nama":"M. Fathan Alfarisi Harahap","kelas":"2A","program":"Tahfizh"},{"id":25,"nama":"Muhammad Ahsani Taqwim","kelas":"2A","program":"Tahfizh"},{"id":26,"nama":"Muhammad Ayyub Al Fatih","kelas":"2A","program":"Tahfizh"},{"id":27,"nama":"Muhammad Gibran Rafassya","kelas":"2A","program":"Tahfizh"},{"id":28,"nama":"Narendra Gerrardi Kusumah","kelas":"2A","program":"Tahfizh"},{"id":29,"nama":"Rijal Abdul A'Ziz","kelas":"2A","program":"Tahfizh"},{"id":30,"nama":"Rizki Chandra Dewantara","kelas":"2A","program":"Tahfizh"}],"Abdullah":[{"id":31,"nama":"Alano Faaiq Alfeno","kelas":"2B","program":"Unggulan"},{"id":32,"nama":"Arfandhika Fakhrul Islam","kelas":"2B","program":"Unggulan"},{"id":33,"nama":"Aydin Rafif","kelas":"2B","program":"Unggulan"},{"id":34,"nama":"Danish Alzahid Dinasti","kelas":"2B","program":"Unggulan"},{"id":35,"nama":"Ghani Arif Witjaksono","kelas":"2B","program":"Unggulan"},{"id":36,"nama":"Haidarrafid Satriaa Ardhani","kelas":"2B","program":"Unggulan"},{"id":37,"nama":"Iqbal Zulfikar Al Hanif","kelas":"2B","program":"Unggulan"},{"id":38,"nama":"Jangky Dausat","kelas":"2B","program":"Unggulan"},{"id":39,"nama":"Kumara Banyu Argani","kelas":"2B","program":"Unggulan"},{"id":40,"nama":"M. Dede Afkar","kelas":"2B","program":"Unggulan"},{"id":41,"nama":"Mekha Ilham Lutfianto","kelas":"2B","program":"Unggulan"},{"id":42,"nama":"Muhammad Aiman Naim","kelas":"2B","program":"Unggulan"},{"id":43,"nama":"Muhammad Karel Ashiddiq","kelas":"2B","program":"Unggulan"},{"id":44,"nama":"Naufal Fahmi Darsono","kelas":"2B","program":"Unggulan"},{"id":45,"nama":"Nazhif Fahreza Zuhairy","kelas":"2B","program":"Unggulan"},{"id":46,"nama":"Rais Abqari Ash Shidqi","kelas":"2B","program":"Unggulan"},{"id":47,"nama":"William Ramadhan Al Ghazali","kelas":"2B","program":"Unggulan"},{"id":48,"nama":"Zia El Ibrahim Aqeela Putra Wijaya","kelas":"2B","program":"Unggulan"},{"id":49,"nama":"Ahmad Miqdad","kelas":"2B","program":"Tahfizh"},{"id":50,"nama":"Dzaky Salman Al Farisi","kelas":"2B","program":"Tahfizh"},{"id":51,"nama":"Muhammad Alvi Mumtaz Brillian Hafizh","kelas":"2B","program":"Tahfizh"},{"id":52,"nama":"Muhammad Mahdi Hafidz","kelas":"2B","program":"Tahfizh"},{"id":53,"nama":"Muhammad Naufal Rasyid Arafi","kelas":"2B","program":"Tahfizh"},{"id":54,"nama":"Nahsif Ilman Hazim Purwono","kelas":"2B","program":"Tahfizh"},{"id":55,"nama":"Nawwaf Bahy Rafif","kelas":"2B","program":"Tahfizh"},{"id":56,"nama":"Nizar Adhyatma Aryanda","kelas":"2B","program":"Tahfizh"},{"id":57,"nama":"Rafa Agitananda Az Zayyan","kelas":"2B","program":"Tahfizh"},{"id":58,"nama":"Rafa Faeyza Fa'Iz","kelas":"2B","program":"Tahfizh"},{"id":59,"nama":"Rizqi Satria Putra Surya","kelas":"2B","program":"Tahfizh"},{"id":60,"nama":"Umar Ubaidillah Tsaqif","kelas":"2B","program":"Tahfizh"},{"id":61,"nama":"Wildan Faiz Mahendra","kelas":"2B","program":"Tahfizh"}],"Muhammad Zhafir Setiaji":[{"id":62,"nama":"Faiq Fauzil Adhim","kelas":"2C","program":"Tahfizh"},{"id":63,"nama":"Fairuz Azzam Mahfuzh","kelas":"2C","program":"Tahfizh"},{"id":64,"nama":"Muhammad Arkhan Attaqi","kelas":"2C","program":"Tahfizh"},{"id":65,"nama":"Muhammad Daffa Naufal Alaika","kelas":"2C","program":"Tahfizh"},{"id":66,"nama":"Muzakki Fairuzzaman","kelas":"2C","program":"Tahfizh"},{"id":67,"nama":"Neymar Tsaqif Hikmatyar","kelas":"2C","program":"Tahfizh"},{"id":68,"nama":"Rifqi Maliki","kelas":"2C","program":"Tahfizh"},{"id":69,"nama":"Yasykur Slamer'Abqariy","kelas":"2C","program":"Tahfizh"},{"id":70,"nama":"Zhafran Dhiaurrahman Hakim","kelas":"2C","program":"Tahfizh"},{"id":71,"nama":"Achmad Adi Darwis Elfaza","kelas":"2D","program":"Tahfizh"},{"id":72,"nama":"Galang Afkar Artyanto","kelas":"2D","program":"Tahfizh"},{"id":73,"nama":"Gilang Asytar Artyanto","kelas":"2D","program":"Tahfizh"},{"id":74,"nama":"Muhammad Alif Al-Fatih","kelas":"2D","program":"Tahfizh"},{"id":75,"nama":"Muhammad Faiz Ibnu Zakaria","kelas":"2D","program":"Tahfizh"},{"id":76,"nama":"Muhammad Mahdi Hanafi","kelas":"2D","program":"Tahfizh"},{"id":77,"nama":"Muhammad Muhdi Hafidz","kelas":"2D","program":"Tahfizh"},{"id":78,"nama":"Rizqi Ahmad Altaf Zafar","kelas":"2D","program":"Tahfizh"},{"id":79,"nama":"Dzaky Anthony Akbar","kelas":"2G","program":"Tahfizh"},{"id":80,"nama":"Muwafaqi Amru Ahmad","kelas":"2G","program":"Tahfizh"},{"id":81,"nama":"Abdul Ghani Irfan Rafif","kelas":"2H","program":"Tahfizh"},{"id":82,"nama":"Abid Fadhil Abiyah","kelas":"2H","program":"Tahfizh"},{"id":83,"nama":"Ahmad Dahlan Asy'Ari","kelas":"2H","program":"Tahfizh"},{"id":84,"nama":"Athallah Azmi Ghaisan Muhammad","kelas":"2H","program":"Tahfizh"},{"id":85,"nama":"Azmi Zulfadli Syafiq","kelas":"2H","program":"Tahfizh"},{"id":86,"nama":"Azri Labibul Khawarizmi","kelas":"2H","program":"Tahfizh"},{"id":87,"nama":"Dzar Al Ghifari","kelas":"2H","program":"Tahfizh"},{"id":88,"nama":"Fatihan Al Ghifari","kelas":"2H","program":"Tahfizh"},{"id":89,"nama":"Hisyam Nabil Pasha","kelas":"2H","program":"Tahfizh"},{"id":90,"nama":"Ibadillah Kaiazmi Mubarak","kelas":"2H","program":"Tahfizh"},{"id":91,"nama":"Kashvi Jabbar Azana","kelas":"2H","program":"Tahfizh"},{"id":92,"nama":"Khawarizmi Fakhrulhaq","kelas":"2H","program":"Tahfizh"},{"id":93,"nama":"Muh. Naufal Alif","kelas":"2H","program":"Tahfizh"},{"id":94,"nama":"Muhammad Aghna Ilman Rafa","kelas":"2H","program":"Tahfizh"},{"id":95,"nama":"Royyan Abdurrahman Ibtisam","kelas":"2H","program":"Tahfizh"},{"id":96,"nama":"Sakhi Arkan Elfariza","kelas":"2H","program":"Tahfizh"}]};
        const surahData = {'30':["An-Naba'","An-Nazi'at","Abasa","At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Insyiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Ghasyiyah","Al-Fajr","Al-Balad","Asy-Syams","Al-Lail","Ad-Dhuha","Asy-Syarh","At-Tin","Al-‚ÄòAlaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-‚ÄòAdiyat","Al-Qari'ah","At-Takasur","Al-Asr","Al-Humazah","Al-Fil","Quraisy","Al-Ma'un","Al-Kausar","Al-Kafirun","An-Nasr","Al-Lahab","Al-Ikhlas","Al-Falaq","An-Nas"],'29':["Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij","Nuh","Al-Jinn","Al-Muzammil","Al-Muddatstsir","Al-Qiyamah","Al-Insan","Al-Mursalat"],'28':["Al-Mujadilah","Al-Hasyr","Al-Mumtahanah","As-Shaff","Al-Jumu'ah","Al-Munafiqun","At-Taghabun","Ath-Thalaq","At-Tahrim"]};
        const surahPageValues = {"An-Naba'":1.5,"An-Nazi'at":1.5,"Abasa":1,"At-Takwir":.8,"Al-Infitar":.5,"Al-Mutaffifin":1,"Al-Insyiqaq":.7,"Al-Buruj":.6,"At-Tariq":.4,"Al-A'la":.5,"Al-Ghasyiyah":.7,"Al-Fajr":.8,"Al-Balad":.5,"Asy-Syams":.4,"Al-Lail":.5,"Ad-Dhuha":.3,"Asy-Syarh":.2,"At-Tin":.2,"Al-‚ÄòAlaq":.5,"Al-Qadr":.2,"Al-Bayyinah":.3,"Az-Zalzalah":.2,"Al-‚ÄòAdiyat":.3,"Al-Qari'ah":.3,"At-Takasur":.2,"Al-Asr":.1,"Al-Humazah":.2,"Al-Fil":.2,"Quraisy":.1,"Al-Ma'un":.2,"Al-Kausar":.1,"Al-Kafirun":.2,"An-Nasr":.1,"Al-Lahab":.1,"Al-Ikhlas":.1,"Al-Falaq":.1,"An-Nas":.2,"Al-Mulk":2,"Al-Qalam":2,"Al-Haqqah":1.8,"Al-Ma'arij":1.5,"Nuh":1,"Al-Jinn":1,"Al-Muzammil":.8,"Al-Muddatstsir":1.5,"Al-Qiyamah":1,"Al-Insan":1,"Al-Mursalat":1.5,"Al-Mujadilah":2.5,"Al-Hasyr":2.5,"Al-Mumtahanah":1.5,"As-Shaff":1,"Al-Jumu'ah":1,"Al-Munafiqun":1,"At-Taghabun":1.5,"Ath-Thalaq":1.2,"At-Tahrim":1.2};

        // --- DOM ELEMENTS CACHE ---
        const DOMElements = {
            form: document.getElementById('setoranForm'),
            tanggalInput: document.getElementById('tanggal'),
            musyrifSelect: document.getElementById('musyrif'),
            santriSelect: document.getElementById('namaSantri'),
            kelasInput: document.getElementById('kelas'),
            programInput: document.getElementById('program'),
            jenisSelect: document.getElementById('jenis'),
            juzSelect: document.getElementById('juz'),
            halamanContainer: document.getElementById('halaman-container'),
            halamanInput: document.getElementById('halaman'),
            suratContainer: document.getElementById('surat-container'),
            suratSelect: document.getElementById('surat'),
            tableBody: document.getElementById('setoranTableBody'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            toastIcon: document.getElementById('toast-icon'),
            leaderboardModal: document.getElementById('leaderboardModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalBody: document.getElementById('modalBody'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            confirmDeleteModal: document.getElementById('confirmDeleteModal'),
            confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
            cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
            mainNav: document.getElementById('main-nav'),
            mainContent: document.getElementById('main-content'),
            pages: document.querySelectorAll('.page-content'),
            leaderboardTabs: document.getElementById('leaderboard-tabs'),
            rekapTabs: document.getElementById('rekap-tabs'),
            rekapContentContainer: document.getElementById('rekap-content-container'),
            stats: {
                totalSetoran: document.getElementById('stats-total-setoran'),
                santriAktif: document.getElementById('stats-santri-aktif'),
                totalHalaman: document.getElementById('stats-total-halaman'),
                peringkatTeratas: document.getElementById('stats-peringkat-teratas'),
            },
            recentActivityList: document.getElementById('recent-activity-list'),
            chartCanvas: document.getElementById('summaryChart'),
            riwayatSearch: document.getElementById('search-riwayat'),
            riwayatProgram: document.getElementById('filter-program'),
            riwayatTglMulai: document.getElementById('filter-tanggal-mulai'),
            riwayatTglAkhir: document.getElementById('filter-tanggal-akhir'),
            loadMoreBtn: document.getElementById('load-more-btn'),
        };

        // --- APP STATE ---
        let allSetoran = [];
        let santriData = Object.entries(rawData).flatMap(([musyrif, santriList]) => 
            santriList.map(santri => ({...santri, musyrif, setoranMutqin: new Set()}))
        );
        let fullLeaderboards = { unggulan: {}, tahfizh: {} };
        let setoranIdToDelete = null;
        let summaryChart = null;
        let displayedItemsCount = 20;
        const ITEMS_PER_PAGE = 20;
        const classGroups = {
            '2A': { santri: santriData.filter(s => s.kelas === '2A'), musyrif: "Andi Aqillah Fadia Haswat" },
            '2B': { santri: santriData.filter(s => s.kelas === '2B'), musyrif: "Abdullah" },
            '2CDGH': { santri: santriData.filter(s => ['2C', '2D', '2G', '2H'].includes(s.kelas)), musyrif: "Muhammad Zhafir Setiaji" }
        };

        // --- HELPER FUNCTIONS ---
        const setCurrentDateTime = () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            DOMElements.tanggalInput.value = now.toISOString().slice(0, 16);
        };
        const findSantriById = (id) => santriData.find(s => s.id == id);
        const showToast = (message, isSuccess = true) => {
            DOMElements.toastMessage.textContent = message;
            DOMElements.toastIcon.innerHTML = isSuccess 
                ? `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />`
                : `<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`;
            DOMElements.toastIcon.classList.toggle('text-green-400', isSuccess);
            DOMElements.toastIcon.classList.toggle('text-red-400', !isSuccess);
            DOMElements.toast.classList.add('show');
            setTimeout(() => DOMElements.toast.classList.remove('show'), 3000);
        };
        const getKualitasSVG = (kualitas) => {
            const qualityMap = { 'Mumtaz': 5, 'Jayyid Jiddan': 4, 'Jayyid': 3, 'Maqbul': 2, 'Dhoif': 1 };
            const stars = qualityMap[kualitas] || 0;
            const starIcon = `<svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
            const emptyStarIcon = `<svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
            return `<div class="flex">${starIcon.repeat(stars)}${emptyStarIcon.repeat(5 - stars)}</div>`;
        };
        const getProgramIcon = (program) => program === 'Unggulan' ? `<span title="Unggulan" class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full bg-blue-100 text-blue-800 text-xs font-bold">U</span>` : `<span title="Tahfizh" class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full bg-green-100 text-green-800 text-xs font-bold">T</span>`;
        const getClassIcon = (className) => `<span title="Kelas ${className}" class="ml-1 inline-flex items-center justify-center h-5 w-5 rounded-full bg-gray-200 text-gray-700 text-xs font-bold">${className}</span>`;
        const createOption = (text, value = text) => {
            const option = document.createElement('option');
            option.textContent = text;
            option.value = value;
            return option;
        };
        const populateSelect = (selectEl, options, placeholder) => {
            selectEl.innerHTML = '';
            if (placeholder) selectEl.add(createOption(placeholder, ''));
            options.forEach(opt => selectEl.add(typeof opt === 'string' ? createOption(opt) : createOption(opt.text, opt.value)));
        };

        // --- UI UPDATE FUNCTIONS ---
        const updateAllUI = () => {
            renderTable();
            calculateAndDisplayStats();
            renderAllRecaps();
            renderBeranda();
        };

        // --- FORM LOGIC ---
        const resetForm = () => {
            DOMElements.form.reset();
            setCurrentDateTime();
            DOMElements.musyrifSelect.value = "";
            ['santriSelect', 'jenisSelect', 'juzSelect'].forEach(key => {
                DOMElements[key].innerHTML = `<option value="">Pilih ${key === 'santriSelect' ? 'Musyrif' : '...'} dahulu</option>`;
                DOMElements[key].disabled = true;
            });
            ['kelasInput', 'programInput'].forEach(key => DOMElements[key].value = '');
            resetSetoranInputs();
        };

        const resetSetoranInputs = () => {
            DOMElements.halamanContainer.classList.add('hidden');
            DOMElements.suratContainer.classList.add('hidden');
            DOMElements.halamanInput.disabled = true;
            DOMElements.halamanInput.required = false;
            DOMElements.halamanInput.value = '';
            DOMElements.halamanInput.min = 1;
            DOMElements.suratSelect.required = false;
        };

        DOMElements.musyrifSelect.addEventListener('change', () => {
            const selectedMusyrif = DOMElements.musyrifSelect.value;
            resetSetoranInputs();
            DOMElements.jenisSelect.disabled = true;
            DOMElements.juzSelect.disabled = true;
            if (selectedMusyrif) {
                const santriOptions = santriData.filter(s => s.musyrif === selectedMusyrif).sort((a, b) => a.nama.localeCompare(b.nama)).map(s => ({ text: s.nama, value: s.id }));
                populateSelect(DOMElements.santriSelect, santriOptions, 'Pilih Santri');
                DOMElements.santriSelect.disabled = false;
            } else {
                populateSelect(DOMElements.santriSelect, [], 'Pilih Musyrif dahulu');
                DOMElements.santriSelect.disabled = true;
            }
        });

        DOMElements.santriSelect.addEventListener('change', () => {
            const santri = findSantriById(DOMElements.santriSelect.value);
            resetSetoranInputs();
            if (santri) {
                DOMElements.kelasInput.value = santri.kelas;
                DOMElements.programInput.value = santri.program;
                const hasCompletedBasicMutqin = santri.setoranMutqin.has(29) && santri.setoranMutqin.has(30);
                const jenisOptions = [];
                if (santri.program === "Unggulan" || (santri.program === "Tahfizh" && hasCompletedBasicMutqin)) {
                    jenisOptions.push("Ziyadah");
                }
                jenisOptions.push("Mutqin");
                populateSelect(DOMElements.jenisSelect, jenisOptions, 'Pilih Jenis');
                DOMElements.jenisSelect.disabled = false;
            } else {
                DOMElements.jenisSelect.disabled = true;
            }
        });

        DOMElements.jenisSelect.addEventListener('change', () => {
            const jenis = DOMElements.jenisSelect.value;
            const santri = findSantriById(DOMElements.santriSelect.value);
            resetSetoranInputs();
            if (!jenis || !santri) {
                DOMElements.juzSelect.disabled = true;
                return;
            }
            let juzOptions = [];
            if (jenis === "Mutqin") {
                for (let i = 1; i <= 30; i++) if (!santri.setoranMutqin.has(i)) juzOptions.push({ text: `Juz ${i}`, value: i });
            } else if (jenis === "Ziyadah") {
                for (let i = 1; i <= 30; i++) juzOptions.push({ text: `Juz ${i}`, value: i });
            }
            populateSelect(DOMElements.juzSelect, juzOptions, 'Pilih Juz');
            DOMElements.juzSelect.disabled = false;
        });

        DOMElements.juzSelect.addEventListener('change', () => {
            const jenis = DOMElements.jenisSelect.value;
            const juz = parseInt(DOMElements.juzSelect.value);
            resetSetoranInputs();
            if (jenis === 'Ziyadah') {
                if ([28, 29, 30].includes(juz)) {
                    DOMElements.suratContainer.classList.remove('hidden');
                    DOMElements.suratSelect.required = true;
                    populateSelect(DOMElements.suratSelect, surahData[juz] || [], 'Pilih Surat');
                } else {
                    DOMElements.halamanContainer.classList.remove('hidden');
                    DOMElements.halamanInput.required = true;
                    DOMElements.halamanInput.disabled = false;
                }
            } else if (jenis === 'Mutqin') {
                DOMElements.halamanContainer.classList.remove('hidden');
                DOMElements.halamanInput.disabled = false;
                DOMElements.halamanInput.placeholder = 'Min 5 hlm / Kosongkan utk 1 Juz';
                DOMElements.halamanInput.min = 5;
            }
        });

        DOMElements.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(DOMElements.form);
            const setoranData = Object.fromEntries(formData.entries());
            const santri = findSantriById(setoranData.namaSantri);
            if (!santri) return showToast('Error: Santri tidak ditemukan!', false);

            Object.assign(setoranData, {
                santriId: santri.id,
                namaSantri: santri.nama,
                musyrif: santri.musyrif,
                program: santri.program,
                id: Date.now()
            });

            const juz = parseInt(setoranData.juz);
            if (setoranData.jenis === 'Ziyadah' && [28, 29, 30].includes(juz)) {
                if (!setoranData.surat) return showToast('Error: Silakan pilih surat.', false);
                setoranData.setoranUnit = setoranData.surat;
            } else if (setoranData.jenis === 'Mutqin' && !setoranData.halaman) {
                setoranData.setoranUnit = '1 Juz';
            } else {
                if (!setoranData.halaman) return showToast('Error: Jumlah halaman harus diisi.', false);
                setoranData.setoranUnit = `${setoranData.halaman} halaman`;
            }

            allSetoran.push(setoranData);
            if (setoranData.jenis === 'Mutqin' && !setoranData.halaman) {
                santri.setoranMutqin.add(juz);
            }
            updateAllUI();
            showToast('Setoran berhasil disimpan!');
            resetForm();
        });

        // --- RENDERING ---
        function renderTable() {
            const searchTerm = DOMElements.riwayatSearch.value.toLowerCase();
            const programFilter = DOMElements.riwayatProgram.value;
            const startDate = DOMElements.riwayatTglMulai.value ? new Date(DOMElements.riwayatTglMulai.value) : null;
            const endDate = DOMElements.riwayatTglAkhir.value ? new Date(DOMElements.riwayatTglAkhir.value) : null;
            if(startDate) startDate.setHours(0,0,0,0);
            if(endDate) endDate.setHours(23,59,59,999);

            const filteredSetoran = allSetoran
                .filter(s => {
                    const setoranDate = new Date(s.tanggal);
                    const nameMatch = s.namaSantri.toLowerCase().includes(searchTerm);
                    const programMatch = programFilter === 'Semua' || s.program === programFilter;
                    const startDateMatch = !startDate || setoranDate >= startDate;
                    const endDateMatch = !endDate || setoranDate <= endDate;
                    return nameMatch && programMatch && startDateMatch && endDateMatch;
                })
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            const itemsToRender = filteredSetoran.slice(0, displayedItemsCount);

            if (itemsToRender.length === 0) {
                DOMElements.tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-gray-700">Tidak ada data yang cocok dengan filter.</td></tr>';
            } else {
                DOMElements.tableBody.innerHTML = itemsToRender.map((setoran, index) => {
                    const santri = findSantriById(setoran.santriId);
                    return `
                    <tr class="hover:bg-white/10 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center"><div class="font-medium text-gray-900">${setoran.namaSantri}</div>${getProgramIcon(setoran.program)}${getClassIcon(santri ? santri.kelas : '')}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800"><div>${setoran.jenis} Juz ${setoran.juz}</div><div class="text-xs text-gray-600">${setoran.setoranUnit}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${getKualitasSVG(setoran.kualitas)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden sm:table-cell">${new Date(setoran.tanggal).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button data-id="${setoran.id}" class="delete-btn text-gray-400 hover:text-red-600 p-1 rounded-full transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    </tr>`;
                }).join('');
            }

            if (filteredSetoran.length > displayedItemsCount) {
                DOMElements.loadMoreBtn.classList.remove('hidden');
                DOMElements.loadMoreBtn.textContent = `Muat Lebih Banyak (${filteredSetoran.length - displayedItemsCount} lagi)`;
            } else {
                DOMElements.loadMoreBtn.classList.add('hidden');
            }
        }

        function calculateAndDisplayStats() {
            const stats = allSetoran.reduce((acc, s) => {
                const santri = findSantriById(s.santriId);
                if (!santri) return acc;
                const programKey = s.program.toLowerCase();
                if (!acc[programKey]) acc[programKey] = {};
                if (!acc[programKey][s.santriId]) {
                    acc[programKey][s.santriId] = { nama: s.namaSantri, program: s.program, kelas: santri.kelas, totalHalaman: 0, frekuensi: 0, totalKualitas: 0 };
                }
                let halaman = 0;
                if (s.setoranUnit === '1 Juz') halaman = 20;
                else if (s.setoranUnit.includes('halaman')) halaman = parseFloat(s.setoranUnit) || 0;
                else halaman = surahPageValues[s.setoranUnit] || 0;
                
                acc[programKey][s.santriId].totalHalaman += halaman;
                acc[programKey][s.santriId].frekuensi += 1;
                acc[programKey][s.santriId].totalKualitas += ({ 'Mumtaz': 5, 'Jayyid Jiddan': 4, 'Jayyid': 3, 'Maqbul': 2, 'Dhoif': 1 })[s.kualitas] || 0;
                return acc;
            }, {});

            ['unggulan', 'tahfizh'].forEach(programKey => {
                const statsArray = Object.values(stats[programKey] || {});
                fullLeaderboards[programKey].terbanyak = [...statsArray].sort((a, b) => b.totalHalaman - a.totalHalaman);
                fullLeaderboards[programKey].terrajin = [...statsArray].sort((a, b) => b.frekuensi - a.frekuensi);
                fullLeaderboards[programKey].kualitas = statsArray.filter(a => a.frekuensi > 0).sort((a, b) => (b.totalKualitas / b.frekuensi) - (a.totalKualitas / a.frekuensi));
                
                displayLeaderboard(programKey, 'terbanyak', fullLeaderboards[programKey].terbanyak.slice(0, 3));
                displayLeaderboard(programKey, 'terrajin', fullLeaderboards[programKey].terrajin.slice(0, 3));
                displayLeaderboard(programKey, 'kualitas', fullLeaderboards[programKey].kualitas.slice(0, 3));
            });
        }

        function displayLeaderboard(program, category, data) {
            const listEl = document.getElementById(`stats-${program}-${category}-list`);
            if (data.length === 0) {
                listEl.innerHTML = '<p class="text-sm text-gray-700">Belum ada data.</p>';
                return;
            }
            const emojiMap = {1: 'ü•á', 2: 'ü•à', 3: 'ü•â'};
            listEl.innerHTML = data.map((item, index) => {
                const rank = index + 1;
                const emoji = emojiMap[rank] || `<span class="font-normal text-gray-500 w-6 text-center">${rank}.</span>`;
                let valueText = '';
                if (category === 'terbanyak') valueText = `${item.totalHalaman.toFixed(1)} hlm`;
                else if (category === 'terrajin') valueText = `${item.frekuensi}x setor`;
                else if (category === 'kualitas') valueText = `Avg: ${(item.totalKualitas / item.frekuensi).toFixed(2)}`;
                return `<div class="text-sm flex justify-between items-center"><span class="font-semibold text-gray-800 truncate flex items-center"><span class="mr-2 w-6 inline-block text-center">${emoji}</span>${item.nama} ${getClassIcon(item.kelas)}</span><span class="text-gray-600 font-medium">${valueText}</span></div>`;
            }).join('');
        }

        function renderAllRecaps() {
            DOMElements.rekapContentContainer.innerHTML = Object.keys(classGroups).map((groupName, index) => `
                <div id="rekap-tab-${groupName}" class="rekap-tab-content ${index > 0 ? 'hidden' : ''}">${createRecapHTML(groupName)}</div>
            `).join('');
        }

        function createRecapHTML(groupName) {
            const group = classGroups[groupName];
            const timestamp = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
            
            const tableRows = group.santri.sort((a,b) => a.nama.localeCompare(b.nama)).map((santri, index) => {
                const totalHalaman = allSetoran.filter(s => s.santriId === santri.id).reduce((sum, s) => {
                    if (s.setoranUnit === '1 Juz') return sum + 20;
                    if (s.setoranUnit.includes('halaman')) return sum + (parseFloat(s.setoranUnit) || 0);
                    return sum + (surahPageValues[s.setoranUnit] || 0);
                }, 0);
                const isTuntas = santri.setoranMutqin.size >= 30;
                const keterangan = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isTuntas ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${isTuntas ? 'Tuntas' : 'Belum Tuntas'}</span>`;
                return `<tr><td class="px-4 py-2">${index + 1}</td><td class="px-4 py-2"><div class="flex items-center">${santri.nama}${getProgramIcon(santri.program)}</div></td><td class="px-4 py-2 font-medium">${totalHalaman.toFixed(1)}</td><td class="px-4 py-2">${keterangan}</td></tr>`;
            }).join('');

            return `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <div><h3 class="font-bold text-amber-800 text-lg">Rekap Capaian - Kelas ${groupName}</h3><p class="text-sm text-gray-700">Musyrif: ${group.musyrif}</p><p class="text-xs text-gray-500">${timestamp}</p></div>
                    <button data-class-group="${groupName}" class="export-pdf-btn mt-3 sm:mt-0 bg-green-100 text-green-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors">Ekspor ke PDF</button>
                </div>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-white/20"><thead class="bg-gray-500/10"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase">No.</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase">Nama</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase">Skor</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase">Keterangan</th></tr></thead><tbody class="divide-y divide-white/20">${tableRows}</tbody></table></div>
            `;
        }
        
        // --- MODAL & NAVIGATION ---
        const openModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
        const closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');

        const showLeaderboardModal = (program, category) => {
            const titles = { terbanyak: 'üìö Top 10 Halaman Terbanyak', terrajin: 'üèÉ‚Äç‚ôÇÔ∏è Top 10 Paling Rajin', kualitas: '‚≠ê Top 10 Kualitas Terbaik' };
            DOMElements.modalTitle.textContent = `${titles[category]} (${program.charAt(0).toUpperCase() + program.slice(1)})`;
            const fullData = fullLeaderboards[program][category].slice(0, 10);
            DOMElements.modalBody.innerHTML = fullData.length === 0 ? '<p class="text-center text-gray-700">Tidak ada data.</p>' : `<ol class="space-y-3">${fullData.map((item, index) => {
                let valueText = '';
                if (category === 'terbanyak') valueText = `${item.totalHalaman.toFixed(1)} halaman`;
                else if (category === 'terrajin') valueText = `${item.frekuensi} setoran`;
                else if (category === 'kualitas') valueText = `Rata-rata: ${(item.totalKualitas / item.frekuensi).toFixed(2)}`;
                return `<li class="flex items-center justify-between pb-2 border-b border-white/30"><div><span class="font-bold mr-3 w-6 inline-block text-center">${index + 1}.</span><span>${item.nama}</span></div><span class="font-semibold text-gray-700">${valueText}</span></li>`;
            }).join('')}</ol>`;
            openModal('leaderboardModal');
        };
        
        const switchTab = (container, contentSelector, clickedBtn, idPrefix) => {
            container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            clickedBtn.classList.add('active');
            document.querySelectorAll(contentSelector).forEach(content => content.classList.add('hidden'));
            const targetId = `${idPrefix}-${clickedBtn.dataset.tab}`;
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.classList.remove('hidden');
            }
        };

        // --- EVENT LISTENERS (with Delegation) ---
        document.getElementById('nowBtn').addEventListener('click', setCurrentDateTime);
        DOMElements.closeModalBtn.addEventListener('click', () => closeModal('leaderboardModal'));
        DOMElements.leaderboardModal.addEventListener('click', (e) => { if (e.target === DOMElements.leaderboardModal) closeModal('leaderboardModal'); });
        DOMElements.cancelDeleteBtn.addEventListener('click', () => closeModal('confirmDeleteModal'));
        DOMElements.confirmDeleteModal.addEventListener('click', (e) => { if (e.target === DOMElements.confirmDeleteModal) closeModal('confirmDeleteModal'); });

        DOMElements.mainNav.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (!link || link.classList.contains('active')) return;
            e.preventDefault();
            const pageId = link.dataset.page;
            
            DOMElements.pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');

            DOMElements.mainNav.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
            link.classList.add('active');
        });
        
        DOMElements.leaderboardTabs.addEventListener('click', (e) => {
            if (e.target.matches('.tab-btn')) switchTab(DOMElements.leaderboardTabs, '.tab-content', e.target, 'tab');
        });

        DOMElements.rekapTabs.addEventListener('click', (e) => {
            if (e.target.matches('.rekap-tab-btn')) switchTab(DOMElements.rekapTabs, '.rekap-tab-content', e.target, 'rekap-tab');
        });

        DOMElements.mainContent.addEventListener('click', (e) => {
            const seeAllBtn = e.target.closest('.see-all-btn');
            const exportBtn = e.target.closest('.export-pdf-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const quickAccessBtn = e.target.closest('.quick-access-btn');

            if (seeAllBtn) {
                const { category, program } = seeAllBtn.dataset;
                showLeaderboardModal(program, category);
            }
            if (exportBtn) {
                exportRecapToPDF(exportBtn.dataset.classGroup);
            }
            if (deleteBtn) {
                setoranIdToDelete = parseInt(deleteBtn.dataset.id);
                openModal('confirmDeleteModal');
            }
            if (quickAccessBtn && quickAccessBtn.id !== 'refresh-data-btn') {
                const targetPage = quickAccessBtn.dataset.targetPage;
                const navLink = DOMElements.mainNav.querySelector(`a[data-page="${targetPage}"]`);
                if (navLink) navLink.click();
            }
        });
        
        document.getElementById('refresh-data-btn').addEventListener('click', () => {
            showToast('Data diperbarui!');
            [DOMElements.riwayatSearch, DOMElements.riwayatTglMulai, DOMElements.riwayatTglAkhir].forEach(el => el.value = '');
            DOMElements.riwayatProgram.value = 'Semua';
            displayedItemsCount = ITEMS_PER_PAGE;
            updateAllUI();
        });
        
        [DOMElements.riwayatSearch, DOMElements.riwayatProgram, DOMElements.riwayatTglMulai, DOMElements.riwayatTglAkhir].forEach(el => {
            el.addEventListener('input', () => {
                displayedItemsCount = ITEMS_PER_PAGE;
                renderTable();
            });
        });

        DOMElements.loadMoreBtn.addEventListener('click', () => {
            displayedItemsCount += ITEMS_PER_PAGE;
            renderTable();
        });

        DOMElements.confirmDeleteBtn.addEventListener('click', () => {
            const index = allSetoran.findIndex(s => s.id === setoranIdToDelete);
            if (index > -1) {
                const deletedSetoran = allSetoran[index];
                
                // Revert mutqin status if a full juz was deleted
                if (deletedSetoran.jenis === 'Mutqin' && deletedSetoran.setoranUnit === '1 Juz') {
                    const santri = findSantriById(deletedSetoran.santriId);
                    if (santri) {
                        santri.setoranMutqin.delete(parseInt(deletedSetoran.juz));
                    }
                }
                
                allSetoran.splice(index, 1);
                updateAllUI();
                showToast('Data berhasil dihapus.');
            }
            closeModal('confirmDeleteModal');
            setoranIdToDelete = null;
        });

        function exportRecapToPDF(classGroup) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                const group = classGroups[classGroup];
                if (!group) {
                    showToast('Grup kelas tidak ditemukan.', false);
                    return;
                }

                const headStyles = { fillColor: [217, 119, 6] }; // amber-600
                
                doc.autoTable({
                    head: [['No.', 'Nama Santri', 'Program', 'Skor', 'Keterangan']],
                    body: group.santri.sort((a, b) => a.nama.localeCompare(b.nama)).map((santri, index) => {
                        const totalHalaman = allSetoran.filter(s => s.santriId === santri.id).reduce((sum, s) => {
                            if (s.setoranUnit === '1 Juz') return sum + 20;
                            if (s.setoranUnit.includes('halaman')) return sum + (parseFloat(s.setoranUnit) || 0);
                            return sum + (surahPageValues[s.setoranUnit] || 0);
                        }, 0);
                        const isTuntas = santri.setoranMutqin.size >= 30;
                        return [
                            index + 1,
                            santri.nama,
                            santri.program,
                            totalHalaman.toFixed(1),
                            isTuntas ? 'Tuntas' : 'Belum Tuntas'
                        ];
                    }),
                    theme: 'grid',
                    headStyles: headStyles,
                    styles: {
                        font: 'Inter',
                        cellPadding: 6,
                        valign: 'middle'
                    },
                    columnStyles: {
                        0: { cellWidth: 30 },
                        2: { cellWidth: 60 },
                        3: { cellWidth: 40, halign: 'center' },
                        4: { cellWidth: 80, halign: 'center' }
                    },
                    didDrawPage: function (data) {
                        // Header
                        doc.setFontSize(20);
                        doc.setTextColor(180, 83, 9); // amber-700
                        doc.setFont('helvetica', 'bold');
                        doc.text('Laporan Capaian Tahfizh', data.settings.margin.left, 40);

                        doc.setFontSize(12);
                        doc.setTextColor(40);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Kelas: ${group.title || classGroup} | Musyrif: ${group.musyrif}`, data.settings.margin.left, 58);

                        // Footer
                        const pageCount = doc.internal.getNumberOfPages();
                        doc.setFontSize(8);
                        doc.setTextColor(150);
                        doc.text(`Halaman ${data.pageNumber} dari ${pageCount}`, data.settings.margin.left, doc.internal.pageSize.height - 20);
                        doc.text(`Dibuat pada: ${new Date().toLocaleString('id-ID')}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 20, { align: 'right' });
                    },
                    margin: { top: 70, bottom: 40 }
                });

                doc.save(`rekap_setoran_${classGroup}_${Date.now()}.pdf`);
            } catch (error) {
                console.error("PDF Export Error:", error);
                showToast('Gagal mengekspor PDF.', false);
            }
        }
        
        function renderBeranda() {
            // Main Stats
            const totalHalaman = allSetoran.reduce((sum, s) => {
                if (s.setoranUnit === '1 Juz') return sum + 20;
                if (s.setoranUnit.includes('halaman')) return sum + (parseFloat(s.setoranUnit) || 0);
                return sum + (surahPageValues[s.setoranUnit] || 0);
            }, 0);
            const santriAktifIds = new Set(allSetoran.map(s => s.santriId));
            
            DOMElements.stats.totalSetoran.textContent = allSetoran.length;
            DOMElements.stats.santriAktif.textContent = santriAktifIds.size;
            DOMElements.stats.totalHalaman.textContent = totalHalaman.toFixed(1);
            DOMElements.stats.peringkatTeratas.textContent = fullLeaderboards.tahfizh?.terbanyak[0]?.nama || '-';

            // Recent Activity
            const recentActivities = [...allSetoran].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).slice(0, 5);
            if(recentActivities.length > 0) {
                DOMElements.recentActivityList.innerHTML = recentActivities.map(s => `
                    <div class="flex items-start gap-3">
                        <div class="bg-gray-200/50 p-2 rounded-full mt-1">${getProgramIcon(s.program)}</div>
                        <div>
                            <p class="text-sm font-semibold text-gray-900">${s.namaSantri}</p>
                            <p class="text-xs text-gray-700">Menyetor ${s.jenis} ${s.setoranUnit === '1 Juz' ? `Juz ${s.juz}` : s.setoranUnit}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                DOMElements.recentActivityList.innerHTML = `<p class="text-sm text-gray-700">Belum ada aktivitas.</p>`;
            }

            // Chart
            renderSummaryChart();
        }

        function renderSummaryChart() {
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('id-ID', { weekday: 'short' }));
                const setoranOnDay = allSetoran.filter(s => new Date(s.tanggal).toDateString() === d.toDateString());
                data.push(setoranOnDay.length);
            }

            if (summaryChart) {
                summaryChart.destroy();
            }
            
            summaryChart = new Chart(DOMElements.chartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Setoran',
                        data: data,
                        backgroundColor: 'rgba(245, 158, 11, 0.6)',
                        borderColor: 'rgba(217, 119, 6, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1, color: '#374151' } },
                        x: { ticks: { color: '#374151' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }


        // --- INITIALIZATION ---
        function init() {
            populateSelect(DOMElements.musyrifSelect, ["Andi Aqillah Fadia Haswat", "Abdullah", "Muhammad Zhafir Setiaji"], 'Pilih Musyrif');
            updateAllUI();
            resetForm();
            // Show initial content without skeleton
            document.querySelectorAll('.skeleton-container').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.remove('hidden'));
            
            // Set default page to Beranda
            DOMElements.pages.forEach(page => page.classList.add('hidden'));
            document.getElementById('page-beranda').classList.remove('hidden');
        }

        init();
    });
    </script>
</body>
</html>
