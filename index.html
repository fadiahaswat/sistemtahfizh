<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setor.in - Aplikasi Setoran Hafalan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        .form-select:disabled, .form-input:disabled {
            background-color: #f1f5f9; /* gray-100 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Animasi */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes highlight {
            from { background-color: #fef3c7; } /* amber-100 */
            to { background-color: white; }
        }
        .highlight-new-row {
            animation: highlight 2s ease-out forwards;
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 5rem; /* Adjusted for mobile nav */
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0;
            z-index: 100;
            transform: translate(-50%, 100px);
        }
        @media (min-width: 640px) {
            #toast {
                bottom: 2rem;
            }
        }
        #toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        
        /* Modal */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.hidden .modal-backdrop {
            opacity: 0;
        }
        .modal.hidden .modal-content {
            opacity: 0;
            transform: translateY(-20px);
        }
        
        /* Tab Styles */
        .tab-btn, .rekap-tab-btn {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active, .rekap-tab-btn.active {
            border-color: #f59e0b; /* amber-500 */
            color: #b45309; /* amber-700 */
        }
        .page-content.hidden {
            display: none;
        }
        /* Nav active state */
        .nav-link {
            transition: all 0.2s ease-in-out;
        }
        .nav-link.active, .nav-link.active svg {
            color: #f59e0b; /* amber-500 */
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="sm:flex">
        <!-- Navigation Menu -->
        <nav class="fixed bottom-0 left-0 w-full bg-white border-t sm:relative sm:w-64 sm:h-screen sm:border-r sm:border-t-0 z-20">
            <div class="flex sm:flex-col sm:py-4 sm:px-3 h-full">
                <!-- Logo/Header for Sidebar -->
                <div class="hidden sm:flex items-center gap-3 p-3 mb-4">
                    <div class="bg-amber-500 p-2 rounded-lg text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-9-5.747h18" /></svg>
                    </div>
                    <span class="font-bold text-lg text-gray-800">Setor.in</span>
                </div>

                <!-- Nav Links -->
                <div class="flex sm:flex-col w-full">
                    <a href="#" data-page="page-form" class="nav-link active flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-600 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        <span class="text-xs sm:text-sm">Formulir</span>
                    </a>
                     <a href="#" data-page="page-riwayat" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-600 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                        <span class="text-xs sm:text-sm">Riwayat</span>
                    </a>
                    <a href="#" data-page="page-peringkat" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-600 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        <span class="text-xs sm:text-sm">Peringkat</span>
                    </a>
                    <a href="#" data-page="page-rekap" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-600 hover:text-amber-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <span class="text-xs sm:text-sm">Rekap</span>
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 pb-20 sm:pb-0 overflow-y-auto">
            <div id="page-form" class="page-content p-4 sm:p-6 lg:p-8">
                <!-- Header -->
                <header class="text-center py-12 sm:py-16 fade-in">
                    <div class="mx-auto mb-6 w-16 h-16 rounded-2xl bg-amber-500 text-white flex items-center justify-center text-3xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                        </svg>
                    </div>
                    <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight text-gray-900">
                        Setor.in Hafalan
                    </h1>
                    <p class="mt-4 text-base sm:text-lg text-gray-600 max-w-2xl mx-auto">
                        Aplikasi pencatatan setoran di Asrama 1 Abu Bakar Ash-Shiddiq, Madrasah Mu'allimin Muhammadiyah Yogyakarta.
                    </p>
                </header>
                
                <!-- Form Card -->
                <div class="max-w-2xl mx-auto bg-white rounded-2xl border border-gray-200 overflow-hidden fade-in" style="animation-delay: 150ms;">
                    <div class="p-6 sm:p-8">
                        <form id="setoranForm" class="flex flex-col gap-8">
                            <fieldset>
                                <legend class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Informasi Dasar</legend>
                                <div>
                                    <label for="tanggal" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                        <span>Tanggal & Waktu</span>
                                    </label>
                                    <div class="relative mt-1">
                                        <input type="datetime-local" id="tanggal" name="tanggal" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 form-input transition-all" required>
                                    </div>
                                    <div class="text-right mt-2">
                                        <button type="button" id="nowBtn" class="text-xs text-amber-600 hover:underline">Gunakan waktu sekarang</button>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Detail Santri</legend>
                                <div class="flex flex-col gap-5">
                                    <div>
                                        <label for="musyrif" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                                            <span>Musyrif</span>
                                        </label>
                                        <div class="relative mt-1">
                                            <select id="musyrif" name="musyrif" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 form-select transition-all" required>
                                                <option value="">Pilih Musyrif</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label for="namaSantri" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                            <span>Nama Santri</span>
                                        </label>
                                        <div class="relative mt-1">
                                            <select id="namaSantri" name="namaSantri" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 form-select transition-all" required disabled>
                                                <option value="">Pilih Musyrif dahulu</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                        <div>
                                            <label for="kelas" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                                                <span>Kelas</span>
                                            </label>
                                            <div class="relative mt-1">
                                                <input type="text" id="kelas" name="kelas" class="w-full p-3 border border-gray-300 rounded-lg form-input" readonly disabled>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="program" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm2 1v2h6V5H7zm0 4v2h6V9H7zm0 4v2h6v-2H7z" /></svg>
                                                <span>Program</span>
                                            </label>
                                            <div class="relative mt-1">
                                                <input type="text" id="program" name="program" class="w-full p-3 border border-gray-300 rounded-lg form-input" readonly disabled>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Detail Setoran</legend>
                                <div class="flex flex-col gap-5">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                        <div>
                                            <label for="jenis" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                                  <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                                </svg>
                                                <span>Jenis Setoran</span>
                                            </label>
                                            <div class="relative mt-1">
                                                <select id="jenis" name="jenis" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 form-select transition-all" required disabled>
                                                    <option value="">Pilih Santri dahulu</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="juz" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" /></svg>
                                                <span>Juz</span>
                                            </label>
                                            <div class="relative mt-1">
                                                <select id="juz" name="juz" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 form-select transition-all" required disabled>
                                                    <option value="">Pilih Jenis dahulu</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                        <div id="halaman-container">
                                            <label for="halaman" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v10H5V5z" clip-rule="evenodd" /></svg>
                                                <span>Halaman</span>
                                            </label>
                                            <div class="relative mt-1">
                                                <input type="number" id="halaman" name="halaman" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 form-input transition-all" required disabled>
                                            </div>
                                        </div>
                                        <div id="surat-container" class="hidden">
                                            <label for="surat" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804V4.804A7.968 7.968 0 0014.5 4z" /></svg>
                                                <span>Surat</span>
                                            </label>
                                            <div class="relative mt-1">
                                                <select id="surat" name="surat" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 form-select transition-all" required>
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="kualitas" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                                <span>Kualitas</span>
                                            </label>
                                            <div class="relative mt-1">
                                                <select id="kualitas" name="kualitas" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 form-select transition-all" required>
                                                    <option value="Mumtaz">Mumtaz</option>
                                                    <option value="Jayyid Jiddan">Jayyid Jiddan</option>
                                                    <option value="Jayyid">Jayyid</option>
                                                    <option value="Maqbul">Maqbul</option>
                                                    <option value="Dhoif">Dhoif</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <div class="mt-2">
                                <button type="submit" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all duration-300">
                                    Simpan Setoran
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="page-riwayat" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto fade-in">
                     <div class="text-center mb-8">
                         <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">📜 Riwayat Setoran</h2>
                         <p class="text-gray-600 mt-2">Jejak langkahmu dalam menghafal Al-Qur'an tercatat di sini. Terus semangat!</p>
                     </div>
                     <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Santri</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detail Setoran</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kualitas</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Tanggal</th>
                                    </tr>
                                </thead>
                                <tbody id="setoranTableBody" class="bg-white divide-y divide-gray-200">
                                     <tr><td colspan="4" class="text-center p-8 text-gray-500">Belum ada data setoran.</td></tr>
                                </tbody>
                            </table>
                        </div>
                     </div>
                </div>
            </div>

            <div id="page-peringkat" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <!-- Papan Peringkat Statistik -->
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="text-center mb-8">
                         <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">👑 Papan Peringkat</h2>
                         <p class="text-gray-600 mt-2">Berlomba-lombalah dalam kebaikan. Lihat siapa yang memimpin hari ini!</p>
                     </div>
                    
                    <div class="leaderboard-tabs border-b border-gray-200">
                        <nav id="leaderboard-tabs" class="-mb-px flex justify-center space-x-6">
                            <button data-tab="tahfizh" class="tab-btn active whitespace-nowrap py-4 px-1 text-base font-medium text-gray-500 hover:text-amber-600">Tahfizh</button>
                            <button data-tab="unggulan" class="tab-btn whitespace-nowrap py-4 px-1 text-base font-medium text-gray-500 hover:text-amber-600">Unggulan</button>
                        </nav>
                    </div>

                    <div id="leaderboard-content-container" class="mt-6">
                        <div id="tab-tahfizh" class="tab-content">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-white p-5 rounded-xl border border-gray-200 flex flex-col card-hover"><h3 class="font-bold text-amber-700 text-lg">📚 Halaman Terbanyak</h3><div id="stats-tahfizh-terbanyak-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terbanyak" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-amber-600 hover:underline">Lihat semua...</button></div>
                                <div class="bg-white p-5 rounded-xl border border-gray-200 flex flex-col card-hover"><h3 class="font-bold text-orange-700 text-lg">🏃‍♂️ Paling Rajin</h3><div id="stats-tahfizh-terrajin-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terrajin" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-orange-600 hover:underline">Lihat semua...</button></div>
                                <div class="bg-white p-5 rounded-xl border border-gray-200 flex flex-col card-hover"><h3 class="font-bold text-red-700 text-lg">⭐ Kualitas Terbaik</h3><div id="stats-tahfizh-kualitas-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="kualitas" data-program="tahfizh" class="see-all-btn mt-4 text-sm text-red-600 hover:underline">Lihat semua...</button></div>
                            </div>
                        </div>
                        <div id="tab-unggulan" class="tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-white p-5 rounded-xl border border-gray-200 flex flex-col card-hover"><h3 class="font-bold text-amber-700 text-lg">📚 Halaman Terbanyak</h3><div id="stats-unggulan-terbanyak-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terbanyak" data-program="unggulan" class="see-all-btn mt-4 text-sm text-amber-600 hover:underline">Lihat semua...</button></div>
                                <div class="bg-white p-5 rounded-xl border border-gray-200 flex flex-col card-hover"><h3 class="font-bold text-orange-700 text-lg">🏃‍♂️ Paling Rajin</h3><div id="stats-unggulan-terrajin-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="terrajin" data-program="unggulan" class="see-all-btn mt-4 text-sm text-orange-600 hover:underline">Lihat semua...</button></div>
                                <div class="bg-white p-5 rounded-xl border border-gray-200 flex flex-col card-hover"><h3 class="font-bold text-red-700 text-lg">⭐ Kualitas Terbaik</h3><div id="stats-unggulan-kualitas-list" class="mt-3 space-y-2 flex-grow"></div><button data-category="kualitas" data-program="unggulan" class="see-all-btn mt-4 text-sm text-red-600 hover:underline">Lihat semua...</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-rekap" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <!-- Rekap Setoran Perkelas -->
                <div class="max-w-6xl mx-auto fade-in">
                     <div class="text-center mb-8">
                         <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">📊 Rekap Setoran Perkelas</h2>
                         <p class="text-gray-600 mt-2">Pantau perkembangan setiap kelas dengan mudah dan ekspor laporannya.</p>
                     </div>
                     <div class="bg-white rounded-2xl border border-gray-200 p-5">
                         <div class="border-b border-gray-200">
                             <nav id="rekap-tabs" class="-mb-px flex justify-center space-x-6">
                                 <button data-tab="2A" class="rekap-tab-btn active whitespace-nowrap py-4 px-1 text-base font-medium text-gray-500 hover:text-amber-600">Kelas 2A</button>
                                 <button data-tab="2B" class="rekap-tab-btn whitespace-nowrap py-4 px-1 text-base font-medium text-gray-500 hover:text-amber-600">Kelas 2B</button>
                                 <button data-tab="2CDGH" class="rekap-tab-btn whitespace-nowrap py-4 px-1 text-base font-medium text-gray-500 hover:text-amber-600">Kelas 2CDGH</button>
                             </nav>
                         </div>
                         <div class="mt-6">
                             <div id="rekap-tab-2A" class="rekap-tab-content">
                                 <div id="rekap-header-2A" class="mb-4"></div>
                                 <div class="overflow-x-auto">
                                    <div id="rekap-list-2A" class="space-y-2 text-sm"></div>
                                 </div>
                             </div>
                             <div id="rekap-tab-2B" class="rekap-tab-content hidden">
                                 <div id="rekap-header-2B" class="mb-4"></div>
                                 <div class="overflow-x-auto">
                                    <div id="rekap-list-2B" class="space-y-2 text-sm"></div>
                                 </div>
                             </div>
                             <div id="rekap-tab-2CDGH" class="rekap-tab-content hidden">
                                 <div id="rekap-header-2CDGH" class="mb-4"></div>
                                 <div class="overflow-x-auto">
                                    <div id="rekap-list-2CDGH" class="space-y-2 text-sm"></div>
                                 </div>
                             </div>
                         </div>
                     </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="leaderboardModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-2xl border border-gray-300 w-full max-w-md max-h-[80vh] flex flex-col relative z-50">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-bold"></h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalBody" class="p-5 overflow-y-auto">
                <!-- Peringkat akan diisi di sini -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="flex items-center gap-3 bg-gray-900 text-white text-sm font-semibold py-3 px-5 rounded-lg border border-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span id="toast-message"></span>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA SOURCE ---
        const rawData = {
            "Andi Aqillah Fadia Haswat": [{"id":1,"nama":"Adelio Daffa Syahrizha","kelas":"2A","program":"Unggulan"},{"id":2,"nama":"Ahmad Ahsanur Rizqi","kelas":"2A","program":"Unggulan"},{"id":3,"nama":"Arkana El Sabilly","kelas":"2A","program":"Unggulan"},{"id":4,"nama":"Athaya Auza'I Mubarak","kelas":"2A","program":"Unggulan"},{"id":5,"nama":"Dama Arza Evannova","kelas":"2A","program":"Unggulan"},{"id":6,"nama":"Danar Nizam Daniswara","kelas":"2A","program":"Unggulan"},{"id":7,"nama":"Devgan Jadid Sahlvatico","kelas":"2A","program":"Unggulan"},{"id":8,"nama":"Fariq Imtiyas Aufaa Kamil","kelas":"2A","program":"Unggulan"},{"id":9,"nama":"Firaas Izzulhaq","kelas":"2A","program":"Unggulan"},{"id":10,"nama":"Gilang Omar F","kelas":"2A","program":"Unggulan"},{"id":11,"nama":"Jaladri Arif Wirasena","kelas":"2A","program":"Unggulan"},{"id":12,"nama":"Kemal Mubarak Siregar","kelas":"2A","program":"Unggulan"},{"id":13,"nama":"Khairil Nizam","kelas":"2A","program":"Unggulan"},{"id":14,"nama":"Mirza Nasyath Ahza Attaillah","kelas":"2A","program":"Unggulan"},{"id":15,"nama":"Muhammad Farros Linggar Cahyono","kelas":"2A","program":"Unggulan"},{"id":16,"nama":"Muhammad Fathir Alfalah","kelas":"2A","program":"Unggulan"},{"id":17,"nama":"Narendra Wibawa","kelas":"2A","program":"Unggulan"},{"id":18,"nama":"Naufal Zhafran Purnama","kelas":"2A","program":"Unggulan"},{"id":19,"nama":"Ahmad Arkan Sya'Bani","kelas":"2A","program":"Tahfizh"},{"id":20,"nama":"Ahmad Darwis","kelas":"2A","program":"Tahfizh"},{"id":21,"nama":"Ahmad Ghozi El Muntazhor","kelas":"2A","program":"Tahfizh"},{"id":22,"nama":"Aldan 'Izzul Islam","kelas":"2A","program":"Tahfizh"},{"id":23,"nama":"Fawwaz Elfareza Zuhri","kelas":"2A","program":"Tahfizh"},{"id":24,"nama":"M. Fathan Alfarisi Harahap","kelas":"2A","program":"Tahfizh"},{"id":25,"nama":"Muhammad Ahsani Taqwim","kelas":"2A","program":"Tahfizh"},{"id":26,"nama":"Muhammad Ayyub Al Fatih","kelas":"2A","program":"Tahfizh"},{"id":27,"nama":"Muhammad Gibran Rafassya","kelas":"2A","program":"Tahfizh"},{"id":28,"nama":"Narendra Gerrardi Kusumah","kelas":"2A","program":"Tahfizh"},{"id":29,"nama":"Rijal Abdul A'Ziz","kelas":"2A","program":"Tahfizh"},{"id":30,"nama":"Rizki Chandra Dewantara","kelas":"2A","program":"Tahfizh"}],
            "Abdullah": [{"id":31,"nama":"Alano Faaiq Alfeno","kelas":"2B","program":"Unggulan"},{"id":32,"nama":"Arfandhika Fakhrul Islam","kelas":"2B","program":"Unggulan"},{"id":33,"nama":"Aydin Rafif","kelas":"2B","program":"Unggulan"},{"id":34,"nama":"Danish Alzahid Dinasti","kelas":"2B","program":"Unggulan"},{"id":35,"nama":"Ghani Arif Witjaksono","kelas":"2B","program":"Unggulan"},{"id":36,"nama":"Haidarrafid Satriaa Ardhani","kelas":"2B","program":"Unggulan"},{"id":37,"nama":"Iqbal Zulfikar Al Hanif","kelas":"2B","program":"Unggulan"},{"id":38,"nama":"Jangky Dausat","kelas":"2B","program":"Unggulan"},{"id":39,"nama":"Kumara Banyu Argani","kelas":"2B","program":"Unggulan"},{"id":40,"nama":"M. Dede Afkar","kelas":"2B","program":"Unggulan"},{"id":41,"nama":"Mekha Ilham Lutfianto","kelas":"2B","program":"Unggulan"},{"id":42,"nama":"Muhammad Aiman Naim","kelas":"2B","program":"Unggulan"},{"id":43,"nama":"Muhammad Karel Ashiddiq","kelas":"2B","program":"Unggulan"},{"id":44,"nama":"Naufal Fahmi Darsono","kelas":"2B","program":"Unggulan"},{"id":45,"nama":"Nazhif Fahreza Zuhairy","kelas":"2B","program":"Unggulan"},{"id":46,"nama":"Rais Abqari Ash Shidqi","kelas":"2B","program":"Unggulan"},{"id":47,"nama":"William Ramadhan Al Ghazali","kelas":"2B","program":"Unggulan"},{"id":48,"nama":"Zia El Ibrahim Aqeela Putra Wijaya","kelas":"2B","program":"Unggulan"},{"id":49,"nama":"Ahmad Miqdad","kelas":"2B","program":"Tahfizh"},{"id":50,"nama":"Dzaky Salman Al Farisi","kelas":"2B","program":"Tahfizh"},{"id":51,"nama":"Muhammad Alvi Mumtaz Brillian Hafizh","kelas":"2B","program":"Tahfizh"},{"id":52,"nama":"Muhammad Mahdi Hafidz","kelas":"2B","program":"Tahfizh"},{"id":53,"nama":"Muhammad Naufal Rasyid Arafi","kelas":"2B","program":"Tahfizh"},{"id":54,"nama":"Nahsif Ilman Hazim Purwono","kelas":"2B","program":"Tahfizh"},{"id":55,"nama":"Nawwaf Bahy Rafif","kelas":"2B","program":"Tahfizh"},{"id":56,"nama":"Nizar Adhyatma Aryanda","kelas":"2B","program":"Tahfizh"},{"id":57,"nama":"Rafa Agitananda Az Zayyan","kelas":"2B","program":"Tahfizh"},{"id":58,"nama":"Rafa Faeyza Fa'Iz","kelas":"2B","program":"Tahfizh"},{"id":59,"nama":"Rizqi Satria Putra Surya","kelas":"2B","program":"Tahfizh"},{"id":60,"nama":"Umar Ubaidillah Tsaqif","kelas":"2B","program":"Tahfizh"},{"id":61,"nama":"Wildan Faiz Mahendra","kelas":"2B","program":"Tahfizh"}],
            "Muhammad Zhafir Setiaji": [{"id":62,"nama":"Faiq Fauzil Adhim","kelas":"2C","program":"Tahfizh"},{"id":63,"nama":"Fairuz Azzam Mahfuzh","kelas":"2C","program":"Tahfizh"},{"id":64,"nama":"Muhammad Arkhan Attaqi","kelas":"2C","program":"Tahfizh"},{"id":65,"nama":"Muhammad Daffa Naufal Alaika","kelas":"2C","program":"Tahfizh"},{"id":66,"nama":"Muzakki Fairuzzaman","kelas":"2C","program":"Tahfizh"},{"id":67,"nama":"Neymar Tsaqif Hikmatyar","kelas":"2C","program":"Tahfizh"},{"id":68,"nama":"Rifqi Maliki","kelas":"2C","program":"Tahfizh"},{"id":69,"nama":"Yasykur Slamer'Abqariy","kelas":"2C","program":"Tahfizh"},{"id":70,"nama":"Zhafran Dhiaurrahman Hakim","kelas":"2C","program":"Tahfizh"},{"id":71,"nama":"Achmad Adi Darwis Elfaza","kelas":"2D","program":"Tahfizh"},{"id":72,"nama":"Galang Afkar Artyanto","kelas":"2D","program":"Tahfizh"},{"id":73,"nama":"Gilang Asytar Artyanto","kelas":"2D","program":"Tahfizh"},{"id":74,"nama":"Muhammad Alif Al-Fatih","kelas":"2D","program":"Tahfizh"},{"id":75,"nama":"Muhammad Faiz Ibnu Zakaria","kelas":"2D","program":"Tahfizh"},{"id":76,"nama":"Muhammad Mahdi Hanafi","kelas":"2D","program":"Tahfizh"},{"id":77,"nama":"Muhammad Muhdi Hafidz","kelas":"2D","program":"Tahfizh"},{"id":78,"nama":"Rizqi Ahmad Altaf Zafar","kelas":"2D","program":"Tahfizh"},{"id":79,"nama":"Dzaky Anthony Akbar","kelas":"2G","program":"Tahfizh"},{"id":80,"nama":"Muwafaqi Amru Ahmad","kelas":"2G","program":"Tahfizh"},{"id":81,"nama":"Abdul Ghani Irfan Rafif","kelas":"2H","program":"Tahfizh"},{"id":82,"nama":"Abid Fadhil Abiyah","kelas":"2H","program":"Tahfizh"},{"id":83,"nama":"Ahmad Dahlan Asy'Ari","kelas":"2H","program":"Tahfizh"},{"id":84,"nama":"Athallah Azmi Ghaisan Muhammad","kelas":"2H","program":"Tahfizh"},{"id":85,"nama":"Azmi Zulfadli Syafiq","kelas":"2H","program":"Tahfizh"},{"id":86,"nama":"Azri Labibul Khawarizmi","kelas":"2H","program":"Tahfizh"},{"id":87,"nama":"Dzar Al Ghifari","kelas":"2H","program":"Tahfizh"},{"id":88,"nama":"Fatihan Al Ghifari","kelas":"2H","program":"Tahfizh"},{"id":89,"nama":"Hisyam Nabil Pasha","kelas":"2H","program":"Tahfizh"},{"id":90,"nama":"Ibadillah Kaiazmi Mubarak","kelas":"2H","program":"Tahfizh"},{"id":91,"nama":"Kashvi Jabbar Azana","kelas":"2H","program":"Tahfizh"},{"id":92,"nama":"Khawarizmi Fakhrulhaq","kelas":"2H","program":"Tahfizh"},{"id":93,"nama":"Muh. Naufal Alif","kelas":"2H","program":"Tahfizh"},{"id":94,"nama":"Muhammad Aghna Ilman Rafa","kelas":"2H","program":"Tahfizh"},{"id":95,"nama":"Royyan Abdurrahman Ibtisam","kelas":"2H","program":"Tahfizh"},{"id":96,"nama":"Sakhi Arkan Elfariza","kelas":"2H","program":"Tahfizh"}]
        };
        
        const surahData = {
            '30': ["An-Naba'", "An-Nazi'at", "Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Insyiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghasyiyah", "Al-Fajr", "Al-Balad", "Asy-Syams", "Al-Lail", "Ad-Dhuha", "Asy-Syarh", "At-Tin", "Al-‘Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-‘Adiyat", "Al-Qari'ah", "At-Takasur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraisy", "Al-Ma'un", "Al-Kausar", "Al-Kafirun", "An-Nasr", "Al-Lahab", "Al-Ikhlas", "Al-Falaq", "An-Nas"],
            '29': ["Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzammil", "Al-Muddatstsir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat"],
            '28': ["Al-Mujadilah", "Al-Hasyr", "Al-Mumtahanah", "As-Shaff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "Ath-Thalaq", "At-Tahrim"]
        };
        
        const surahPageValues = {
            "An-Naba'": 1.5, "An-Nazi'at": 1.5, "Abasa": 1.0, "At-Takwir": 0.8, "Al-Infitar": 0.5, "Al-Mutaffifin": 1.0, "Al-Insyiqaq": 0.7, "Al-Buruj": 0.6, "At-Tariq": 0.4, "Al-A'la": 0.5, "Al-Ghasyiyah": 0.7, "Al-Fajr": 0.8, "Al-Balad": 0.5, "Asy-Syams": 0.4, "Al-Lail": 0.5, "Ad-Dhuha": 0.3, "Asy-Syarh": 0.2, "At-Tin": 0.2, "Al-‘Alaq": 0.5, "Al-Qadr": 0.2, "Al-Bayyinah": 0.3, "Az-Zalzalah": 0.2, "Al-‘Adiyat": 0.3, "Al-Qari'ah": 0.3, "At-Takasur": 0.2, "Al-Asr": 0.1, "Al-Humazah": 0.2, "Al-Fil": 0.2, "Quraisy": 0.1, "Al-Ma'un": 0.2, "Al-Kausar": 0.1, "Al-Kafirun": 0.2, "An-Nasr": 0.1, "Al-Lahab": 0.1, "Al-Ikhlas": 0.1, "Al-Falaq": 0.1, "An-Nas": 0.2,
            "Al-Mulk": 2.0, "Al-Qalam": 2.0, "Al-Haqqah": 1.8, "Al-Ma'arij": 1.5, "Nuh": 1.0, "Al-Jinn": 1.0, "Al-Muzammil": 0.8, "Al-Muddatstsir": 1.5, "Al-Qiyamah": 1.0, "Al-Insan": 1.0, "Al-Mursalat": 1.5,
            "Al-Mujadilah": 2.5, "Al-Hasyr": 2.5, "Al-Mumtahanah": 1.5, "As-Shaff": 1.0, "Al-Jumu'ah": 1.0, "Al-Munafiqun": 1.0, "At-Taghabun": 1.5, "Ath-Thalaq": 1.2, "At-Tahrim": 1.2
        };

        // --- DOM ELEMENTS ---
        const form = document.getElementById('setoranForm');
        const tanggalInput = document.getElementById('tanggal');
        const nowBtn = document.getElementById('nowBtn');
        const musyrifSelect = document.getElementById('musyrif');
        const santriSelect = document.getElementById('namaSantri');
        const kelasInput = document.getElementById('kelas');
        const programInput = document.getElementById('program');
        const jenisSelect = document.getElementById('jenis');
        const juzSelect = document.getElementById('juz');
        const halamanContainer = document.getElementById('halaman-container');
        const halamanInput = document.getElementById('halaman');
        const suratContainer = document.getElementById('surat-container');
        const suratSelect = document.getElementById('surat');
        const tableBody = document.getElementById('setoranTableBody');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const modal = document.getElementById('leaderboardModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalBackdrop = document.querySelector('.modal-backdrop');
        const leaderboardTabContainer = document.getElementById('leaderboard-tabs');
        const leaderboardTabContents = document.querySelectorAll('#leaderboard-content-container .tab-content');
        const rekapTabContainer = document.getElementById('rekap-tabs');
        const rekapTabContents = document.querySelectorAll('.rekap-tab-content');
        const mainNavLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page-content');

        
        // --- APP STATE ---
        let allSetoran = [];
        let santriData = [];
        let fullLeaderboards = { 
            unggulan: { terbanyak: [], terrajin: [], kualitas: [] },
            tahfizh: { terbanyak: [], terrajin: [], kualitas: [] }
        };

        // --- DATA INITIALIZATION ---
        function initializeData() {
            santriData = [];
            for (const musyrif in rawData) {
                rawData[musyrif].forEach(santri => {
                    santriData.push({
                        ...santri,
                        musyrif: musyrif,
                        setoranMutqin: new Set() // Gunakan Set untuk efisiensi
                    });
                });
            }
        }

        // --- HELPER FUNCTIONS ---
        function setCurrentDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            tanggalInput.value = now.toISOString().slice(0, 16);
        }

        function findSantriById(id) {
            return santriData.find(s => s.id == id);
        }

        function showToast(message) {
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function getKualitasSVG(kualitas) {
            const star = `<svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
            const emptyStar = `<svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
            let stars = '';
            switch(kualitas) {
                case 'Mumtaz': stars = star.repeat(5); break;
                case 'Jayyid Jiddan': stars = star.repeat(4) + emptyStar; break;
                case 'Jayyid': stars = star.repeat(3) + emptyStar.repeat(2); break;
                case 'Maqbul': stars = star.repeat(2) + emptyStar.repeat(3); break;
                case 'Dhoif': stars = star.repeat(1) + emptyStar.repeat(4); break;
                default: stars = emptyStar.repeat(5);
            }
            return `<div class="flex">${stars}</div>`;
        }
        
        function getProgramIcon(program) {
             return program === 'Unggulan'
                    ? `<span title="Unggulan" class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full bg-blue-100 text-blue-800 text-xs font-bold">U</span>`
                    : `<span title="Tahfizh" class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full bg-green-100 text-green-800 text-xs font-bold">T</span>`;
        }

        function getClassIcon(className) {
            return `<span title="Kelas ${className}" class="ml-1 inline-flex items-center justify-center h-5 w-5 rounded-full bg-gray-200 text-gray-700 text-xs font-bold">${className}</span>`;
        }

        // --- FORM LOGIC ---
        function populateMusyrif() {
            const musyrifOrder = ["Andi Aqillah Fadia Haswat", "Abdullah", "Muhammad Zhafir Setiaji"];
            musyrifSelect.innerHTML = '<option value="">Pilih Musyrif</option>';
            musyrifOrder.forEach(musyrif => {
                if (rawData[musyrif]) {
                    musyrifSelect.add(new Option(musyrif, musyrif));
                }
            });
        }

        function handleMusyrifChange() {
            const selectedMusyrif = musyrifSelect.value;
            santriSelect.innerHTML = '<option value="">Pilih Santri</option>';
            resetSantriFields();

            if (selectedMusyrif) {
                santriSelect.disabled = false;
                const filteredSantri = santriData
                    .filter(s => s.musyrif === selectedMusyrif)
                    .sort((a, b) => a.nama.localeCompare(b.nama));
                
                filteredSantri.forEach(santri => {
                    santriSelect.add(new Option(santri.nama, santri.id));
                });
            } else {
                santriSelect.disabled = true;
                santriSelect.innerHTML = '<option value="">Pilih Musyrif dahulu</option>';
            }
        }
        
        function handleSantriChange() {
            const santriId = santriSelect.value;
            resetSantriFields(true);
            const santri = findSantriById(santriId);
            
            if (santri) {
                kelasInput.value = santri.kelas;
                programInput.value = santri.program;
                updateJenisOptions(santri);
            }
        }
        
        function updateJenisOptions(santri) {
            jenisSelect.disabled = false;
            jenisSelect.innerHTML = '<option value="">Pilih Jenis</option>';
            
            const hasCompletedBasicMutqin = santri.setoranMutqin.has(29) && santri.setoranMutqin.has(30);

            if (santri.program === "Unggulan" || (santri.program === "Tahfizh" && hasCompletedBasicMutqin)) {
                 jenisSelect.add(new Option("Ziyadah", "Ziyadah"));
            }
            
            jenisSelect.add(new Option("Mutqin", "Mutqin"));

            if (santri.program === "Tahfizh" && !hasCompletedBasicMutqin) {
                const ziyadahOption = new Option("Ziyadah (selesaikan Mutqin 29 & 30 dulu)", "Ziyadah_disabled");
                ziyadahOption.disabled = true;
                jenisSelect.add(ziyadahOption);
            }
        }

        function handleJenisChange() {
            const jenis = jenisSelect.value;
            const santri = findSantriById(santriSelect.value);

            juzSelect.innerHTML = '<option value="">Pilih Juz</option>';
            juzSelect.disabled = true;
            resetSetoranInputs();

            if (!jenis || !santri) return;

            juzSelect.disabled = false;
            
            if (jenis === "Mutqin") {
                for (let i = 1; i <= 30; i++) {
                    if (!santri.setoranMutqin.has(i)) {
                        juzSelect.add(new Option(`Juz ${i}`, i));
                    }
                }
            } else if (jenis === "Ziyadah") {
                for (let i = 1; i <= 30; i++) {
                    juzSelect.add(new Option(`Juz ${i}`, i));
                }
            }
            handleJuzChange();
        }

        function handleJuzChange() {
            const jenis = jenisSelect.value;
            const juz = parseInt(juzSelect.value);

            resetSetoranInputs();

            if (jenis === 'Ziyadah') {
                if ([28, 29, 30].includes(juz)) {
                    suratContainer.classList.remove('hidden');
                    suratSelect.required = true;
                    populateSurat(juz);
                } else {
                    halamanContainer.classList.remove('hidden');
                    halamanInput.required = true;
                    halamanInput.disabled = false;
                    halamanInput.placeholder = 'Tulis jumlah halaman';
                }
            } else if (jenis === 'Mutqin') {
                halamanContainer.classList.remove('hidden');
                halamanInput.required = false;
                halamanInput.disabled = false;
                halamanInput.placeholder = 'Min 5 hlm / Kosongkan utk 1 Juz';
                halamanInput.min = 5;
            }
        }

        function populateSurat(juz) {
            suratSelect.innerHTML = '<option value="">Pilih Surat</option>';
            const surahs = surahData[juz] || [];
            surahs.forEach(surah => {
                suratSelect.add(new Option(surah, surah));
            });
        }
        
        function resetSantriFields(keepStatic = false) {
             if (!keepStatic) {
                kelasInput.value = '';
                programInput.value = '';
             }
            jenisSelect.innerHTML = '<option value="">Pilih Santri dahulu</option>';
            jenisSelect.disabled = true;
            juzSelect.innerHTML = '<option value="">Pilih Jenis dahulu</option>';
            juzSelect.disabled = true;
            resetSetoranInputs();
        }

        function resetSetoranInputs() {
            halamanContainer.classList.add('hidden');
            suratContainer.classList.add('hidden');
            halamanInput.disabled = true;
            halamanInput.required = false;
            halamanInput.value = '';
            halamanInput.placeholder = 'Tulis jumlah halaman...';
            halamanInput.min = 1;
            suratSelect.required = false;
            suratSelect.innerHTML = '';
        }

        function resetFormState() {
            form.reset();
            setCurrentDateTime();
            musyrifSelect.value = "";
            santriSelect.innerHTML = '<option value="">Pilih Musyrif dahulu</option>';
            santriSelect.disabled = true;
            kelasInput.value = '';
            programInput.value = '';
            resetSantriFields();
        }

        function renderTable() {
            tableBody.innerHTML = '';
            if (allSetoran.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-gray-500">Belum ada data setoran.</td></tr>';
                 return;
            }

            const sortedSetoran = [...allSetoran].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).slice(0, 20);

            sortedSetoran.forEach((setoran, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors fade-in';
                if (index === 0) {
                    row.classList.add('highlight-new-row');
                }
                const santri = findSantriById(setoran.santriId);
                const programIcon = getProgramIcon(setoran.program);
                const classIcon = getClassIcon(santri ? santri.kelas : '');


                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="font-medium text-gray-900">${setoran.namaSantri}</div>
                            ${programIcon}
                            ${classIcon}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <div>${setoran.jenis} Juz ${setoran.juz}</div>
                        <div class="text-xs text-gray-500">${setoran.setoranUnit}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${getKualitasSVG(setoran.kualitas)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${new Date(setoran.tanggal).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function calculateAndDisplayStats() {
            const stats = { unggulan: {}, tahfizh: {} };
            const kualitasMap = { 'Mumtaz': 5, 'Jayyid Jiddan': 4, 'Jayyid': 3, 'Maqbul': 2, 'Dhoif': 1 };

            allSetoran.forEach(s => {
                const santri = findSantriById(s.santriId);
                const programKey = s.program.toLowerCase();
                if (!stats[programKey] || !santri) return;

                if (!stats[programKey][s.santriId]) {
                    stats[programKey][s.santriId] = { nama: s.namaSantri, program: s.program, kelas: santri.kelas, totalHalaman: 0, frekuensi: 0, totalKualitas: 0 };
                }
                
                let halaman = 0;
                if (s.setoranUnit === '1 Juz') {
                    halaman = 20;
                } else if (s.setoranUnit.includes('halaman')) {
                    halaman = parseFloat(s.setoranUnit) || 0;
                } else {
                    halaman += surahPageValues[s.setoranUnit] || 0;
                }
                
                stats[programKey][s.santriId].totalHalaman += halaman;
                stats[programKey][s.santriId].frekuensi += 1;
                stats[programKey][s.santriId].totalKualitas += kualitasMap[s.kualitas] || 0;
            });
            
            ['unggulan', 'tahfizh'].forEach(programKey => {
                const statsArray = Object.values(stats[programKey]);
                fullLeaderboards[programKey].terbanyak = [...statsArray].sort((a, b) => b.totalHalaman - a.totalHalaman);
                fullLeaderboards[programKey].terrajin = [...statsArray].sort((a, b) => b.frekuensi - a.frekuensi);
                fullLeaderboards[programKey].kualitas = [...statsArray]
                    .filter(a => a.frekuensi > 0)
                    .sort((a, b) => (b.totalKualitas / b.frekuensi) - (a.totalKualitas / a.frekuensi));
                
                displayLeaderboard(programKey, 'terbanyak', fullLeaderboards[programKey].terbanyak.slice(0, 10));
                displayLeaderboard(programKey, 'terrajin', fullLeaderboards[programKey].terrajin.slice(0, 10));
                displayLeaderboard(programKey, 'kualitas', fullLeaderboards[programKey].kualitas.slice(0, 10));
            });
        }

        function displayLeaderboard(program, category, data) {
            const listEl = document.getElementById(`stats-${program}-${category}-list`);
            listEl.innerHTML = '';
            if (data.length === 0) {
                listEl.innerHTML = '<p class="text-sm text-gray-500">Belum ada data.</p>';
                return;
            }
            const emojiMap = {1: '🥇', 2: '🥈', 3: '🥉'};

            data.forEach((item, index) => {
                const rank = index + 1;
                const emoji = emojiMap[rank] || `<span class="font-normal text-gray-400 w-6 text-center">${rank}.</span>`;
                let valueText = '';
                if (category === 'terbanyak') valueText = `${item.totalHalaman.toFixed(1)} hlm`;
                else if (category === 'terrajin') valueText = `${item.frekuensi}x setor`;
                else if (category === 'kualitas') valueText = `Avg: ${(item.totalKualitas / item.frekuensi).toFixed(2)}`;
                
                const itemEl = document.createElement('div');
                itemEl.className = 'text-sm flex justify-between items-center';
                itemEl.innerHTML = `
                    <span class="font-semibold text-gray-700 truncate flex items-center">
                        <span class="mr-2 w-6 inline-block text-center">${emoji}</span>
                        ${item.nama}
                        ${getProgramIcon(item.program)}
                        ${getClassIcon(item.kelas)}
                    </span>
                    <span class="text-gray-500 font-medium">${valueText}</span>
                `;
                listEl.appendChild(itemEl);
            });
        }
        
        function renderMusyrifRecap() {
            const classGroups = {
                '2A': { santri: santriData.filter(s => s.kelas === '2A'), musyrif: "Andi Aqillah Fadia Haswat" },
                '2B': { santri: santriData.filter(s => s.kelas === '2B'), musyrif: "Abdullah" },
                '2CDGH': { santri: santriData.filter(s => ['2C', '2D', '2G', '2H'].includes(s.kelas)), musyrif: "Muhammad Zhafir Setiaji" }
            };

            for (const groupName in classGroups) {
                const headerContainer = document.getElementById(`rekap-header-${groupName}`);
                const listContainer = document.getElementById(`rekap-list-${groupName}`);
                if (!headerContainer || !listContainer) continue;
                
                const group = classGroups[groupName];
                const timestamp = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });

                headerContainer.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <div>
                            <h3 class="font-bold text-amber-700 text-lg">Rekap Capaian Tahfizh - Kelas ${groupName}</h3>
                            <p class="text-sm text-gray-500">Musyrif: ${group.musyrif}</p>
                            <p class="text-xs text-gray-400">${timestamp}</p>
                        </div>
                        <button data-class-group="${groupName}" class="export-pdf-btn mt-3 sm:mt-0 bg-green-100 text-green-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors">Ekspor ke PDF</button>
                    </div>
                `;

                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skor</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                `;
                const tbody = table.querySelector('tbody');
                
                const santriInGroup = group.santri.sort((a,b) => a.nama.localeCompare(b.nama));

                if (santriInGroup.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500">Tidak ada santri di kelas ini.</p>';
                    continue;
                }

                santriInGroup.forEach((santri, index) => {
                    const allSantriSetoran = allSetoran.filter(s => s.santriId === santri.id);
                    let totalHalaman = 0;
                    allSantriSetoran.forEach(s => {
                        if (s.setoranUnit === '1 Juz') totalHalaman += 20;
                        else if (s.setoranUnit.includes('halaman')) totalHalaman += parseFloat(s.setoranUnit) || 0;
                        else totalHalaman += surahPageValues[s.setoranUnit] || 0;
                    });
                    
                    const isTuntas = santri.setoranMutqin.size >= 30;
                    const keterangan = isTuntas 
                        ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Tuntas</span>`
                        : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Belum</span>`;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap">${index + 1}</td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="flex items-center">
                                ${santri.nama}
                                ${getProgramIcon(santri.program)}
                            </div>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap font-medium">${totalHalaman.toFixed(1)}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${keterangan}</td>
                    `;
                    tbody.appendChild(row);
                });

                listContainer.innerHTML = '';
                listContainer.appendChild(table);
            }
        }

        function openModal(program, category) {
            const titles = {
                terbanyak: '📚 Peringkat Halaman Terbanyak',
                terrajin: '🏃‍♂️ Peringkat Paling Rajin',
                kualitas: '⭐ Peringkat Kualitas Terbaik'
            };
            modalTitle.textContent = `${titles[category]} (${program.charAt(0).toUpperCase() + program.slice(1)})`;
            
            const fullData = fullLeaderboards[program][category];
            modalBody.innerHTML = '';
            
            if (fullData.length === 0) {
                modalBody.innerHTML = '<p class="text-center text-gray-500">Tidak ada data untuk ditampilkan.</p>';
            } else {
                const listContainer = document.createElement('ol');
                listContainer.className = 'space-y-3';
                fullData.forEach((item, index) => {
                    let valueText = '';
                    if (category === 'terbanyak') valueText = `${item.totalHalaman.toFixed(1)} halaman`;
                    else if (category === 'terrajin') valueText = `${item.frekuensi} setoran`;
                    else if (category === 'kualitas') valueText = `Rata-rata: ${(item.totalKualitas / item.frekuensi).toFixed(2)}`;

                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between text-gray-700 pb-2 border-b border-gray-100';
                    listItem.innerHTML = `
                        <div>
                            <span class="font-bold mr-3 w-6 inline-block text-center">${index + 1}.</span>
                            <span>${item.nama}</span>
                        </div>
                        <span class="font-semibold text-gray-600">${valueText}</span>
                    `;
                    listContainer.appendChild(listItem);
                });
                modalBody.appendChild(listContainer);
            }
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(form);
            const setoranData = Object.fromEntries(formData.entries());
            
            const santriId = setoranData.namaSantri;
            const santri = findSantriById(santriId);
            if (!santri) {
                showToast('Error: Santri tidak ditemukan!');
                return;
            }

            setoranData.santriId = santri.id;
            setoranData.namaSantri = santri.nama;
            setoranData.musyrif = santri.musyrif;
            setoranData.program = santri.program;
            setoranData.id = Date.now();

            const juz = parseInt(setoranData.juz);
            if (setoranData.jenis === 'Ziyadah' && [28, 29, 30].includes(juz)) {
                if(!setoranData.surat || setoranData.surat === '') {
                    showToast('Error: Silakan pilih surat.');
                    return;
                }
                setoranData.setoranUnit = setoranData.surat;
            } else if (setoranData.jenis === 'Mutqin' && !setoranData.halaman) {
                setoranData.setoranUnit = '1 Juz';
            } else {
                if (!setoranData.halaman) {
                    showToast('Error: Jumlah halaman harus diisi.');
                    return;
                }
                setoranData.setoranUnit = `${setoranData.halaman} halaman`;
            }

            allSetoran.push(setoranData);

            if (setoranData.jenis === 'Mutqin' && !setoranData.halaman) {
                santri.setoranMutqin.add(parseInt(setoranData.juz));
            }

            renderTable();
            calculateAndDisplayStats();
            renderMusyrifRecap();
            showToast('Setoran berhasil disimpan!');
            resetFormState();
        }

        function exportRecapToPDF(classGroup) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const classGroups = {
                '2A': { title: 'Kelas 2A', santri: santriData.filter(s => s.kelas === '2A') },
                '2B': { title: 'Kelas 2B', santri: santriData.filter(s => s.kelas === '2B') },
                '2CDGH': { title: 'Kelas 2CDGH', santri: santriData.filter(s => ['2C', '2D', '2G', '2H'].includes(s.kelas)) }
            };

            const group = classGroups[classGroup];
            const title = `Rekap Setoran ${group.title}`;
            const timestamp = `Dibuat pada: ${new Date().toLocaleString('id-ID')}`;
            
            doc.setFontSize(18);
            doc.text(title, 14, 22);
            doc.setFontSize(11);
            doc.text(timestamp, 14, 30);

            const tableData = group.santri.sort((a,b) => a.nama.localeCompare(b.nama)).map((santri, index) => {
                const allSantriSetoran = allSetoran.filter(s => s.santriId === santri.id);
                let totalHalaman = 0;
                allSantriSetoran.forEach(s => {
                    if (s.setoranUnit === '1 Juz') totalHalaman += 20;
                    else if (s.setoranUnit.includes('halaman')) totalHalaman += parseFloat(s.setoranUnit) || 0;
                    else totalHalaman += surahPageValues[s.setoranUnit] || 0;
                });
                const isTuntas = santri.setoranMutqin.size >= 30;
                return [index + 1, santri.nama, totalHalaman.toFixed(1), isTuntas ? 'Tuntas' : 'Belum Tuntas'];
            });

            doc.autoTable({
                startY: 35,
                head: [['No.', 'Nama Santri', 'Total Halaman', 'Keterangan']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [245, 158, 11] } // amber-500
            });

            doc.save(`rekap_setoran_${classGroup}.pdf`);
        }

        // --- EVENT LISTENERS ---
        nowBtn.addEventListener('click', setCurrentDateTime);
        musyrifSelect.addEventListener('change', handleMusyrifChange);
        santriSelect.addEventListener('change', handleSantriChange);
        jenisSelect.addEventListener('change', handleJenisChange);
        juzSelect.addEventListener('change', handleJuzChange);
        form.addEventListener('submit', handleFormSubmit);
        
        mainNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = e.currentTarget.dataset.page;

                pages.forEach(page => {
                    page.classList.add('hidden');
                });
                document.getElementById(pageId).classList.remove('hidden');

                mainNavLinks.forEach(nav => nav.classList.remove('active'));
                e.currentTarget.classList.add('active');
            });
        });

        leaderboardTabContainer.addEventListener('click', (e) => {
            if (e.target.matches('.tab-btn')) {
                leaderboardTabContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                leaderboardTabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`tab-${e.target.dataset.tab}`).classList.remove('hidden');
            }
        });

        rekapTabContainer.addEventListener('click', (e) => {
            if (e.target.matches('.rekap-tab-btn')) {
                rekapTabContainer.querySelectorAll('.rekap-tab-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                rekapTabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`rekap-tab-${e.target.dataset.tab}`).classList.remove('hidden');
            }
        });

        document.querySelectorAll('.see-all-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const { category, program } = e.target.dataset;
                openModal(program, category);
            });
        });

        document.querySelectorAll('.export-pdf-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                exportRecapToPDF(e.target.dataset.classGroup);
            });
        });

        closeModalBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);

        // --- INITIALIZATION ---
        function init() {
            initializeData();
            setCurrentDateTime();
            populateMusyrif();
            renderTable();
            calculateAndDisplayStats();
            renderMusyrifRecap();
            resetFormState();
        }

        init();
    });
    </script>
</body>
</html>
