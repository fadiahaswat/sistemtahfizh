<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setor.in - Aplikasi Setoran Hafalan (Optimized)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1f2937; }
        .glass-card, .glass-modal-content { background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        .glass-nav { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-color: rgba(230, 230, 230, 0.7) !important; }
        .glass-input { background-color: rgba(255, 255, 255, 0.5) !important; border: 1px solid rgba(209, 213, 219, 0.8) !important; }
        .glass-input:focus { background-color: rgba(255, 255, 255, 0.8) !important; border-color: #f59e0b !important; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3); }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active { background-color: rgba(251, 191, 36, 0.1); color: #d97706; font-weight: 600; }
        .nav-link.active svg { color: #d97706; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
        .skeleton { background-color: #e5e7eb; background-image: linear-gradient(to right, #e5e7eb 0%, #f3f4f6 20%, #e5e7eb 40%, #e5e7eb 100%); background-repeat: no-repeat; background-size: 800px 100%; animation: shimmer 1.2s linear infinite; }
        #toast { transition: transform 0.5s ease, opacity 0.5s ease; opacity: 0; transform: translate(-50%, 100px); }
        #toast.show { opacity: 1; transform: translate(-50%, 0); }
        .modal { transition: opacity 0.3s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal.hidden .modal-content { opacity: 0; transform: translateY(-20px); }
        .accordion-panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; padding: 0; }
        .progress-ring-circle { transition: stroke-dashoffset 0.8s ease-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        #main-content { position: relative; }
        .skeleton-container { position: absolute; inset: 0; background: #f8fafc; z-index: 20; overflow: hidden; }
        .sortable .sort-icon { opacity: 0.5; display: inline-block; width: 1em; text-align: center; transition: opacity 0.2s; }
        .sortable:hover .sort-icon { opacity: 1; }
        .sortable[data-sort-dir] .sort-icon { opacity: 1; }
    </style>
</head>
<body class="text-gray-900">
    <div class="sm:flex min-h-screen">
        <nav class="fixed bottom-0 left-0 w-full border-t sm:relative sm:w-64 sm:flex-shrink-0 sm:border-r sm:border-t-0 z-30 glass-nav">
            <div class="flex sm:flex-col sm:py-4 sm:px-3 h-full">
                <div class="hidden sm:flex items-center gap-3 p-3 mb-4">
                    <div class="bg-amber-500 p-2 rounded-lg text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></div>
                    <span class="font-bold text-lg text-gray-900">Setor.in</span>
                </div>
                <div id="main-nav" class="flex sm:flex-col w-full">
                    <a href="#" data-page="page-beranda" class="nav-link active flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-600 hover:text-amber-700 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span class="text-xs sm:text-sm">Beranda</span></a>
                    <a href="#" data-page="page-form" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-600 hover:text-amber-700 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span class="text-xs sm:text-sm">Input</span></a>
                    <a href="#" data-page="page-riwayat" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-600 hover:text-amber-700 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg><span class="text-xs sm:text-sm">Riwayat</span></a>
                    <a href="#" data-page="page-rekap" class="nav-link flex-1 sm:flex-none flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-1 sm:gap-3 p-2 sm:p-3 text-sm font-medium text-gray-600 hover:text-amber-700 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="text-xs sm:text-sm">Rekap</span></a>
                </div>
            </div>
        </nav>

        <main id="main-content" class="flex-1 pb-20 sm:pb-0 overflow-y-auto">
            <div id="skeleton-page-beranda" class="skeleton-container p-8 space-y-8"><div class="h-40 skeleton rounded-2xl"></div><div class="h-40 skeleton rounded-2xl"></div><div class="h-48 skeleton rounded-2xl"></div><div class="h-32 skeleton rounded-2xl"></div></div>
            <div id="page-beranda" class="page-content p-4 sm:p-6 lg:p-8">
                <div class="max-w-7xl mx-auto space-y-8">
                    <header class="fade-in">
                         <div class="flex flex-col lg:grid lg:grid-cols-4 lg:grid-rows-2 gap-4">
                            <div id="datetime-container" class="order-1 lg:col-span-2 bg-white/50 border border-gray-200/80 p-6 rounded-2xl flex items-center justify-center transition-transform hover:scale-105 duration-300"></div>
                            <div class="order-2 lg:order-none md:col-span-2 lg:col-span-2 lg:row-span-2 bg-gradient-to-br from-amber-400 to-orange-500 text-white p-6 rounded-2xl flex flex-col justify-between transition-transform hover:scale-105 duration-300">
                                <div><h2 class="text-lg font-medium opacity-90 mb-2">Assalamu 'alaikum ustadz,</h2><h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Selamat Datang di Setor.in</h1><p class="mt-4 text-base opacity-90 max-w-md">Catat setiap setoran, rayakan setiap kemajuan.</p></div>
                                <div class="flex items-center gap-3 mt-6"><div class="bg-white/20 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></div><span class="font-bold text-lg">Setor.in</span></div>
                            </div>
                            <button data-target-page="page-form" class="order-3 lg:order-none lg:col-span-2 bg-gradient-to-br from-gray-800 to-gray-900 text-white p-6 rounded-2xl text-left flex flex-col justify-between group transition-all duration-300 hover:shadow-2xl hover:scale-[1.03]">
                                <div>
                                    <h3 class="text-2xl font-bold">Input Setoran Baru</h3>
                                    <p class="text-gray-300 mt-1">Catat kemajuan hafalan santri.</p>
                                </div>
                                <div class="flex justify-end">
                                    <div class="bg-amber-500 p-3 rounded-full group-hover:bg-amber-400 group-hover:rotate-12 transition-all duration-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                    </div>
                                </div>
                            </button>
                         </div>
                    </header>
                    <section class="fade-in" style="animation-delay: 100ms;">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>Statistik Umum</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
                                <div class="bg-white/20 p-3 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold opacity-90">Santri Aktif</p>
                                    <p id="stats-santri-aktif" class="text-2xl font-bold">0 / 0</p>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
                                <div class="bg-white/20 p-3 rounded-full">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold opacity-90">Sudah Tuntas</p>
                                    <p id="stats-santri-tuntas" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
                                <div class="bg-white/20 p-3 rounded-full">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold opacity-90">Belum Tuntas</p>
                                    <p id="stats-santri-belum-tuntas" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section id="target-ketuntasan-section" class="fade-in" style="animation-delay: 200ms;"><h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 19v-8.25A4.5 4.5 0 017.5 6.5h9a4.5 4.5 0 014.5 4.5v8.25m-16.5 0h16.5m-16.5 0l1.65 1.65m13.2-1.65l-1.65 1.65" /></svg>Target Ketuntasan</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="p-5 rounded-xl bg-gradient-to-br from-sky-500 to-indigo-600 text-white shadow-lg flex flex-col justify-between"><div><div class="flex items-center gap-3"><div class="bg-white/20 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg></div><h4 class="text-lg font-bold">A. Ketuntasan Wajib</h4></div><p class="text-sm opacity-90 mt-2">Mutqin Setengah Juz 30 (An-Naba' s.d. Ath-Thariq) untuk nilai 100.</p></div><div class="text-xs font-semibold mt-4 opacity-80">Berlaku untuk: Unggulan & Tahfizh</div></div><div class="p-5 rounded-xl bg-gradient-to-br from-purple-500 to-fuchsia-600 text-white shadow-lg flex flex-col justify-between"><div><div class="flex items-center gap-3"><div class="bg-white/20 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg></div><h4 class="text-lg font-bold">B. Ketuntasan Program Tahfizh</h4></div><p class="text-sm opacity-90 mt-2">Wajib menyelesaikan Mutqin Juz 30 & Juz 29 secara penuh.</p></div><div class="text-xs font-semibold mt-4 opacity-80">Berlaku untuk: Program Tahfizh</div></div></div></section>
                    <section class="fade-in" style="animation-delay: 500ms;"><h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>Progres Ketuntasan Juz Wajib</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div id="mutqin-unggulan-progress-container" class="hidden p-5 rounded-xl glass-card flex flex-col items-center justify-center text-center"><div id="mutqin-unggulan-circle" class="relative w-28 h-28"></div><h3 class="text-lg font-bold text-sky-800 mt-3 mb-1">Santri Unggulan (1/2 Juz 30)</h3><p id="mutqin-unggulan-details" class="text-xs text-sky-700"></p></div><div id="mutqin-juz30-progress-container" class="hidden p-5 rounded-xl glass-card flex flex-col items-center justify-center text-center"><div id="mutqin-juz30-circle" class="relative w-28 h-28"></div><h3 class="text-lg font-bold text-green-800 mt-3 mb-1">Tahfizh (Mutqin Juz 30)</h3><p id="mutqin-juz30-details" class="text-xs text-green-700"></p></div><div id="mutqin-juz29-progress-container" class="hidden p-5 rounded-xl glass-card flex flex-col items-center justify-center text-center"><div id="mutqin-juz29-circle" class="relative w-28 h-28"></div><h3 class="text-lg font-bold text-amber-800 mt-3 mb-1">Tahfizh (Mutqin Juz 29)</h3><p id="mutqin-juz29-details" class="text-xs text-amber-700"></p></div></div></section>
                    <section id="tuntas-tracking-section" class="fade-in" style="animation-delay: 700ms;"><h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>Lacak Ketuntasan per Kelas</h3><div id="tuntas-tracking-accordion" class="space-y-2"></div></section>
                    <footer class="text-center py-8 mt-8"><div class="bg-gray-800 text-white p-6 rounded-2xl shadow-lg"><div class="flex justify-center items-center gap-3 mb-3"><div class="bg-amber-500 p-2 rounded-lg text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></div><span class="font-bold text-lg">Setor.in</span></div><p class="text-sm text-gray-300">Dibuat untuk Asrama 1 Abu Bakar Ash-Shiddiq.</p><p class="text-xs text-gray-400 mt-2">&copy; 2025 - Hak Cipta Dilindungi.</p></div></footer>
                </div>
            </div>

            <div id="skeleton-page-form" class="skeleton-container hidden p-8 space-y-6"><div class="h-12 w-3/4 skeleton rounded-lg"></div><div class="h-48 skeleton rounded-2xl"></div><div class="h-64 skeleton rounded-2xl"></div></div>
            <div id="page-form" class="page-content hidden p-4 sm:p-6 lg:p-8">
                 <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8 fade-in"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> Formulir Setoran Baru</h2><p class="text-gray-700 mt-2 sm:pl-11">Catat kemajuan hafalan santri dengan mudah.</p></div>
                 <form id="setoranForm" class="max-w-2xl mx-auto flex flex-col gap-6">
                    <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 50ms;"><fieldset><legend class="flex items-center gap-3 text-lg font-semibold text-blue-800 mb-4 border-b border-white/30 pb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Informasi Dasar</legend><div><label for="tanggal" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg><span>Tanggal & Waktu</span></label><input type="datetime-local" id="tanggal" name="tanggal" class="w-full mt-1 p-3 rounded-lg transition-all glass-input" required><div class="text-right mt-2"><button type="button" id="nowBtn" class="text-xs text-amber-700 hover:underline">Gunakan waktu sekarang</button></div></div></fieldset></div>
                    <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 150ms;"><fieldset><legend class="flex items-center gap-3 text-lg font-semibold text-green-800 mb-4 border-b border-white/30 pb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>Detail Santri</legend><div class="flex flex-col gap-5"><div><label for="musyrif" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg><span>Musyrif</span></label><select id="musyrif" name="musyrif" class="w-full mt-1 p-3 rounded-lg transition-all glass-input" required><option value="">Pilih Musyrif</option></select></div><div><label for="namaSantri" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg><span>Nama Santri</span></label><select id="namaSantri" name="namaSantri" class="w-full mt-1 p-3 rounded-lg transition-all disabled:bg-gray-200/50 disabled:cursor-not-allowed disabled:opacity-70 glass-input" required disabled><option value="">Pilih Musyrif dahulu</option></select><input type="hidden" id="santriId" name="santriId"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-5"><div><label for="kelas" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg><span>Kelas</span></label><input type="text" id="kelas" name="kelas" class="w-full mt-1 p-3 rounded-lg disabled:bg-gray-200/50 glass-input" readonly disabled></div><div><label for="program" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm2 1v2h6V5H7zm0 4v2h6V9H7zm0 4v2h6v-2H7z" /></svg><span>Program</span></label><input type="text" id="program" name="program" class="w-full mt-1 p-3 rounded-lg disabled:bg-gray-200/50 glass-input" readonly disabled></div></div></div></fieldset></div>
                    <div class="p-6 sm:p-8 fade-in glass-card rounded-2xl" style="animation-delay: 250ms;"><fieldset><legend class="flex items-center gap-3 text-lg font-semibold text-amber-800 mb-4 border-b border-white/30 pb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>Detail Setoran</legend><div class="flex flex-col gap-5"><div class="grid grid-cols-1 sm:grid-cols-2 gap-5"><div><label for="jenis" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg><span>Jenis</span></label><select id="jenis" name="jenis" class="w-full mt-1 p-3 rounded-lg transition-all disabled:bg-gray-200/50 glass-input" required disabled><option value="">Pilih Santri</option></select></div><div><label for="juz" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" /></svg><span>Juz</span></label><select id="juz" name="juz" class="w-full mt-1 p-3 rounded-lg transition-all disabled:bg-gray-200/50 glass-input" required disabled><option value="">Pilih Jenis</option></select></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-5"><div id="halaman-container" class="hidden"><label for="halaman" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg><span>Halaman</span></label><input type="number" id="halaman" name="halaman" min="1" class="w-full mt-1 p-3 rounded-lg transition-all disabled:bg-gray-200/50 glass-input" required disabled></div><div id="surat-container" class="hidden"><label for="surat" class="flex items-center gap-2 text-sm font-medium text-gray-800 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804V4.804A7.968 7.968 0 0014.5 4z" /></svg><span>Surat</span></label><select id="surat" name="surat" class="w-full mt-1 p-3 rounded-lg transition-all glass-input" required></select></div></div></div><input type="hidden" id="kualitas" name="kualitas" value="Mumtaz"></fieldset></div>
                    <div class="mt-2"><button type="submit" class="group inline-flex items-center justify-center gap-2 bg-gradient-to-br from-amber-500 to-orange-500 text-white font-bold py-3 px-8 rounded-lg hover:from-amber-600 hover:to-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 w-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300 group-hover:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>Simpan Setoran</button></div>
                 </form>
            </div>

            <div id="skeleton-page-riwayat" class="skeleton-container hidden p-8 space-y-6"><div class="h-12 w-3/4 skeleton rounded-lg"></div><div class="h-24 skeleton rounded-2xl"></div><div class="h-96 skeleton rounded-2xl"></div></div>
            <div id="page-riwayat" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg> Riwayat Setoran</h2><p class="text-gray-700 mt-2 sm:pl-11">Cari dan filter 50 riwayat setoran terakhir.</p></div>
                    <div class="p-4 rounded-xl mb-6 grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4 items-end glass-card"><div class="lg:col-span-1"><label for="search-riwayat" class="text-sm font-medium text-gray-800">Cari Santri</label><div class="relative"><input type="search" id="search-riwayat" placeholder="Ketik nama..." class="w-full mt-1 p-2 rounded-lg glass-input" autocomplete="off"><div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg hidden"></div></div></div><div><label for="filter-program" class="text-sm font-medium text-gray-800">Program</label><select id="filter-program" class="w-full mt-1 p-2 rounded-lg glass-input"><option value="Semua">Semua Program</option><option value="Tahfizh">Tahfizh</option><option value="Unggulan">Unggulan</option></select></div><div><label for="filter-kelas" class="text-sm font-medium text-gray-800">Kelas</label><select id="filter-kelas" class="w-full mt-1 p-2 rounded-lg glass-input"><option value="Semua">Semua Kelas</option><option value="2A">2A</option><option value="2B">2B</option><option value="2C">2C</option><option value="2D">2D</option><option value="2G">2G</option><option value="2H">2H</option><option value="2CDGH">2CDGH</option></select></div><div><label for="filter-tanggal-mulai" class="text-sm font-medium text-gray-800">Dari</label><input type="date" id="filter-tanggal-mulai" class="w-full mt-1 p-2 rounded-lg glass-input"></div><div><label for="filter-tanggal-akhir" class="text-sm font-medium text-gray-800">Sampai</label><input type="date" id="filter-tanggal-akhir" class="w-full mt-1 p-2 rounded-lg glass-input"></div></div>
                    <div id="icon-legend-riwayat" class="mb-6"></div>
                    <div id="content-riwayat" class="rounded-2xl overflow-hidden glass-card overflow-x-auto"><table class="min-w-full"><thead class="glass-nav border-b border-white/30 sticky top-0 z-10"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Santri</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Detail</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider hidden sm:table-cell">Tanggal</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="setoranTableBody" class="divide-y divide-gray-200/60"></tbody></table></div>
                </div>
            </div>
            
            <div id="skeleton-page-rekap" class="skeleton-container hidden p-8 space-y-6"><div class="h-12 w-3/4 skeleton rounded-lg"></div><div class="h-12 skeleton rounded-2xl"></div><div class="h-96 skeleton rounded-2xl"></div></div>
            <div id="page-rekap" class="page-content hidden p-4 sm:p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center sm:text-left pt-12 sm:pt-0 mb-8"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 justify-center sm:justify-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> Rekapitulasi Setoran</h2><p class="text-gray-700 mt-2 sm:pl-11">Pantau perkembangan dan ekspor laporan per kelas.</p></div>
                    <div id="icon-legend-rekap" class="mb-6"></div>
                    <div id="content-rekap" class="rounded-2xl p-5 glass-card">
                        <div class="mb-6">
                            <label for="rekap-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Tampilan Rekap</label>
                            <select id="rekap-select" class="w-full p-3 rounded-lg glass-input transition-all"></select>
                        </div>
                        <div id="rekap-content-container"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="passwordConfirmModal" class="modal fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4 hidden"><div class="modal-backdrop fixed inset-0" aria-hidden="true"></div><div class="modal-content w-full max-w-sm relative z-50 p-6 rounded-2xl glass-modal-content"><h3 class="text-lg font-bold text-gray-900">Masukkan Kata Sandi</h3><p class="text-sm text-gray-800 my-4">Untuk menghapus data, masukkan kata sandi.</p><input type="password" id="passwordInput" class="w-full mt-1 p-2 rounded-lg glass-input" placeholder="Kata Sandi"><div id="passwordError" class="text-red-500 text-xs mt-2 hidden">Kata sandi salah.</div><div class="flex justify-center gap-4 mt-6"><button id="cancelPasswordBtn" class="px-6 py-2 rounded-lg bg-gray-200/80 text-gray-800 font-semibold hover:bg-gray-300/90 transition-colors">Batal</button><button id="confirmPasswordBtn" class="px-6 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700">Konfirmasi</button></div></div></div>
    <div id="toast" class="fixed bottom-20 sm:bottom-8 left-1/2 z-50 flex items-center gap-3 bg-gray-900/80 text-white text-sm font-semibold py-3 px-5 rounded-lg border border-gray-700/50 backdrop-blur-sm"><svg id="toast-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg><span id="toast-message"></span></div>

    <template id="history-row-template"><tr class="hover:bg-gray-100/50 transition-colors"><td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center"><div class="font-medium text-gray-900 data-nama"></div><span class="data-program-icon"></span><span class="data-kelas-icon"></span></div></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600"><div><span class="data-jenis"></span> <span class="data-juz-text"></span></div><div class="text-xs text-gray-500 data-unit"></div></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell data-tanggal"></td><td class="px-6 py-4 whitespace-nowrap text-center"><button class="delete-btn text-gray-500 hover:text-red-500 p-1 rounded-full transition-colors" aria-label="Hapus setoran"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td></tr></template>
    <template id="rekap-content-template"><div class="rekap-tab-content"><div class="bg-white/20 p-4 rounded-t-xl border-b border-white/30 flex flex-col sm:flex-row justify-between items-start sm:items-center"><div><h3 class="font-bold text-amber-700 text-lg data-title"></h3><p class="text-sm text-gray-600 data-musyrif"></p><p class="text-xs text-gray-500 data-timestamp"></p></div><button class="export-pdf-btn bg-green-600 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors mt-3 sm:mt-0">Ekspor PDF</button></div><div class="overflow-x-auto bg-white/10 p-2 rounded-b-xl"><table class="min-w-full divide-y divide-gray-200/80"><thead class="bg-gray-100/80"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="sortable px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50" data-sort="nama">Nama <span class="sort-icon"></span></th><th class="sortable px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50" data-sort="nilai">Nilai <span class="sort-icon"></span></th><th class="sortable px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50" data-sort="ziyadah">Ziyadah <span class="sort-icon"></span></th><th class="sortable px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50" data-sort="keterangan">Keterangan <span class="sort-icon"></span></th></tr></thead><tbody class="divide-y divide-gray-200/80 data-table-body"></tbody></table></div></div></template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const Config = {
            scriptURL: 'https://script.google.com/macros/s/AKfycbyl2FCcGUtolkJIDsoiTYFKeKp8IQwHT0V3z8n1pOHH9CLiyvYZTBaimrojILJM_A-HLg/exec',
            deletePassword: 'sparman68',
            musyrifSortOrder: ['Andi Aqillah Fadia Haswat', 'Abdullah'],
            deadlineJuz30Score: new Date('2026-01-03T23:59:59'),
            deadlineTahfizhTuntas: new Date('2025-09-30T23:59:59'),
            santriList: [
                { id: 'santri1', nama: 'Adelio Daffa Syahrizha', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri2', nama: 'Ahmad Ahsanur Rizqi', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri3', nama: 'Arkana El Sabilly', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri4', nama: "Athaya Auza'I Mubarak", kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri5', nama: 'Dama Arza Evannova', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri6', nama: 'Danar Nizam Daniswara', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri7', nama: 'Devgan Jadid Sahlvatico', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri8', nama: 'Fariq Imtiyas Aufaa Kamil', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri9', nama: 'Firaas Izzulhaq', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri10', nama: 'Gilang Omar F', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri11', nama: 'Jaladri Arif Wirasena', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri12', nama: 'Kemal Mubarak Siregar', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri13', nama: 'Khairil Nizam', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri14', nama: 'Mirza Nasyath Ahza Attaillah', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri15', nama: 'Muhammad Farros Linggar Cahyono', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri16', nama: 'Muhammad Fathir Alfalah', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri17', nama: 'Narendra Wibawa', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri18', nama: 'Naufal Zhafran Purnama', kelas: '2A', program: 'Unggulan', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri19', nama: 'Alano Faaiq Alfeno', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri20', nama: 'Arfandhika Fakhrul Islam', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri21', nama: 'Aydin Rafif', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri22', nama: 'Danish Alzahid Dinasti', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri23', nama: 'Ghani Arif Witjaksono', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri24', nama: 'Haidarrafid Satriaa Ardhani', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri25', nama: 'Iqbal Zulfikar Al Hanif', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri26', nama: 'Jangky Dausat', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri27', nama: 'Kumara Banyu Argani', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri28', nama: 'M. Dede Afkar', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri29', nama: 'Mekha Ilham Lutfianto', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri30', nama: 'Muhammad Aiman Naim', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri31', nama: 'Muhammad Karel Ashiddiq', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri32', nama: 'Naufal Fahmi Darsono', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri33', nama: 'Nazhif Fahreza Zuhairy', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri34', nama: 'Rais Abqari Ash Shidqi', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri35', nama: 'William Ramadhan Al Ghazali', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri36', nama: 'Zia El Ibrahim Aqeela Putra Wijaya', kelas: '2B', program: 'Unggulan', musyrif: 'Abdullah' }, { id: 'santri37', nama: "Ahmad Arkan Sya'Bani", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri38', nama: 'Ahmad Darwis', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri39', nama: 'Ahmad Ghozi El Muntazhor', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri40', nama: "Aldan 'Izzul Islam", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri41', nama: 'Fawwaz Elfareza Zuhri', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri42', nama: 'M. Fathan Alfarisi Harahap', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri43', nama: 'Muhammad Ahsani Taqwim', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri44', nama: 'Muhammad Ayyub Al Fatih', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri45', nama: 'Muhammad Gibran Rafassya', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri46', nama: 'Narendra Gerrardi Kusumah', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri47', nama: "Rijal Abdul A'Ziz", kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri48', nama: 'Rizki Chandra Dewantara', kelas: '2A', program: 'Tahfizh', musyrif: 'Andi Aqillah Fadia Haswat' }, { id: 'santri49', nama: 'Ahmad Miqdad', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri50', nama: 'Dzaky Salman Al Farisi', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri51', nama: 'Muhammad Alvi Mumtaz Brillian Hafizh', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri52', nama: 'Muhammad Mahdi Hafidz', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri53', nama: 'Muhammad Naufal Rasyid Arafi', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri54', nama: 'Nahsif Ilman Hazim Purwono', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri55', nama: 'Nawwaf Bahy Rafif', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri56', nama: 'Nizar Adhyatma Aryanda', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri57', nama: 'Rafa Agitananda Az Zayyan', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri58', nama: "Rafa Faeyza Fa'Iz", kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri59', nama: 'Rizqi Satria Putra Surya', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri60', nama: 'Umar Ubaidillah Tsaqif', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri61', nama: 'Wildan Faiz Mahendra', kelas: '2B', program: 'Tahfizh', musyrif: 'Abdullah' }, { id: 'santri62', nama: 'Faiq Fauzil Adhim', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri63', nama: 'Fairuz Azzam Mahfuzh', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri64', nama: 'Muhammad Arkhan Attaqi', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri65', nama: 'Muhammad Daffa Naufal Alaika', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri66', nama: 'Muzakki Fairuzzaman', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri67', nama: 'Neymar Tsaqif Hikmatyar', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri68', nama: 'Rifqi Maliki', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri69', nama: "Yasykur Slamer'Abqariy", kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri70', nama: 'Zhafran Dhiaurrahman Hakim', kelas: '2C', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri71', nama: 'Achmad Adi Darwis Elfaza', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri72', nama: 'Galang Afkar Artyanto', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri73', nama: 'Gilang Asytar Artyanto', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri74', nama: 'Muhammad Alif Al-Fatih', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri75', nama: 'Muhammad Faiz Ibnu Zakaria', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri76', nama: 'Muhammad Mahdi Hanafi', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri77', nama: 'Muhammad Muhdi Hafidz', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri78', nama: 'Rizqi Ahmad Altaf Zafar', kelas: '2D', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri79', nama: 'Dzaky Anthony Akbar', kelas: '2G', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri80', nama: 'Muwafaqi Amru Ahmad', kelas: '2G', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri81', nama: 'Abdul Ghani Irfan Rafif', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri82', nama: 'Abid Fadhil Abiyah', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri83', nama: "Ahmad Dahlan Asy'Ari", kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri84', nama: 'Athallah Azmi Ghaisan Muhammad', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri85', nama: 'Azmi Zulfadli Syafiq', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri86', nama: 'Azri Labibul Khawarizmi', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri87', nama: 'Dzar Al Ghifari', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri88', nama: 'Fatihan Al Ghifari', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri89', nama: 'Hisyam Nabil Pasha', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri90', nama: 'Ibadillah Kaiazmi Mubarak', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri91', nama: 'Kashvi Jabbar Azana', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri92', nama: 'Khawarizmi Fakhrulhaq', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri93', nama: 'Muh. Naufal Alif', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri94', nama: 'Muhammad Aghna Ilman Rafa', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri95', nama: 'Royyan Abdurrahman Ibtisam', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' }, { id: 'santri96', nama: 'Sakhi Arkan Elfariza', kelas: '2H', program: 'Tahfizh', musyrif: 'Muhammad Zhafir Setiaji' },
            ],
            surahData: { 'Al-Mulk': 2, 'Al-Qalam': 2, 'Al-Haqqah': 2, 'Al-Ma\'arij': 1.5, 'Nuh': 1.5, 'Al-Jinn': 1.5, 'Al-Muzzammil': 1.5, 'Al-Muddaththir': 1.5, 'Al-Qiyamah': 1, 'Al-Insan': 1.5, 'Al-Mursalat': 1.5, 'Al-Mujadilah': 2, 'Al-Hashr': 2.5, 'Al-Mumtahanah': 1.5, 'As-Saff': 1, 'Al-Jumu\'ah': 1, 'Al-Munafiqun': 1, 'At-Taghabun': 1.5, 'At-Talaq': 1.5, 'At-Tahrim': 1.5, 'An-Naba': 1.5, 'An-Nazi\'at': 1, 'Abasa': 1, 'At-Takwir': 0.5, 'Al-Infitar': 0.5, 'Al-Mutaffifin': 1, 'Al-Inshiqaq': 0.5, 'Al-Buruj': 0.5, 'At-Tariq': 0.5, 'Al-A\'la': 0.5, 'Al-Ghashiyah': 0.5, 'Al-Fajr': 1, 'Al-Balad': 0.5, 'Ash-Shams': 0.5, 'Al-Lail': 0.5, 'Ad-Duha': 0.25, 'Ash-Sharh': 0.25, 'At-Tin': 0.25, 'Al-\'Alaq': 0.5, 'Al-Qadr': 0.25, 'Al-Bayyinah': 0.5, 'Az-Zalzalah': 0.25, 'Al-\'Adiyat': 0.5, 'Al-Qari\'ah': 0.25, 'At-Takathur': 0.25, 'Al-\'Asr': 0.25, 'Al-Humazah': 0.25, 'Al-Fil': 0.25, 'Quraysh': 0.25, 'Al-Ma\'un': 0.25, 'Al-Kawthar': 0.25, 'Al-Kafirun': 0.25, 'An-Nasr': 0.25, 'Al-Masad': 0.25, 'Al-Ikhlas': 0.25, 'Al-Falaq': 0.25, 'An-Nas': 0.25,
                28: { list: ['Al-Mujadilah', 'Al-Hashr', 'Al-Mumtahanah', 'As-Saff', 'Al-Jumu\'ah', 'Al-Munafiqun', 'At-Taghabun', 'At-Talaq', 'At-Tahrim'] },
                29: { list: ['Al-Mulk', 'Al-Qalam', 'Al-Haqqah', 'Al-Ma\'arij', 'Nuh', 'Al-Jinn', 'Al-Muzzammil', 'Al-Muddaththir', 'Al-Qiyamah', 'Al-Insan', 'Al-Mursalat'] },
                30: { list: ['An-Naba', 'An-Nazi\'at', 'Abasa', 'At-Takwir', 'Al-Infitar', 'Al-Mutaffifin', 'Al-Inshiqaq', 'Al-Buruj', 'At-Tariq', 'Al-A\'la', 'Al-Ghashiyah', 'Al-Fajr', 'Al-Balad', 'Ash-Shams', 'Al-Lail', 'Ad-Duha', 'Ash-Sharh', 'At-Tin', 'Al-\'Alaq', 'Al-Qadr', 'Al-Bayyinah', 'Az-Zalzalah', 'Al-\'Adiyat', 'Al-Qari\'ah', 'At-Takathur', 'Al-\'Asr', 'Al-Humazah', 'Al-Fil', 'Quraysh', 'Al-Ma\'un', 'Al-Kawthar', 'Al-Kafirun', 'An-Nasr', 'Al-Masad', 'Al-Ikhlas', 'Al-Falaq', 'An-Nas'] }
            }
        };

        const State = { allSetoran: [], santriData: [], classGroups: {}, setoranIdToDelete: null, searchDebounceTimer: null };
        const Cache = {};
        
        function cacheDOMElements() {
            const ids = ['main-nav', 'main-content', 'setoranForm', 'tanggal', 'nowBtn', 'musyrif', 'namaSantri', 'santriId', 'kelas', 'program', 'jenis', 'juz', 'halaman-container', 'halaman', 'surat-container', 'surat', 'kualitas', 'setoranTableBody', 'history-row-template', 'search-riwayat', 'suggestions-container', 'filter-tanggal-mulai', 'filter-tanggal-akhir', 'filter-program', 'filter-kelas', 'stats-santri-aktif', 'stats-santri-tuntas', 'stats-santri-belum-tuntas', 'mutqin-juz29-progress-container', 'mutqin-juz30-progress-container', 'rekap-select', 'rekap-content-container', 'toast', 'toast-message', 'toast-icon', 'passwordConfirmModal', 'passwordInput', 'passwordError', 'cancelPasswordBtn', 'confirmPasswordBtn', 'icon-legend-riwayat', 'datetime-container', 'icon-legend-rekap', 'rekap-content-template', 'mutqin-unggulan-progress-container', 'tuntas-tracking-accordion', 'mutqin-unggulan-circle', 'mutqin-juz30-circle', 'mutqin-juz29-circle', 'mutqin-unggulan-details', 'mutqin-juz30-details', 'mutqin-juz29-details'];
            ids.forEach(id => { Cache[id.replace(/-(\w)/g, (_, p1) => p1.toUpperCase())] = document.getElementById(id); });
            Cache.pages = document.querySelectorAll('.page-content');
            Cache.skeletonContainers = document.querySelectorAll('.skeleton-container');
        }

        async function fetchSetoranData() { try { const r = await fetch(Config.scriptURL); if (!r.ok) throw new Error(r.status); return await r.json(); } catch (e) { console.error('Gagal memuat data:', e); showToast('Gagal memuat riwayat.', 'error'); return []; } }
        async function postData(formData) { try { const r = await fetch(Config.scriptURL, { method: 'POST', body: formData }); if (!r.ok) throw new Error(r.status); return await r.json(); } catch (e) { console.error('Gagal mengirim data:', e); showToast(`Gagal: ${e.message}`, 'error'); return { result: 'error', error: e.message }; } }
        function populateSelect(el, opts, placeholder) { el.innerHTML = ''; if (placeholder) el.add(new Option(placeholder, '')); opts.forEach(o => el.add(typeof o === 'string' ? new Option(o, o) : new Option(o.text, o.value))); }
        function normalizeName(name) { return typeof name !== 'string' ? '' : name.trim().toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' '); }
        function showToast(message, type = 'success') { Cache.toastMessage.textContent = message; const isSuccess = type === 'success'; Cache.toastIcon.innerHTML = isSuccess ? `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />` : `<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`; Cache.toastIcon.classList.toggle('text-green-400', isSuccess); Cache.toastIcon.classList.toggle('text-red-400', !isSuccess); Cache.toast.classList.add('show'); setTimeout(() => Cache.toast.classList.remove('show'), 3000); }
        function switchPage(pageId, showSkeleton = true) { if (!pageId) return; Cache.pages.forEach(p => p.classList.add('hidden')); if (showSkeleton) { const s = document.getElementById(`skeleton-${pageId}`); if (s) s.classList.remove('hidden'); } setTimeout(() => { Cache.skeletonContainers.forEach(s => s.classList.add('hidden')); const p = document.getElementById(pageId); if (p) p.classList.remove('hidden'); Cache.mainNav.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active')); const a = Cache.mainNav.querySelector(`a[data-page="${pageId}"]`); if (a) a.classList.add('active'); }, 150); }
        
        async function reloadData() {
            const dataFromServer = await fetchSetoranData();
            State.allSetoran = dataFromServer.map(item => ({ id: `row-${item.rowNumber}`, santriId: State.santriNameMap.get(normalizeName(item.namaSantri || '')) || null, createdAt: item.tanggal, ...item }));
            calculateSantriStats();
            buildClassGroups();
            renderAllUI();
        }

        function calculateSantriStats() {
            const santriStatsMap = new Map(Config.santriList.map(s => [s.id, { ...s, mutqinJuz: new Set(), nilai: 0, isTuntas: false, tuntasDate: null, ziyadahPages: 0, setoran: [] }]));
            for (const setoran of State.allSetoran) { if (santriStatsMap.has(setoran.santriId)) { santriStatsMap.get(setoran.santriId).setoran.push(setoran); } }
            
            santriStatsMap.forEach(santri => {
                if (santri.setoran.length === 0) return;
                const mutqinSetengahJuz = santri.setoran.find(s => s.jenis === 'Mutqin' && String(s.juz) === "juz30_setengah" && new Date(s.createdAt) <= Config.deadlineJuz30Score);
                const mutqinJuz30 = santri.setoran.find(s => s.jenis === 'Mutqin' && s.juz == 30 && (!s.halaman || parseInt(s.halaman) >= 20));
                const mutqinJuz29 = santri.setoran.find(s => s.jenis === 'Mutqin' && s.juz == 29 && (!s.halaman || parseInt(s.halaman) >= 20));
                if (mutqinJuz29) santri.mutqinJuz.add(29);
                if (mutqinJuz30) santri.mutqinJuz.add(30);
                if (mutqinSetengahJuz || (mutqinJuz30 && new Date(mutqinJuz30.createdAt) <= Config.deadlineJuz30Score)) { santri.nilai = 100; } else { santri.nilai = santri.setoran.filter(s => s.jenis === 'Mutqin' && new Date(s.createdAt) > Config.deadlineJuz30Score).reduce((sum, s) => sum + (parseFloat(s.halaman) || 0), 0); }
                let tuntas = false;
                if (santri.program === 'Unggulan' && santri.nilai >= 100) { tuntas = true; }
                else if (santri.program === 'Tahfizh') { const deadlineMet = (mutqinJuz29 && new Date(mutqinJuz29.createdAt) <= Config.deadlineTahfizhTuntas) && (mutqinJuz30 && new Date(mutqinJuz30.createdAt) <= Config.deadlineTahfizhTuntas); if (santri.nilai >= 100 && santri.mutqinJuz.has(29) && santri.mutqinJuz.has(30) && deadlineMet) { tuntas = true; } }
                if (tuntas) {
                    santri.isTuntas = true;
                    let completionDates = [];
                    if (mutqinSetengahJuz) completionDates.push(new Date(mutqinSetengahJuz.createdAt));
                    if (mutqinJuz30) completionDates.push(new Date(mutqinJuz30.createdAt));
                    if (mutqinJuz29) completionDates.push(new Date(mutqinJuz29.createdAt));
                    if (completionDates.length > 0) { santri.tuntasDate = new Date(Math.max(...completionDates)); }
                    if (santri.tuntasDate) {
                        let postTuntasScore = 0;
                        santri.setoran.forEach(setoran => { if (new Date(setoran.createdAt) > santri.tuntasDate) { const pageValue = (setoran.halaman ? parseFloat(setoran.halaman) : Config.surahData[setoran.surat]) || 0; if (setoran.jenis === 'Ziyadah') { santri.ziyadahPages += pageValue; } postTuntasScore += pageValue; } });
                        santri.nilai += postTuntasScore;
                    }
                }
            });
            State.santriData = Array.from(santriStatsMap.values());
        }

        function buildClassGroups() {
            const tempGroups = {};
            State.santriData.forEach(s => {
                if (!tempGroups[s.musyrif]) tempGroups[s.musyrif] = { santri: [], musyrif: s.musyrif, classes: new Set() };
                tempGroups[s.musyrif].santri.push(s);
                tempGroups[s.musyrif].classes.add(s.kelas);
            });
            State.classGroups = {};
            for (const m in tempGroups) {
                const g = tempGroups[m];
                const n = (m === 'Muhammad Zhafir Setiaji') ? '2CDGH' : [...g.classes].sort().join(', ');
                State.classGroups[n] = { santri: g.santri, musyrif: g.musyrif };
            }
            State.classGroups['Khusus Tahfizh'] = { santri: State.santriData.filter(s => s.program === 'Tahfizh'), musyrif: 'Semua Musyrif' };
            State.classGroups['Seluruh Santri'] = { santri: State.santriData, musyrif: 'Semua Musyrif' };
        }

        function renderAllUI() {
            renderBeranda();
            renderHistoryTable();
            renderRekap();
        }

        function renderBeranda() {
            const santriAktifIds = new Set(State.allSetoran.map(s => s.santriId));
            const totalSantri = Config.santriList.length;
            const tuntasCount = State.santriData.filter(s => s.isTuntas).length;
            Cache.statsSantriAktif.textContent = `${santriAktifIds.size} / ${totalSantri}`;
            Cache.statsSantriTuntas.textContent = tuntasCount;
            Cache.statsSantriBelumTuntas.textContent = totalSantri - tuntasCount;
            renderMutqinProgress();
            renderTuntasTracking();
        }

        function renderMutqinProgress() {
            const createProgress = (container, circleEl, detailsEl, santriList, color, checkFn) => {
                if (santriList.length > 0) {
                    container.classList.remove('hidden');
                    const tuntasCount = santriList.filter(checkFn).length;
                    const pct = Math.round((tuntasCount / santriList.length) * 100);
                    const radius = 45, circ = 2 * Math.PI * radius, offset = circ - (pct / 100) * circ;
                    circleEl.innerHTML = `<svg class="w-full h-full" viewBox="0 0 100 100"><circle class="text-gray-200/80" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50" /><circle class="progress-ring-circle ${color}" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50" style="stroke-dasharray:${circ};stroke-dashoffset:${circ};" /></svg><span class="absolute inset-0 flex items-center justify-center text-2xl font-bold ${color}">${pct}%</span>`;
                    setTimeout(() => { const c = circleEl.querySelector('.progress-ring-circle'); if(c) c.style.strokeDashoffset = offset; }, 100);
                    detailsEl.textContent = `${tuntasCount} dari ${santriList.length} santri tuntas.`;
                } else { container.classList.add('hidden'); }
            };
            const unggulan = State.santriData.filter(s => s.program === 'Unggulan');
            const tahfizh = State.santriData.filter(s => s.program === 'Tahfizh');
            createProgress(Cache.mutqinUnggulanProgressContainer, Cache.mutqinUnggulanCircle, Cache.mutqinUnggulanDetails, unggulan, 'text-sky-500', s => s.nilai >= 100);
            createProgress(Cache.mutqinJuz30ProgressContainer, Cache.mutqinJuz30Circle, Cache.mutqinJuz30Details, tahfizh, 'text-green-500', s => s.mutqinJuz.has(30));
            createProgress(Cache.mutqinJuz29ProgressContainer, Cache.mutqinJuz29Circle, Cache.mutqinJuz29Details, tahfizh, 'text-amber-500', s => s.mutqinJuz.has(29));
        }

        function renderTuntasTracking() {
            const container = Cache.tuntasTrackingAccordion; container.innerHTML = '';
            for (const groupName in State.classGroups) {
                if (groupName === 'Khusus Tahfizh' || groupName === 'Seluruh Santri') continue;
                const group = State.classGroups[groupName];
                const tuntasCount = group.santri.filter(s => s.isTuntas).length;
                const totalCount = group.santri.length;
                const percentage = totalCount > 0 ? ((tuntasCount / totalCount) * 100).toFixed(0) : 0;
                const tuntasList = group.santri.filter(s => s.isTuntas).map(s => `<li>${s.nama}</li>`).join('') || '<li class="list-none text-gray-500">Belum ada</li>';
                const belumTuntasList = group.santri.filter(s => !s.isTuntas).map(s => `<li>${s.nama}</li>`).join('') || '<li class="list-none text-gray-500">Semua tuntas</li>';
                const item = document.createElement('div');
                item.className = 'glass-card rounded-lg overflow-hidden';
                item.innerHTML = `<h2 class="accordion-header"><button type="button" class="accordion-button flex items-center justify-between w-full p-4 font-semibold text-left text-gray-800 transition-colors hover:bg-white/20"><span class="font-bold text-gray-900">Kelas ${groupName}</span><div class="flex items-center gap-2 sm:gap-4"><div class="hidden sm:flex items-center gap-2"><div class="w-24 bg-gray-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${percentage}%"></div></div><span class="text-xs font-semibold text-gray-700">${percentage}%</span></div><span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">Tuntas: ${tuntasCount}</span><span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-red-100 text-red-800">Belum: ${totalCount - tuntasCount}</span><svg class="accordion-chevron w-4 h-4 shrink-0 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div></button></h2><div class="accordion-panel border-t border-gray-200/50 bg-white/10"><div class="p-4 pb-6 grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs"><div><h5 class="font-semibold text-green-700 mb-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>Sudah Tuntas (${tuntasCount})</h5><ul class="space-y-1 list-disc list-inside text-gray-700">${tuntasList}</ul></div><div><h5 class="font-semibold text-red-700 mb-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>Belum Tuntas (${totalCount-tuntasCount})</h5><ul class="space-y-1 list-disc list-inside text-gray-700">${belumTuntasList}</ul></div></div></div>`;
                container.appendChild(item);
            }
        }

        function renderHistoryTable() {
            const searchTerm = Cache.searchRiwayat.value.toLowerCase();
            const programFilter = Cache.filterProgram.value;
            const classFilter = Cache.filterKelas.value;
            const startDate = Cache.filterTanggalMulai.value ? new Date(Cache.filterTanggalMulai.value) : null;
            const endDate = Cache.filterTanggalAkhir.value ? new Date(Cache.filterTanggalAkhir.value) : null;
            if (startDate) startDate.setHours(0,0,0,0);
            if (endDate) endDate.setHours(23,59,59,999);
            const filtered = State.allSetoran
                .filter(s => {
                    const santri = State.santriData.find(st => st.id === s.santriId);
                    const classMatch = (classFilter === 'Semua') || (santri && (classFilter === '2CDGH' ? ['2C', '2D', '2G', '2H'].includes(santri.kelas) : santri.kelas === classFilter));
                    return s.namaSantri.toLowerCase().includes(searchTerm) && (programFilter === 'Semua' || (santri && santri.program === programFilter)) && classMatch && (!startDate || new Date(s.createdAt) >= startDate) && (!endDate || new Date(s.createdAt) <= endDate);
                })
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 50);
            
            const tableBody = Cache.setoranTableBody;
            tableBody.innerHTML = '';
            if (filtered.length === 0) return tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500">Tidak ada data.</td></tr>`;
            
            const fragment = document.createDocumentFragment();
            const template = Cache.historyRowTemplate;
            filtered.forEach(setoran => {
                const santri = State.santriData.find(s => s.id === setoran.santriId);
                const clone = template.content.cloneNode(true);
                clone.querySelector('.data-nama').textContent = setoran.namaSantri;
                clone.querySelector('.data-jenis').textContent = setoran.jenis;
                clone.querySelector('.data-juz-text').textContent = String(setoran.juz) === "juz30_setengah" ? "Setengah Juz 30" : `Juz ${setoran.juz}`;
                clone.querySelector('.data-unit').textContent = setoran.halaman ? `${setoran.halaman} hlm` : setoran.surat;
                clone.querySelector('.data-tanggal').textContent = new Date(setoran.createdAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                clone.querySelector('.delete-btn').dataset.id = setoran.id;
                if (santri) {
                    const getProgramIcon = p => p === 'Unggulan' ? `<span title="Unggulan" class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full bg-gray-200 text-gray-800 text-xs font-bold">U</span>` : `<span title="Tahfizh" class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full bg-purple-200 text-purple-800 text-xs font-bold">T</span>`;
                    const getClassIcon = c => { let cl = 'bg-gray-200 text-gray-800'; const i = c.charAt(1); if (['A'].includes(i)) cl = 'bg-red-100 text-red-800'; if (['B'].includes(i)) cl = 'bg-yellow-100 text-yellow-800'; if (['C', 'D'].includes(i)) cl = 'bg-green-100 text-green-800'; if (['G', 'H'].includes(i)) cl = 'bg-blue-100 text-blue-800'; return `<span title="Kelas ${c}" class="ml-1 inline-flex items-center justify-center h-5 w-5 rounded-full ${cl} text-xs font-bold">${c}</span>`; };
                    clone.querySelector('.data-program-icon').innerHTML = getProgramIcon(santri.program);
                    clone.querySelector('.data-kelas-icon').innerHTML = getClassIcon(santri.kelas);
                }
                fragment.appendChild(clone);
            });
            tableBody.appendChild(fragment);
        }

        function renderRekap() {
            const groupOrder = ['Seluruh Santri', 'Khusus Tahfizh', ...Object.keys(State.classGroups).filter(g => g !== 'Seluruh Santri' && g !== 'Khusus Tahfizh').sort()];
            const selectEl = Cache.rekapSelect;
            const contentContainer = Cache.rekapContentContainer;
            selectEl.innerHTML = '';
            contentContainer.innerHTML = '';
            if (groupOrder.length === 0) return;

            groupOrder.forEach((groupName, index) => {
                const tabId = groupName.replace(/, /g, '').replace(/ /g, '-');
                selectEl.add(new Option(groupName, tabId));
                
                const content = Cache.rekapContentTemplate.content.cloneNode(true).querySelector('.rekap-tab-content');
                content.id = `rekap-tab-${tabId}`;
                const group = State.classGroups[groupName];
                content.querySelector('.data-title').textContent = `Rekap Capaian - ${groupName}`;
                content.querySelector('.data-musyrif').textContent = `Musyrif: ${group.musyrif}`;
                content.querySelector('.data-timestamp').textContent = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                content.querySelector('.export-pdf-btn').dataset.classGroup = groupName;
                if (index !== 0) { content.classList.add('hidden'); }
                contentContainer.appendChild(content);
                renderSingleRekapTable(groupName, true);
            });
        }

        function renderSingleRekapTable(groupName, isInitial = false) {
            const group = State.classGroups[groupName]; if (!group) return;
            const contentDiv = document.getElementById(`rekap-tab-${groupName.replace(/, /g, '').replace(/ /g, '-')}`); if (!contentDiv) return;
            if (isInitial && !group.sortState) group.sortState = { column: 'nama', dir: 'asc' };
            const { column, dir } = group.sortState;
            group.santri.sort((a, b) => { let valA, valB; switch (column) { case 'nama': valA = a.nama; valB = b.nama; break; case 'nilai': valA = a.nilai; valB = b.nilai; break; case 'ziyadah': valA = a.program === 'Tahfizh' ? a.ziyadahPages : -1; valB = b.program === 'Tahfizh' ? b.ziyadahPages : -1; break; case 'keterangan': valA = a.isTuntas; valB = b.isTuntas; break; default: return 0; } if (valA < valB) return dir === 'asc' ? -1 : 1; if (valA > valB) return dir === 'asc' ? 1 : -1; return 0; });
            contentDiv.querySelectorAll('th.sortable').forEach(th => { 
                th.removeAttribute('data-sort-dir'); 
                const iconSpan = th.querySelector('.sort-icon');
                iconSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 12L3 8m4 8l4-8" /></svg>`;
                if (th.dataset.sort === column) { 
                    th.setAttribute('data-sort-dir', dir);
                    if (dir === 'asc') {
                        iconSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>`;
                    } else {
                        iconSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>`;
                    }
                }
            });
            const tableBody = contentDiv.querySelector('.data-table-body');
            tableBody.innerHTML = group.santri.map((santri, idx) => `<tr class="hover:bg-gray-50/50"><td class="px-4 py-2 text-gray-800">${idx + 1}</td><td class="px-4 py-2 text-sm text-gray-800">${santri.nama}</td><td class="px-4 py-2 font-medium text-gray-800 text-center">${santri.nilai}</td><td class="px-4 py-2 font-medium text-gray-800 text-center">${santri.program === 'Tahfizh' ? (santri.ziyadahPages || 0).toFixed(1) : '-'}</td><td class="px-4 py-2 text-center"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${santri.isTuntas ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${santri.isTuntas ? 'Tuntas' : 'Belum Tuntas'}</span></td></tr>`).join('');
        }
        
        function exportRecapToPDF(classGroup) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                const group = State.classGroups[classGroup];
                if (!group) return showToast('Grup kelas tidak ditemukan.', 'error');
                doc.autoTable({
                    head: [['No.', 'Nama Santri', 'Nilai', 'Ziyadah (hlm)', 'Keterangan']],
                    body: group.santri.sort((a, b) => a.nama.localeCompare(b.nama)).map((santri, index) => [ index + 1, santri.nama, santri.nilai, santri.program === 'Tahfizh' ? (santri.ziyadahPages || 0).toFixed(1) : '-', santri.isTuntas ? 'Tuntas' : 'Belum Tuntas' ]),
                    theme: 'grid', headStyles: { fillColor: [217, 119, 6] }, styles: { font: 'Inter', cellPadding: 6, valign: 'middle' },
                    columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 40, halign: 'center' }, 3: { cellWidth: 70, halign: 'center' }, 4: { cellWidth: 80, halign: 'center' } },
                    didParseCell: (data) => { if (data.column.index === 1) data.cell.styles.fontSize = 8; },
                    didDrawPage: (data) => {
                        doc.setFontSize(20); doc.setTextColor(180, 83, 9); doc.setFont('helvetica', 'bold');
                        doc.text('Laporan Capaian Tahfizh', data.settings.margin.left, 40);
                        doc.setFontSize(12); doc.setTextColor(40); doc.setFont('helvetica', 'normal');
                        doc.text(`Kelompok: ${classGroup} | Musyrif: ${group.musyrif}`, data.settings.margin.left, 58);
                        doc.setFontSize(8); doc.setTextColor(150);
                        doc.text(`Halaman ${data.pageNumber} dari ${doc.internal.getNumberOfPages()}`, data.settings.margin.left, doc.internal.pageSize.height - 20);
                        doc.text(`Dibuat pada: ${new Date().toLocaleString('id-ID')}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 20, { align: 'right' });
                    },
                    margin: { top: 70, bottom: 40 }
                });
                doc.save(`rekap_setoran_${classGroup.replace(/, /g, '_').replace(/ /g, '-')}_${Date.now()}.pdf`);
            } catch (error) { console.error("PDF Export Error:", error); showToast('Gagal mengekspor PDF.', 'error'); }
        }

        function setupEventListeners() {
            Cache.setoranForm.addEventListener('submit', async (e) => { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.innerHTML = 'Menyimpan...'; const formData = new FormData(e.target); formData.set('namaSantri', Cache.namaSantri.options[Cache.namaSantri.selectedIndex].text); const data = await postData(formData); if (data.result === 'success') { showToast('Setoran berhasil disimpan!'); e.target.reset(); await reloadData(); } btn.disabled = false; btn.innerHTML = 'Simpan Setoran'; });
            Cache.nowBtn.addEventListener('click', () => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); Cache.tanggal.value = now.toISOString().slice(0, 16); });
            Cache.mainNav.addEventListener('click', e => { const link = e.target.closest('.nav-link'); if (link) { e.preventDefault(); switchPage(link.dataset.page); } });
            Cache.mainContent.addEventListener('click', e => {
                const btn = e.target.closest('.export-pdf-btn, .delete-btn, [data-target-page], .accordion-button, .sortable');
                if (!btn) return;
                if (btn.matches('.export-pdf-btn')) { exportRecapToPDF(btn.dataset.classGroup); }
                else if (btn.matches('.delete-btn')) { State.setoranIdToDelete = btn.dataset.id; Cache.passwordConfirmModal.classList.remove('hidden'); }
                else if (btn.matches('[data-target-page]')) { switchPage(btn.dataset.targetPage); }
                else if (btn.matches('.accordion-button')) { const p = btn.closest('h2').nextElementSibling; p.style.maxHeight = p.style.maxHeight ? null : `${p.scrollHeight}px`; btn.querySelector('svg').classList.toggle('rotate-180'); }
                else if (btn.matches('.sortable')) { const col = btn.dataset.sort; const groupName = Object.keys(State.classGroups).find(n => n.replace(/, /g, '').replace(/ /g, '-') === btn.closest('.rekap-tab-content').id.replace('rekap-tab-', '')); if(groupName) { const g = State.classGroups[groupName]; g.sortState = { column: col, dir: g.sortState?.column === col && g.sortState?.dir === 'asc' ? 'desc' : 'asc' }; renderSingleRekapTable(groupName); }}
            });
            Cache.rekapSelect.addEventListener('change', (e) => {
                const selectedId = e.target.value;
                Cache.rekapContentContainer.querySelectorAll('.rekap-tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`rekap-tab-${selectedId}`).classList.remove('hidden');
            });
            Cache.musyrif.addEventListener('change', () => { const v = Cache.musyrif.value; const opts = v ? State.santriData.filter(s => s.musyrif === v).sort((a, b) => a.nama.localeCompare(b.nama)).map(s => ({ text: s.nama, value: s.id })) : []; populateSelect(Cache.namaSantri, opts, 'Pilih Santri'); Cache.namaSantri.disabled = !v; Cache.namaSantri.dispatchEvent(new Event('change')); });
            Cache.namaSantri.addEventListener('change', () => { const s = State.santriData.find(s => s.id === Cache.namaSantri.value); Cache.kelas.value = s?.kelas || ''; Cache.program.value = s?.program || ''; Cache.santriId.value = s?.id || ''; const opts = s ? (s.program === "Unggulan" || (s.program === "Tahfizh" && s.isTuntas) ? ["Ziyadah", "Murajaah", "Mutqin"] : ["Murajaah", "Mutqin"]) : []; populateSelect(Cache.jenis, opts, 'Pilih Jenis'); Cache.jenis.disabled = !s; Cache.jenis.dispatchEvent(new Event('change')); });
            Cache.jenis.addEventListener('change', () => { const j = Cache.jenis.value, s = State.santriData.find(s => s.id === Cache.namaSantri.value); let opts = []; if(j && s) { if(j === 'Mutqin') { if(!s.nilai || s.nilai < 100) opts.push({text: "Setengah Juz 30", value: "juz30_setengah"}); for(let i=1;i<=30;i++) if(!s.mutqinJuz.has(i)) opts.push({text:`Juz ${i}`, value:i}); } else { for(let i=1;i<=30;i++) opts.push({text:`Juz ${i}`, value:i}); } } populateSelect(Cache.juz, opts, 'Pilih Juz'); Cache.juz.disabled = !j; Cache.juz.dispatchEvent(new Event('change')); });
            Cache.juz.addEventListener('change', () => { const j = Cache.jenis.value, juz = Cache.juz.value; ['halaman', 'surat'].forEach(k => { Cache[`${k}Container`].classList.add('hidden'); Cache[k].disabled = true; Cache[k].required = false; }); if(!j || !juz || juz === 'juz30_setengah') return; const juzNum = parseInt(juz, 10); if((j==='Ziyadah'||j==='Murajaah') && [28,29,30].includes(juzNum)) { Cache.suratContainer.classList.remove('hidden'); Cache.surat.disabled = false; Cache.surat.required = true; populateSelect(Cache.surat, Config.surahData[juzNum].list, 'Pilih Surat'); } else { Cache.halamanContainer.classList.remove('hidden'); Cache.halaman.disabled = false; Cache.halaman.required = j !== 'Mutqin'; if(j === 'Mutqin') Cache.halaman.placeholder = 'Kosongkan u/ 1 Juz'; } });
            [Cache.filterTanggalMulai, Cache.filterTanggalAkhir, Cache.filterProgram, Cache.filterKelas].forEach(el => el.addEventListener('input', renderHistoryTable));
            Cache.searchRiwayat.addEventListener('input', e => { clearTimeout(State.searchDebounceTimer); State.searchDebounceTimer = setTimeout(() => { renderHistoryTable(); const q = e.target.value; if(q.length<2) return Cache.suggestionsContainer.classList.add('hidden'); const s = State.santriData.filter(s => s.nama.toLowerCase().includes(q.toLowerCase())).slice(0,5); if(s.length>0) { Cache.suggestionsContainer.innerHTML = s.map(s => `<div class="suggestion-item p-2 hover:bg-gray-100 cursor-pointer">${s.nama}</div>`).join(''); Cache.suggestionsContainer.classList.remove('hidden'); } else { Cache.suggestionsContainer.classList.add('hidden'); } }, 300); });
            Cache.suggestionsContainer.addEventListener('click', e => { if(e.target.matches('.suggestion-item')) { Cache.searchRiwayat.value = e.target.textContent; Cache.suggestionsContainer.classList.add('hidden'); renderHistoryTable(); } });
            Cache.cancelPasswordBtn.addEventListener('click', () => Cache.passwordConfirmModal.classList.add('hidden'));
            Cache.confirmPasswordBtn.addEventListener('click', async () => { if(Cache.passwordInput.value !== Config.deletePassword) return Cache.passwordError.classList.remove('hidden'); Cache.passwordError.classList.add('hidden'); const s = State.allSetoran.find(s => s.id === State.setoranIdToDelete); if(!s) return; const fd = new FormData(); fd.append('action','delete'); fd.append('rowNumber',s.rowNumber); fd.append('password',Cache.passwordInput.value); Cache.passwordConfirmModal.classList.add('hidden'); const d = await postData(fd); if(d.result === 'success') { showToast('Data berhasil dihapus.'); await reloadData(); } else { showToast(`Gagal hapus: ${d.error || 'Error'}`,'error'); } });
        }

        function updateDateTime() {
            const n = new Date();
            Cache.datetimeContainer.innerHTML = `<div class="text-center space-y-1"><p class="text-2xl font-bold text-gray-800">${new Intl.DateTimeFormat('id-ID',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).format(n).replace(/\./g,':')}</p><p class="text-xs font-semibold text-gray-600">${new Intl.DateTimeFormat('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(n)}</p><p class="text-xs font-semibold text-gray-500">${new Intl.DateTimeFormat('id-ID-u-ca-islamic',{day:'numeric',month:'long',year:'numeric'}).format(n)}</p></div>`;
        }

        async function main() {
            cacheDOMElements();
            setupEventListeners();
            switchPage('page-beranda');
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); Cache.tanggal.value = now.toISOString().slice(0, 16);
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            State.santriNameMap = new Map(Config.santriList.map(s => [normalizeName(s.nama), s.id]));
            const musyrifList = [...new Set(Config.santriList.map(s => s.musyrif))].sort((a,b) => { const o=Config.musyrifSortOrder, iA=o.indexOf(a), iB=o.indexOf(b); if(iA>-1&&iB>-1)return iA-iB; if(iA>-1)return -1; if(iB>-1)return 1; return a.localeCompare(b); });
            populateSelect(Cache.musyrif, musyrifList, 'Pilih Musyrif');

            await reloadData();
            switchPage('page-beranda', false);
        }

        main();
    });
</script>
</body>
</html>
